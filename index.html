<!-- TEST PATCH -->
<!DOCTYPE html>
<html lang="ar" dir="rtl" class="rtl-mode">
<head>
  <meta charset="UTF-8">
  <title>Pharma Financial Suite</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" href="logo.png">
  <style>
    :root{
      --bg: #f3f4f6;
      --bg-soft:#f9fafb;
      --card:#ffffffdd;
      --accent:#0ea5e9;
      --accent-soft:#e0f2fe;
      --accent-strong:#0369a1;
      --border:#e5e7eb;
      --text:#0f172a;
      --muted:#6b7280;
      --danger:#b91c1c;
      --radius-lg:18px;
      --radius-md:12px;
      --shadow-soft:0 18px 40px rgba(15,23,42,0.18);
    }
    body.theme-teal{
      --accent:#0fbf9f;
      --accent-soft:#d2fff6;
      --accent-strong:#0a8f79;
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    body{
      background:radial-gradient(circle at top,#e0f2fe,#f9fafb 40%,#e5e7eb 100%);
      min-height:100vh;
      color:var(--text);
    }
    button,input,select{font:inherit}
    .hidden{display:none !important;}

    /* Layout */
    .screen{display:none;min-height:100vh;}
    .screen.active{display:flex;}

    /* LOGIN */
    #screen-login{
      align-items:center;
      justify-content:center;
      padding:24px;
    }
    .login-shell{
      width:100%;
      max-width:880px;
      display:flex;
      gap:24px;
      backdrop-filter:blur(22px);
      background:linear-gradient(135deg,rgba(255,255,255,0.88),rgba(248,250,252,0.9));
      border-radius:32px;
      box-shadow:var(--shadow-soft);
      border:1px solid rgba(148,163,184,0.35);
      padding:26px 28px;
    }
    @media (max-width:720px){
      .login-shell{flex-direction:column;}
    }
    .login-brand{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:14px;
      border-inline-start:1px solid rgba(148,163,184,0.32);
      padding-inline-start:18px;
    }
    [dir="rtl"] .login-brand{
      border-inline-start:none;
      border-inline-end:1px solid rgba(148,163,184,0.32);
      padding-inline-start:0;
      padding-inline-end:18px;
    }
    .login-form-side{flex:0 0 280px;}
    .login-logo{
      width:110px;
      height:110px;
      border-radius:30px;
      object-fit:cover;
      margin-bottom:14px;
      box-shadow:0 14px 40px rgba(15,23,42,0.30);
      background:transparent;
    }

    .brand-logo-big{
      width:120px;
      height:120px;
      border-radius:36px;
      background:radial-gradient(circle at 20% 20%,#e0f2fe,#eff6ff 40%,#dbeafe 100%);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 22px 48px rgba(15,23,42,0.35);
      position:relative;
      overflow:hidden;
    }
    .brand-logo-mark{
      position:relative;
      width:78px;
      height:78px;
      border-radius:26px;
      background:linear-gradient(145deg,#0ea5e9,#22c55e);
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 16px 32px rgba(15,23,42,0.55);
    }
    .brand-logo-mark::before{
      content:'';
      position:absolute;
      width:50px;
      height:20px;
      border-radius:999px;
      background:linear-gradient(90deg,#ffffff,#e5e7eb);
      box-shadow:0 8px 16px rgba(15,23,42,0.36);
    }
    .brand-logo-mark::after{
      content:'';
      position:absolute;
      width:18px;
      height:18px;
      border-radius:999px;
      border:2px solid rgba(8,47,73,0.4);
      box-shadow:0 0 0 3px rgba(56,189,248,0.45);
      right:9px;
      top:9px;
      background:rgba(15,23,42,0.08);
    }
    .logo-wordmark{
      margin-top:10px;
      font-weight:800;
      font-size:20px;
      letter-spacing:0.12em;
      text-transform:uppercase;
      color:#0f172a;
    }
    .logo-sub{
      font-size:11px;
      color:#6b7280;
      text-transform:uppercase;
      letter-spacing:0.17em;
    }
    .login-heading{
      margin-top:10px;
      font-size:18px;
      font-weight:600;
      color:#0f172a;
    }
    .login-desc{
      font-size:13px;
      color:#6b7280;
      max-width:320px;
    }
    .login-meta{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:12px;
    }
    .badge-soft{
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.6);
      font-size:11px;
      color:#0f172a;
      background:linear-gradient(135deg,#ffffff,#f1f5f9);
    }
    .login-form-card{
      background:rgba(15,23,42,0.03);
      border-radius:20px;
      padding:18px 18px 20px;
      border:1px solid rgba(148,163,184,0.35);
    }
    .login-form-card h2{
      font-size:16px;
      margin-bottom:4px;
    }
    .login-form-card p{
      font-size:12px;
      color:#6b7280;
      margin-bottom:14px;
    }
    .field{
      margin-bottom:10px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .field label{
      font-size:11px;
      color:#6b7280;
    }
    .field input,.field select{
      border-radius:10px;
      border:1px solid var(--border);
      padding:7px 9px;
      background:#f9fafb;
      outline:none;
    }
    .field input:focus,.field select:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(14,165,233,0.3);
      background:#ffffff;
    }
    .btn{
      border:none;
      border-radius:999px;
      padding:7px 14px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      font-size:13px;
      white-space:nowrap;
    }
    .btn-primary{
      background:linear-gradient(135deg,#0ea5e9,#22c55e);
      color:#f9fafb;
      box-shadow:0 10px 26px rgba(15,23,42,0.35);
    }
    .btn-outline{
      background:transparent;
      border:1px solid rgba(148,163,184,0.75);
      color:#0f172a;
    }
    .quick-filter.active{
      background:var(--accent-soft);
      border-color:var(--accent);
      color:var(--accent-strong);
    }
    .btn:disabled{
      opacity:0.6;
      cursor:default;
      box-shadow:none;
    }
    .row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
    }

    .subtabs{
      display:inline-flex;
      gap:8px;
      padding:3px;
      border-radius:999px;
      background:rgba(15,23,42,0.05);
      margin-bottom:12px;
    }
    .subtab-btn{
      border:none;
      border-radius:999px;
      padding:6px 16px;
      font-size:13px;
      background:transparent;
      cursor:pointer;
      color:#0f172a;
    }
    .subtab-btn.active{
      background:linear-gradient(135deg,#0d9488,#22c1c3);
      color:#ffffff;
      box-shadow:0 4px 12px rgba(15,23,42,0.25);
    }
    .subtab-panel{display:none;}
    .subtab-panel.active{display:block;}

    .kpi-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:12px;
      margin-bottom:12px;
    }
    .kpi-card{
      border-radius:16px;
      padding:14px 16px;
      background:rgba(255,255,255,0.95);
      box-shadow:0 16px 32px rgba(15,23,42,0.06);
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .kpi-label{
      font-size:13px;
      opacity:0.7;
    }
    .kpi-value{
      font-size:20px;
      font-weight:700;
    }

    .profit-bars{
      margin-top:10px;
      display:flex;
      gap:4px;
      align-items:flex-end;
      height:80px;
    }
    .profit-bar{
      flex:1;
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-end;
      font-size:10px;
    }
    .profit-bar-inner{
      width:70%;
      border-radius:6px 6px 0 0;
    }
    .profit-bar-inner.sales{background:#0ea5e9;}
    .profit-bar-inner.purchases{background:#f97316;}
    .profit-bar-inner.expenses{background:#ef4444;}
    .profit-bar-inner.profit{background:#22c55e;}
    .profit-filter-bar{
      display:flex;
      gap:8px;
      align-items:center;
      margin-bottom:10px;
      padding:8px;
      background:var(--bg-soft);
      border-radius:var(--radius-md);
    }
    .profit-filter-btn{
      border:none;
      border-radius:999px;
      padding:4px 12px;
      font-size:13px;
      cursor:pointer;
      background:rgba(15,23,42,0.06);
      color:var(--text);
    }
    .profit-filter-btn.active{
      background:linear-gradient(135deg,#0d9488,#22c1c3);
      color:#fff;
    }
    #profit-period-select{
      min-width:140px;
    }

    /* APP */
    #screen-app{
      flex-direction:column;
      min-height:100vh;
    }
    #app-shell{
      display:none;
      flex:1;
      min-height:0;
    }
    #app-shell.show{
      display:flex;
    }
    .app-shell{
      display:flex;
      flex:1;
      min-height:0;
    }
    .sidebar{
      width:230px;
      background:linear-gradient(180deg,#020617,#020617 70%,#020617);
      color:#e5e7eb;
      padding:14px 12px 16px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    .app-main{
      flex:1;
      display:flex;
      flex-direction:column;
      min-height:0;
      background:var(--bg);
    }
    /* === RTL Fix for Dashboard + Sidebar === */
    [dir="rtl"] body,
    [dir="rtl"] .app-shell,
    [dir="rtl"] .dashboard-header,
    [dir="rtl"] .sidebar{
      direction: rtl !important;
      text-align: right !important;
    }
    [dir="rtl"] .app-shell{flex-direction:row-reverse}
    [dir="rtl"] .sidebar{left:auto !important; right:0 !important}
    .mini-logo{
      width:30px;
      height:30px;
      border-radius:12px;
      background:linear-gradient(145deg,#0ea5e9,#22c55e);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#f9fafb;
      font-size:14px;
      font-weight:800;
      box-shadow:0 10px 24px rgba(15,23,42,0.6);
    }
    .sidebar-top{
      display:flex;
      align-items:center;
      gap:10px;
      padding:4px 4px 10px;
      border-bottom:1px solid rgba(30,64,175,0.6);
      margin-bottom:6px;
    }
    .sidebar-title-main{
      font-size:13px;
      font-weight:600;
    }
    .sidebar-title-sub{
      font-size:10px;
      color:#94a3b8;
    }
    .sidebar-section-title{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.12em;
      color:#6b7280;
      margin:4px 2px 4px;
    }
    .menu-section{
      margin-top:6px;
    }
    .menu-group-btn{
      width:100%;
      justify-content:space-between;
      padding:7px 10px;
      border-radius:10px;
      border:none;
      background:transparent;
      color:#e5e7eb;
      font-size:13px;
      cursor:pointer;
    }
    .menu-group-btn span.icon{
      font-size:14px;
    }
    .menu-section-items{
      margin-top:4px;
      padding-inline-start:12px;
      display:none;
      flex-direction:column;
      gap:3px;
    }
    .menu-section-items.open{display:flex;}

    .action-bar{
      height:52px;
      padding:8px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      border-bottom:1px solid var(--border);
      background:rgba(248,250,252,0.88);
      backdrop-filter:blur(10px);
    }
    .branch-indicator{
      display:flex;
      align-items:center;
      gap:8px;
      font-size:12px;
    }
    #app-logo{
      width:34px;
      height:34px;
      border-radius:12px;
      object-fit:cover;
      margin-inline-end:8px;
      box-shadow:0 6px 18px rgba(15,23,42,0.35);
      background:transparent;
    }
    .btn-print-page{
      background:#0a6ed1;
      color:#fff;
      border:none;
      padding:6px 12px;
      border-radius:6px;
      cursor:pointer;
      font-size:14px;
      margin-inline-start:8px;
      box-shadow:0 4px 12px rgba(0,0,0,0.15);
      display:inline-flex;
      align-items:center;
      gap:4px;
    }
    .btn-print-page:hover{
      background:#0753a5;
    }
    .btn-print-page span.icon{
      font-size:15px;
    }
    .branch-pill{
      padding:3px 10px;
      border-radius:999px;
      background:#e0f2fe;
      color:#0f172a;
      font-size:11px;
    }
    .status-bar{
      height:42px;
      border-top:1px solid var(--border);
      background:#f9fafb;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 14px;
      font-size:11px;
      color:#4b5563;
    }
    .status-group{display:flex;gap:12px;align-items:center;}
    .status-pill{
      padding:3px 9px;
      border-radius:999px;
      background:#f1f5f9;
      border:1px solid #e5e7eb;
      display:flex;
      gap:4px;
      align-items:center;
    }
    .alerts-btn{
      position:relative;
      background:transparent;
      border:none;
      font-size:18px;
      cursor:pointer;
      padding:4px 8px;
      border-radius:6px;
      transition:background 0.2s;
    }
    .alerts-btn:hover{background:rgba(0,0,0,0.05);}
    .alerts-badge{
      position:absolute;
      top:-2px;
      right:-2px;
      background:var(--danger);
      color:white;
      font-size:9px;
      font-weight:bold;
      min-width:16px;
      height:16px;
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:0 4px;
    }
    .alerts-badge:empty{display:none;}
    #alerts-panel{
      position:fixed;
      bottom:42px;
      right:0;
      width:320px;
      max-height:400px;
      background:var(--card);
      border:1px solid var(--border);
      border-bottom:none;
      border-radius:12px 12px 0 0;
      box-shadow:0 -4px 20px rgba(0,0,0,0.15);
      display:none;
      flex-direction:column;
      z-index:1000;
      overflow:hidden;
    }
    #alerts-panel.open{display:flex;}
    .alerts-header{
      padding:12px 14px;
      border-bottom:1px solid var(--border);
      font-weight:600;
      font-size:13px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .alerts-list{
      overflow-y:auto;
      flex:1;
    }
    .alert-item{
      padding:10px 14px;
      border-bottom:1px solid var(--border);
      font-size:12px;
    }
    .alert-item:last-child{border-bottom:none;}
    .alert-item.warning{border-right:3px solid #f59e0b;}
    .alert-item.danger{border-right:3px solid var(--danger);}
    .alert-category{
      font-size:10px;
      color:var(--muted);
      margin-bottom:4px;
    }
    .alert-message{
      color:var(--text);
      line-height:1.4;
    }

    .workspace{
      flex:1;
      padding:14px 18px 10px;
      overflow:auto;
      min-height:0;
    }
    .page{display:none;}
    .page.active{display:block;}
    .page-inner{
      max-width:1100px;
      margin:0 auto;
    }
    .page-header{
      display:flex;
      justify-content:space-between;
      gap:8px;
      margin-bottom:8px;
    }
    .page-header h2{font-size:18px;}
    .page-header p{font-size:12px;color:#6b7280;}
    [dir="rtl"] #page-dashboard .page-header{flex-direction:row-reverse;}
    [dir="rtl"] .page-header, [dir="rtl"] .dashboard-header{ text-align:right; justify-content:flex-end; }
    [dir="rtl"] .kpi-card{ text-align:right; }
    .form-card{
      border-radius:16px;
      padding:20px 24px;
      background:rgba(255,255,255,0.9);
      box-shadow:0 18px 40px rgba(15,23,42,0.08);
      margin-bottom:16px;
    }
    .form-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:12px 16px;
      align-items:center;
    }
    .form-actions{
      margin-top:12px;
      display:flex;
      justify-content:flex-end;
      gap:8px;
    }

    .section-box{
      background:var(--card);
      border-radius:16px;
      padding:16px 24px;
      box-shadow:0 14px 32px rgba(15,23,42,0.08);
      border:1px solid rgba(226,232,240,0.9);
      margin-bottom:10px;
    }
    .section-title{
      font-size:13px;
      font-weight:600;
      margin-bottom:10px;
    }
    .grid-2{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:12px;
    }
    .table-responsive{
      max-height:360px;
      overflow:auto;
      border-radius:12px;
      border:1px solid var(--border);
      background:#ffffff;
    }
    table{width:100%;border-collapse:collapse;font-size:14px;}
    thead{background:#f1f5f9;position:sticky;top:0;z-index:1;}
    th{padding:10px 8px;border-bottom:2px solid #e5e7eb;text-align:center;font-weight:600;}
    td{padding:8px 10px;border-bottom:1px solid #e5e7eb;text-align:center;vertical-align:middle;}
    tbody tr:nth-child(even){background:#f9fafb;}

    .print-header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #ccc;padding:8px 0;margin-bottom:12px;}
    .print-header-left{display:flex;align-items:center;gap:10px;}
    .print-header-center{text-align:center;flex:1;}
    .print-logo{height:48px;width:48px;border-radius:50%;object-fit:cover;}
    .print-app-name{margin:0;font-size:18px;font-weight:700;}
    .print-company-name{font-size:14px;opacity:0.8;}
    .print-report-title{margin-top:4px;font-size:16px;font-weight:600;}
    .print-branch,.print-date,.print-dates{font-size:12px;}
    .print-table{width:100%;border-collapse:collapse;margin-top:10px;}
    .print-table th,.print-table td{border:1px solid #ddd;padding:6px;text-align:center;}

    .toast{
      position:fixed;
      bottom:16px;
      left:50%;
      transform:translateX(-50%);
      background:#0f172a;
      color:#f9fafb;
      padding:8px 14px;
      border-radius:999px;
      font-size:12px;
      box-shadow:0 12px 30px rgba(15,23,42,0.65);
      opacity:0;
      pointer-events:none;
      transition:opacity .2s, transform .2s;
    }
    .toast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-4px);
    }

    .branch-card{
      background:rgba(15,23,42,0.84);
      color:#e5e7eb;
      border-radius:22px;
      padding:14px 18px;
      border:1px solid rgba(148,163,184,0.6);
      display:flex;
      flex-direction:column;
      gap:6px;
      cursor:pointer;
      box-shadow:0 18px 36px rgba(15,23,42,0.85);
    }
    .branch-card:hover{
      border-color:#38bdf8;
    }
    .branch-name{
      font-size:18px;
      font-weight:600;
    }
    .branch-tag{
      font-size:11px;
      color:#cbd5f5;
    }

    .dashboard-header{display:flex;flex-direction:column;gap:4px;margin-bottom:16px}
    .dashboard-title{font-size:1.4rem;font-weight:700}
    .dashboard-subtitle{font-size:0.9rem;opacity:0.8}
    [dir="rtl"] .dashboard-header{text-align:right;align-items:flex-end}

    .dashboard-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin-bottom:24px}
    .kpi-card{position:relative;padding:14px 16px;border-radius:18px;background:rgba(255,255,255,0.75);backdrop-filter:blur(16px);box-shadow:0 10px 25px rgba(15,23,42,0.08);border:1px solid rgba(148,163,184,0.18);display:flex;flex-direction:column;gap:6px;padding-left:32px}
    .kpi-card::before{content:"";position:absolute;top:14px;left:16px;width:8px;height:28px;border-radius:999px;background:linear-gradient(180deg,var(--accent),var(--accent-strong));opacity:0.85}
    [dir="rtl"] .kpi-card{text-align:right;padding-right:32px;padding-left:16px}
    [dir="rtl"] .kpi-card::before{left:auto;right:16px}
    .kpi-label{font-size:0.85rem;color:#64748b}
    .kpi-value{font-size:1.3rem;font-weight:700;color:#0f172a}
    .kpi-helper{font-size:0.8rem;color:#94a3b8}

    .dashboard-panel{border-radius:18px;background:rgba(255,255,255,0.8);box-shadow:0 8px 20px rgba(15,23,42,0.04);padding:14px 16px;margin-bottom:18px}
    .dashboard-panel-title{font-size:0.95rem;font-weight:600;margin-bottom:10px;color:#0f172a}
    [dir="rtl"] .dashboard-panel,[dir="rtl"] .dashboard-panel-title{text-align:right}
    .chart-container{margin-bottom:12px}
    .chart-title{margin-bottom:8px}
    canvas{max-width:100%;height:120px;}

    /* Branch Selection Screen */
    #page-branch-select{
      position:fixed;
      top:0;
      left:0;
      right:0;
      bottom:0;
      background:radial-gradient(circle at top,#0ea5e9,#0369a1 40%,#1e293b 100%);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:10000;
    }
    #page-branch-select.show{
      display:flex;
    }
    .branch-select-overlay{
      width:100%;
      max-width:900px;
      padding:40px 24px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:40px;
    }
    .brand-block{
      text-align:center;
      color:#ffffff;
    }
    .branch-picker-logo{
      width:180px;
      height:180px;
      border-radius:40px;
      object-fit:cover;
      box-shadow:0 20px 50px rgba(15,23,42,0.35);
      margin-bottom:18px;
      background:transparent;
    }
    .app-title{
      font-size:32px;
      font-weight:800;
      margin-bottom:8px;
      letter-spacing:0.05em;
    }
    .app-subtitle{
      font-size:14px;
      opacity:0.9;
      letter-spacing:0.1em;
    }
    .branch-buttons-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
      gap:20px;
      width:100%;
      max-width:800px;
    }
    .glass-branch-btn{
      background:rgba(255,255,255,0.12);
      backdrop-filter:blur(16px);
      border:1px solid rgba(255,255,255,0.25);
      border-radius:20px;
      padding:24px 20px;
      color:#ffffff;
      cursor:pointer;
      transition:all 0.3s ease;
      display:flex;
      flex-direction:column;
      gap:8px;
      align-items:center;
      text-align:center;
      box-shadow:0 8px 24px rgba(0,0,0,0.2);
    }
    .glass-branch-btn:hover{
      background:rgba(255,255,255,0.2);
      transform:translateY(-4px);
      box-shadow:0 12px 32px rgba(0,0,0,0.3);
      border-color:rgba(255,255,255,0.4);
    }
    .glass-branch-btn .branch-name{
      font-size:20px;
      font-weight:700;
    }
    .glass-branch-btn .branch-tag{
      font-size:12px;
      opacity:0.85;
    }

    /* Modern layout shell overrides */
    html,body{
      height:100%;
    }
    body{
      font-family:system-ui,-apple-system,"Segoe UI",BlinkMacSystemFont,sans-serif;
      background:radial-gradient(circle at top,#e9fbff 0,#e3f3ff 40%,#fdfefe 100%);
      color:#102a43;
    }
    #app-shell{
      display:none;
      flex:1;
      min-height:0;
    }
    #app-shell.show{
      display:flex;
      flex-direction:column;
      height:100%;
    }
    .app-header{
      height:64px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 20px;
      background:rgba(255,255,255,0.9);
      backdrop-filter:blur(20px);
      box-shadow:0 18px 40px rgba(15,23,42,0.10);
      position:relative;
      z-index:10;
      gap:16px;
    }
    .header-left,
    .header-center,
    .header-right{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .header-titles{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .header-system-name{
      font-size:16px;
      font-weight:700;
    }
    .header-system-subtitle{
      font-size:12px;
      opacity:0.7;
    }
    .header-branch-label{
      font-size:13px;
      opacity:0.7;
    }
    .header-branch-btn{
      border:none;
      border-radius:999px;
      padding:6px 14px;
      background:linear-gradient(135deg,#0d9488,#22c1c3);
      color:#fff;
      cursor:pointer;
      font-size:12px;
      box-shadow:0 10px 24px rgba(13,148,136,0.3);
    }
    .header-lang-btn,
    .header-icon-btn{
      border:none;
      border-radius:999px;
      padding:6px 12px;
      cursor:pointer;
      background:rgba(15,23,42,0.05);
      transition:background 0.2s ease;
    }
    .header-lang-btn:hover,
    .header-icon-btn:hover{
      background:rgba(15,23,42,0.12);
    }
    .header-user-avatar{
      width:32px;
      height:32px;
      border-radius:50%;
      background:linear-gradient(135deg,#0d9488,#22c1c3);
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:600;
    }
    .header-hidden-toggle{
      display:none;
    }
    .status-icon-btn{
      border:none;
      border-radius:999px;
      padding:2px 8px;
      cursor:pointer;
      background:rgba(15,23,42,0.12);
      color:#e0fdf7;
      font-size:14px;
    }
    .status-icon-btn:hover{
      background:rgba(15,23,42,0.25);
    }
    .app-body{
      flex:1;
      display:flex;
      min-height:0;
    }
    
    [dir="rtl"] .app-body{
      flex-direction:row-reverse;
    }
    [dir="rtl"] .app-sidebar{
      order:2;
    }
    [dir="rtl"] .app-main{
      order:1;
    }

    .app-sidebar{
      width:230px;
      background:rgba(255,255,255,0.9);
      backdrop-filter:blur(18px);
      border-inline-end:1px solid rgba(148,163,184,0.35);
      padding:16px 14px;
      display:flex;
      flex-direction:column;
      gap:14px;
      overflow:auto;
    }
    .sidebar-groups{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .sidebar-group{
      border-radius:14px;
      padding:6px;
      background:rgba(255,255,255,0.55);
      box-shadow:0 10px 30px rgba(15,23,42,0.08);
    }
    .sidebar-group-header{
      width:100%;
      border:none;
      border-radius:10px;
      padding:8px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      cursor:pointer;
      background:transparent;
      color:#0f172a;
      font-weight:600;
      gap:8px;
    }
    .sidebar-group-header:hover{
      background:rgba(34,197,194,0.12);
    }
    .sidebar-chevron{
      font-size:10px;
      opacity:0.6;
      transition:transform 0.2s ease;
    }
    .sidebar-group-body{
      margin-top:4px;
      padding-inline-start:6px;
      display:none;
      flex-direction:column;
      gap:4px;
    }
    .sidebar-group.open .sidebar-group-body{
      display:flex;
    }
    .sidebar-group.open .sidebar-chevron{
      transform:rotate(180deg);
    }
    [dir="rtl"] .app-sidebar{
      border-inline-start:1px solid rgba(148,163,184,0.35);
      border-inline-end:none;
    }
    .sidebar-brand{
      display:flex;
      align-items:center;
      gap:10px;
      padding-bottom:12px;
      border-bottom:1px solid rgba(148,163,184,0.35);
    }
    .sidebar-section-title{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.12em;
      color:#6b7280;
      margin-top:4px;
    }
    .sidebar-section{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .sidebar-item{
      width:100%;
      border:none;
      border-radius:8px;
      padding:6px 10px;
      display:flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      background:transparent;
      color:#0f172a;
      font-size:13px;
      text-align:start;
    }
    .sidebar-item:hover{
      background:rgba(34,197,194,0.08);
    }
    .sidebar-item.active{
      background:linear-gradient(135deg,#0d9488,#22c1c3);
      color:#fff;
      box-shadow:0 10px 24px rgba(15,23,42,0.30);
    }
    .sidebar-icon{
      font-size:16px;
    }
    .app-main{
      flex:1;
      padding:18px 22px;
      overflow:auto;
      background:linear-gradient(135deg,rgba(248,250,252,0.7),rgba(240,249,255,0.9));
      backdrop-filter:blur(8px);
    }
    .workspace{
      flex:1;
      padding-bottom:40px;
    }
    .app-statusbar{
      height:30px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:0 16px;
      background:linear-gradient(90deg,#059669,#14b8a6);
      color:#e0fdf7;
      font-size:12px;
      gap:12px;
    }
    .status-left,.status-right{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .status-chip{
      display:flex;
      align-items:center;
    }
    .status-pill{
      padding:4px 10px;
      border-radius:999px;
      background:rgba(255,255,255,0.15);
      border:1px solid rgba(255,255,255,0.25);
      display:flex;
      align-items:center;
      gap:6px;
    }

    /* Login refinements */
    #page-login{
      min-height:100vh;
    }
    .login-shell{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      background:radial-gradient(circle at top,#e0fdf4 0,#e0f5ff 40%,#fdfefe 100%);
      padding:20px;
    }
    .login-card{
      width:360px;
      border-radius:24px;
      background:rgba(255,255,255,0.9);
      backdrop-filter:blur(26px);
      padding:28px 28px 24px;
      box-shadow:0 30px 80px rgba(15,23,42,0.25);
      text-align:center;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .login-logo{
      width:110px;
      height:110px;
      border-radius:30px;
      object-fit:cover;
      box-shadow:0 18px 40px rgba(15,23,42,0.35);
      margin:0 auto 8px;
    }
    .login-title{
      font-size:18px;
      font-weight:700;
    }
    .login-subtitle{
      font-size:13px;
      opacity:0.7;
      margin-bottom:4px;
    }
    .login-desc{
      font-size:13px;
      color:#6b7280;
    }
    .login-form-card{
      margin-top:8px;
      background:rgba(15,23,42,0.03);
      border-radius:20px;
      padding:18px;
      border:1px solid rgba(148,163,184,0.35);
      text-align:start;
    }
    .login-meta{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:center;
    }
    .login-note{
      font-size:11px;
      color:#64748b;
    }

    /* Branch selection */
    #page-branch-select{
      background:radial-gradient(circle at top,#e0fdf4 0,#dbeafe 40%,#fdfefe 100%);
    }
    .branch-shell{
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      width:100%;
      padding:20px;
    }
    .branch-panel{
      max-width:900px;
      width:100%;
      border-radius:28px;
      background:rgba(255,255,255,0.92);
      backdrop-filter:blur(26px);
      padding:28px 32px 24px;
      box-shadow:0 40px 100px rgba(15,23,42,0.30);
      text-align:center;
    }
    .branch-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
      gap:14px;
      margin-top:20px;
    }
    .branch-card,
    .glass-branch-btn{
      border-radius:18px;
      background:rgba(255,255,255,0.96);
      border:1px solid rgba(148,163,184,0.40);
      padding:14px 10px;
      cursor:pointer;
      box-shadow:0 14px 40px rgba(15,23,42,0.12);
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:15px;
      font-weight:600;
      transition:transform 0.12s ease, box-shadow 0.12s ease, background 0.12s ease;
      flex-direction:column;
      gap:6px;
    }
    .branch-card:hover,
    .glass-branch-btn:hover{
      background:linear-gradient(135deg,#0d9488,#22c1c3);
      color:#ffffff;
      transform:translateY(-2px);
      box-shadow:0 18px 50px rgba(15,23,42,0.25);
    }
  </style>
</head>
<body>

  <!-- LOGIN SCREEN -->
  <div id="screen-login" class="screen active">
    <section id="page-login">
      <div class="login-shell">
        <div class="login-card">
          <img src="logo.png" class="login-logo" alt="App Logo">
          <div class="login-title" data-i18n="systemName">Dr. Magdy Hamdan Pharmacies</div>
          <div class="login-subtitle" data-i18n="systemSubtitle">Financial Management System</div>
          <p class="login-desc" data-i18n="secureAccess">
            Centralized financial control for multi-branch pharmacies:
            sales, purchases, suppliers, treasury and home transfers.
          </p>
          <div class="login-meta">
            <div class="badge-soft">Multi-Branch Treasury</div>
            <div class="badge-soft">Suppliers & House Wallet</div>
            <div class="badge-soft">Arabic-first Workflow</div>
          </div>
          <form id="login-form" class="login-form-card">
            <div class="field">
              <label data-i18n="username">Username</label>
              <input id="login-username" autocomplete="off">
            </div>
            <div class="field">
              <label data-i18n="password">Password</label>
              <input id="login-password" type="password">
            </div>
            <div class="row" style="margin-top:8px;">
              <button type="submit" class="btn btn-primary" data-i18n="enterWorkspace">Enter workspace</button>
            </div>
          </form>
          <div class="login-note" data-i18n="firstTime">
            First time? use any username, it will be stored locally on this device only.
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- APP SCREEN -->
  <div id="screen-app" class="screen">
    <!-- Branch Selection Screen -->
    <section id="page-branch-select" class="full-branch-select">
      <div class="branch-shell">
        <div class="branch-panel">
          <img src="logo.png" class="branch-picker-logo" alt="App Logo">
          <h1 class="branch-picker-title" data-i18n="branchSelectTitle">Select Branch</h1>
          <p class="branch-picker-subtitle" data-i18n="branchSelectSubtitle">
            Choose a pharmacy branch or home wallet
          </p>
          <div class="branch-grid" id="branch-select-buttons">
            <!-- Buttons will be generated dynamically -->
          </div>
        </div>
      </div>
    </section>

    <!-- App Shell -->
    <div id="app-shell" class="app-shell">
      <header class="app-header">
        <div class="header-left">
          <img id="app-logo" src="logo.png" alt="App Logo">
          <div class="header-titles">
            <div class="header-system-name" data-i18n="systemName">Dr. Magdy Hamdan Pharmacies</div>
            <div class="header-system-subtitle" data-i18n="systemSubtitle">Financial Management System</div>
          </div>
        </div>
        <div class="header-center">
          <span class="header-branch-label" data-i18n="currentBranchLabel">Current branch:</span>
          <span id="header-current-branch-name" data-i18n="none">None</span>
          <span id="branch-name-label" class="branch-pill">None</span>
          <button class="header-branch-btn" id="btn-change-branch" data-i18n="change" type="button">Change</button>
        </div>
        <div class="header-right">
          <button id="btn-lang-ar" class="header-lang-btn" type="button">Ø¹</button>
          <button id="btn-lang-en" class="header-lang-btn" type="button">EN</button>
          <button class="header-icon-btn" id="btn-header-notifications" type="button">ğŸ””</button>
          <div class="header-user-avatar">M</div>
          <button id="btn-lang-toggle" class="header-hidden-toggle" data-i18n="langToggle" type="button">AR/EN</button>
          <button id="btn-logout" class="header-icon-btn" type="button">â Ø®Ø±ÙˆØ¬</button>
        </div>
      </header>
      <div class="app-body">
      <nav class="app-sidebar">
        <div class="sidebar-brand">
          <div class="mini-logo">P</div>
          <div>
            <div class="sidebar-title-main" data-i18n="pharmaFinanceConsole">Pharma Finance Console</div>
            <div class="sidebar-title-sub" data-i18n="branchesTreasurySuppliers">Branches Â· Treasury Â· Suppliers</div>
          </div>
        </div>
        <div class="sidebar-groups">
          <div class="sidebar-group open" data-sidebar-group="pharmacy">
            <button class="sidebar-group-header" type="button">
              <span class="sidebar-icon">ğŸ </span>
              <span class="sidebar-label" data-i18n="navDashboard">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</span>
              <span class="sidebar-chevron">â–¾</span>
            </button>
            <div class="sidebar-group-body">
              <button class="sidebar-item" type="button" data-page-id="page-dashboard">
                <span data-i18n="branchDashboard">Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„ÙØ±Ø¹</span>
              </button>
            </div>
          </div>

          <div class="sidebar-group" data-sidebar-group="pharmacy">
            <button class="sidebar-group-header" type="button">
              <span class="sidebar-icon">ğŸ’°</span>
              <span class="sidebar-label" data-i18n="navSales">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span>
              <span class="sidebar-chevron">â–¾</span>
            </button>
            <div class="sidebar-group-body">
              <button class="sidebar-item" type="button" data-page-id="page-sales-entry">
                <span data-i18n="todaySales">Ø­Ø±ÙƒØ© Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span>
              </button>
              <button class="sidebar-item" type="button" data-page-id="page-sales-report">
                <span data-i18n="salesReport">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª</span>
              </button>
            </div>
          </div>

          <div class="sidebar-group" data-sidebar-group="pharmacy">
            <button class="sidebar-group-header" type="button">
              <span class="sidebar-icon">ğŸ“¦</span>
              <span class="sidebar-label" data-i18n="navPurchases">Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</span>
              <span class="sidebar-chevron">â–¾</span>
            </button>
            <div class="sidebar-group-body">
              <button class="sidebar-item" type="button" data-page-id="page-purch-invoice">
                <span data-i18n="purchaseInvoice">ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡</span>
              </button>
              <button class="sidebar-item" type="button" data-page-id="page-purch-return">
                <span data-i18n="purchaseReturn">Ù…Ø±ØªØ¬Ø¹ Ø´Ø±Ø§Ø¡</span>
              </button>
              <button class="sidebar-item" type="button" data-page-id="page-purch-report">
                <span data-i18n="purchaseReport">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</span>
              </button>
            </div>
          </div>

          <div class="sidebar-group" data-sidebar-group="pharmacy">
            <button class="sidebar-group-header" type="button">
              <span class="sidebar-icon">ğŸ‘¥</span>
              <span class="sidebar-label" data-i18n="navSuppliers">Ø§Ù„Ù…ÙˆØ±Ø¯ÙˆÙ†</span>
              <span class="sidebar-chevron">â–¾</span>
            </button>
            <div class="sidebar-group-body">
              <button class="sidebar-item" type="button" data-page-id="page-sup-manage">
                <span data-i18n="addManageSupplier">Ø¥Ø¶Ø§ÙØ© / Ø¥Ø¯Ø§Ø±Ø© Ù…ÙˆØ±Ø¯</span>
              </button>
              <button class="sidebar-item" type="button" data-page-id="page-sup-statement">
                <span data-i18n="supplierStatement">ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ù…ÙˆØ±Ø¯</span>
              </button>
              <button class="sidebar-item" type="button" data-page-id="page-sup-monthly">
                <span data-i18n="suppliersMonthlySummary">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† Ø§Ù„Ø´Ù‡Ø±ÙŠ</span>
              </button>
            </div>
          </div>

          <div class="sidebar-group" data-sidebar-group="pharmacy">
            <button class="sidebar-group-header" type="button">
              <span class="sidebar-icon">ğŸ¦</span>
              <span class="sidebar-label">Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª</span>
              <span class="sidebar-chevron">â–¾</span>
            </button>
            <div class="sidebar-group-body">
              <button class="sidebar-item" type="button" data-page-id="page-cash-out">
                <span data-i18n="cashOut">Ø§Ù„Ø®Ø²ÙŠÙ†Ø© / ØµØ±Ù Ù†Ù‚Ø¯ÙŠØ©</span>
              </button>
              <button class="sidebar-item" type="button" data-page-id="page-expenses-report">
                <span data-i18n="expensesReport">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</span>
              </button>
              <button class="sidebar-item" type="button" data-page-id="page-profit-analysis">
                <span data-i18n="profitAnalysis">Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠØ©</span>
              </button>
              <button class="sidebar-item" type="button" data-page-id="page-inventory">
                <span data-i18n="navInventory">ÙØªØ­ / Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†</span>
              </button>
            </div>
          </div>

          <div class="sidebar-group" data-sidebar-group="home">
            <button class="sidebar-group-header" type="button">
              <span class="sidebar-icon">ğŸ¡</span>
              <span class="sidebar-label" data-i18n="navHome">Ø§Ù„Ù…Ù†Ø²Ù„ / Ø§Ù„Ø¨ÙŠØª</span>
              <span class="sidebar-chevron">â–¾</span>
            </button>
            <div class="sidebar-group-body">
              <button class="sidebar-item" type="button" data-page-id="page-home-dashboard">
                <span data-i18n="homeDashboard">Ù„ÙˆØ­Ø© Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ù†Ø²Ù„</span>
              </button>
              <button class="sidebar-item" type="button" data-page-id="page-home-benef">
                <span data-i18n="beneficiaries">Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙˆÙ†</span>
              </button>
              <button class="sidebar-item" type="button" data-page-id="page-home-exp">
                <span data-i18n="houseExpenses">Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…Ù†Ø²Ù„</span>
              </button>
              <button class="sidebar-item" type="button" data-page-id="page-home-report">
                <span data-i18n="homeReport">ØªÙ‚Ø±ÙŠØ± Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø¨ÙŠØª</span>
              </button>
            </div>
          </div>
          <div class="sidebar-group" data-sidebar-group="system">
            <button class="sidebar-group-header" type="button">
              <span class="sidebar-icon">âš™</span>
              <span class="sidebar-label">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</span>
              <span class="sidebar-chevron">â–¾</span>
            </button>
            <div class="sidebar-group-body">
              <button class="sidebar-item" type="button" data-page-id="page-settings">
                <span>ØµÙØ­Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</span>
              </button>
              <button class="sidebar-item" type="button" data-page-id="page-users" id="sidebar-users">
                <span>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</span>
              </button>
            </div>
          </div>
        </div>
      </nav>

      <main class="app-main">

        <div class="workspace">

          <!-- DASHBOARD -->
          <section id="page-dashboard" class="page">
            <div class="page-header">
              <div class="dashboard-header">
                <div class="dashboard-title">ğŸ“Š <span data-i18n="branchDashboard">Branch Dashboard</span></div>
                <div class="dashboard-subtitle"><span data-i18n="dashboardOverview">Overview of today's performance and key metrics.</span></div>
              </div>
              <button class="btn-print-page" onclick="printCurrentPage()">
                <span class="icon">ğŸ–¨</span>
                <span data-i18n="printPageLabel">Ø·Ø¨Ø§Ø¹Ø©</span>
              </button>
            </div>
            <div class="page-inner">
              <div class="dashboard-grid">
                <div class="kpi-card">
                  <div class="kpi-label">Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
                  <div class="kpi-value" id="dash-today-sales">0.00</div>
                </div>
                <div class="kpi-card">
                  <div class="kpi-label">Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…</div>
                  <div class="kpi-value" id="dash-today-purchases">0.00</div>
                </div>
                <div class="kpi-card">
                  <div class="kpi-label">ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙŠÙˆÙ…</div>
                  <div class="kpi-value" id="dash-today-profit">0.00</div>
                </div>
              </div>

              <div class="dashboard-grid">
                <div class="kpi-card">
                  <div class="kpi-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ÙŠÙˆÙ…</div>
                  <div class="kpi-value" id="dash-today-expenses">0.00</div>
                </div>
                <div class="kpi-card">
                  <div class="kpi-label">Ø£Ø±Ø¨Ø§Ø­ Ø§Ù„Ø´Ù‡Ø± Ø­ØªÙ‰ Ø§Ù„ÙŠÙˆÙ…</div>
                  <div class="kpi-value" id="dash-month-profit">0.00</div>
                </div>
                <div class="kpi-card">
                  <div class="kpi-label">Ù†Ø³Ø¨Ø© Ù…Ø¬Ù…Ù„ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙŠÙˆÙ…</div>
                  <div class="kpi-value" id="dash-gross-margin">â€”</div>
                </div>
              </div>

              <div class="chart-container dashboard-panel">
                <div class="chart-title dashboard-panel-title" data-i18n="salesLast7Days">Sales - Last 7 Days</div>
                <canvas id="chart-sales"></canvas>
              </div>
              <div class="chart-container dashboard-panel">
                <div class="chart-title dashboard-panel-title" data-i18n="purchasesLast7Days">Purchases - Last 7 Days</div>
                <canvas id="chart-purchases"></canvas>
              </div>
            </div>
          </section>

          <!-- USERS MANAGEMENT -->
          <section id="page-users" class="page" data-page="users">
            <div class="page-header">
              <div>
                <h2 class="page-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</h2>
                <p class="page-subtitle">Ø¥Ø¶Ø§ÙØ© ÙˆØªØ¹Ø¯ÙŠÙ„ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</p>
              </div>
            </div>
            <div class="page-inner page-body">
              <div class="card form-card" style="margin-bottom:14px;">
                <form id="form-user">
                  <div class="row" style="margin-bottom:8px;gap:8px;">
                    <button type="button" id="btn-user-new" class="btn btn-outline">Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</button>
                  </div>
                  <div class="form-grid">
                    <div class="field">
                      <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (username)</label>
                      <input id="user-username" type="text" autocomplete="off" required>
                    </div>
                    <div class="field">
                      <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¸Ø§Ù‡Ø±</label>
                      <input id="user-displayName" type="text" autocomplete="off" required>
                    </div>
                    <div class="field">
                      <label>Ø§Ù„Ø¯ÙˆØ± / Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</label>
                      <select id="user-role">
                        <option value="cashier">ÙƒØ§Ø´ÙŠØ± (Ø¥Ø¶Ø§ÙØ© ÙÙ‚Ø·)</option>
                        <option value="viewer">Ø¹Ø±Ø¶ ÙÙ‚Ø·</option>
                        <option value="admin">Ù…Ø¯ÙŠØ± (ÙƒØ§Ù…Ù„ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª)</option>
                      </select>
                    </div>
                    <div class="field">
                      <label>
                        <input id="user-active" type="checkbox" checked>
                        Ù…ÙØ¹Ù„
                      </label>
                    </div>
                    <div class="field">
                      <label>ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± (ÙŠÙ…ÙƒÙ† ØªØ±ÙƒÙ‡Ø§ ÙØ§Ø±ØºØ©)</label>
                      <input id="user-password" type="password" autocomplete="new-password">
                    </div>
                  </div>
                  <div class="form-actions" style="margin-top:10px;gap:8px;display:flex;">
                    <button type="submit" class="btn btn-primary">Ø­ÙØ¸ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
                    <button type="button" id="btn-user-reset" class="btn btn-outline">Ø¥Ù„ØºØ§Ø¡</button>
                  </div>
                </form>
              </div>

              <div class="card" style="padding:12px;">
                <div class="section-title">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†</div>
                <div class="table-responsive">
                  <table class="table" id="tbl-users">
                    <thead>
                      <tr>
                        <th>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</th>
                        <th>Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¸Ø§Ù‡Ø±</th>
                        <th>Ø§Ù„Ø¯ÙˆØ±</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</th>
                        <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                      </tr>
                    </thead>
                    <tbody></tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>

          <!-- BRANCH PICKER -->
          <section id="page-branch-picker" class="page active">
            <div class="page-header">
              <div>
                <h2 data-i18n="chooseBranch">Choose Branch</h2>
                <p data-i18n="selectWorkingBranch">Select the working branch. "HOME" is for house wallet & beneficiaries.</p>
              </div>
              <button class="btn-print-page" onclick="printCurrentPage()">
                <span class="icon">ğŸ–¨</span>
                <span data-i18n="printPageLabel">Ø·Ø¨Ø§Ø¹Ø©</span>
              </button>
            </div>
            <div class="grid-2">
              <div class="branch-card" data-branch="Qotour">
                <div class="branch-name">Qotour</div>
                <div class="branch-tag" data-i18n="mainPharmacyBranch">Main pharmacy branch</div>
              </div>
              <div class="branch-card" data-branch="Beltaj">
                <div class="branch-name">Beltaj</div>
                <div class="branch-tag" data-i18n="secondaryPharmacy">Secondary pharmacy</div>
              </div>
              <div class="branch-card" data-branch="Samatay">
                <div class="branch-name">Samatay</div>
                <div class="branch-tag" data-i18n="villagePharmacy">Village pharmacy</div>
              </div>
              <div class="branch-card" data-branch="HOME">
                <div class="branch-name">HOME</div>
                <div class="branch-tag" data-i18n="houseWalletMonthlyBeneficiaries">House wallet & monthly beneficiaries</div>
              </div>
            </div>
          </section>

          <!-- SALES ENTRY -->
          <section id="page-sales-entry" class="page">
            <div class="page-header">
              <div>
                <h2>ğŸ’Š <span data-i18n="todaySales">Today Sales</span></h2>
                <p data-i18n="registerDailySales">Register daily sales per branch. Cash will increase treasury.</p>
              </div>
              <button class="btn-print-page" onclick="printCurrentPage()">
                <span class="icon">ğŸ–¨</span>
                <span data-i18n="printPageLabel">Ø·Ø¨Ø§Ø¹Ø©</span>
              </button>
            </div>
            <div class="page-inner">
              <div class="form-card">
                <div class="form-grid">
                  <div class="field">
                    <label data-i18n="date">Date</label>
                    <input type="date" id="sale-date">
                  </div>
                  <div class="field">
                    <label data-i18n="amount">Amount</label>
                    <input type="number" id="sale-amount" step="0.01">
                  </div>
                  <div class="field">
                    <label data-i18n="notes">Notes</label>
                    <input id="sale-notes">
                  </div>
                </div>
                <div class="form-actions">
                  <button class="btn btn-primary" type="submit" form="form-sale-entry" data-i18n="addSale">Add Sale</button>
                </div>
              </div>
              <form id="form-sale-entry" style="display:none;"></form>
            </div>
          </section>

          <!-- SALES REPORT -->
          <section id="page-sales-report" class="page">
            <div class="page-header">
              <div>
                <h2>ğŸ“Š <span data-i18n="salesReport">Sales Report</span></h2>
                <p data-i18n="detailedDailyMonthly">Detailed / daily / monthly aggregation for sales.</p>
              </div>
              <button class="btn-print-page" onclick="printCurrentPage()">
                <span class="icon">ğŸ–¨</span>
                <span data-i18n="printPageLabel">Ø·Ø¨Ø§Ø¹Ø©</span>
              </button>
            </div>
            <div class="page-inner">
              <div class="form-card">
                <div class="section-title" data-i18n="filter">Filter</div>
                <div class="row" style="margin-bottom:12px;gap:6px;flex-wrap:wrap;">
                  <button type="button" class="btn btn-outline quick-filter" data-filter="today" data-report="sales" data-i18n="today">Today</button>
                  <button type="button" class="btn btn-outline quick-filter" data-filter="last7" data-report="sales" data-i18n="last7Days">Last 7 Days</button>
                  <button type="button" class="btn btn-outline quick-filter" data-filter="month" data-report="sales" data-i18n="thisMonth">This Month</button>
                  <button type="button" class="btn btn-outline quick-filter" data-filter="year" data-report="sales" data-i18n="thisYear">This Year</button>
                  <button type="button" class="btn btn-outline quick-filter active" data-filter="custom" data-report="sales" data-i18n="custom">Custom</button>
                </div>
                <div class="form-grid">
                  <div class="field">
                    <label data-i18n="from">From</label>
                    <input type="date" id="sales-report-from">
                  </div>
                  <div class="field">
                    <label data-i18n="to">To</label>
                    <input type="date" id="sales-report-to">
                  </div>
                  <div class="field">
                    <label data-i18n="mode">Mode</label>
                    <select id="sales-report-mode">
                      <option value="detail" data-i18n="detail">Detail</option>
                      <option value="daily" data-i18n="dailySummary">Daily summary</option>
                      <option value="monthly" data-i18n="monthlySummary">Monthly summary</option>
                    </select>
                  </div>
                </div>
                <div class="form-actions">
                  <button class="btn btn-primary" type="submit" form="form-sales-report" data-i18n="show">Show</button>
                </div>
              </div>
              <form id="form-sales-report" style="display:none;"></form>
              <div class="section-box">
                <div class="table-responsive">
                  <table>
                    <thead>
                      <tr>
                        <th data-i18n="periodDate">Period / Date</th>
                        <th data-i18n="amount">Amount</th>
                        <th data-i18n="notes">Notes</th>
                        <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                      </tr>
                    </thead>
                    <tbody id="tbl-sales-report"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>

          <!-- PURCHASE INVOICE -->
          <section id="page-purch-invoice" class="page">
            <div class="page-header">
              <div>
                <h2>ğŸ“¦ <span data-i18n="purchaseInvoice">Purchase Invoice</span></h2>
                <p data-i18n="recordSupplierPurchase">Record supplier purchase invoices. Cash invoices will reduce treasury.</p>
              </div>
              <button class="btn-print-page" onclick="printCurrentPage()">
                <span class="icon">ğŸ–¨</span>
                <span data-i18n="printPageLabel">Ø·Ø¨Ø§Ø¹Ø©</span>
              </button>
            </div>
            <div class="page-inner">
              <div class="form-card">
                <div class="form-grid">
                  <div class="field">
                    <label data-i18n="date">Date</label>
                    <input type="date" id="purch-inv-date">
                  </div>
                  <div class="field">
                    <label data-i18n="supplier">Supplier</label>
                    <select id="purch-inv-supplier"></select>
                  </div>
                  <div class="field">
                    <label data-i18n="amount">Amount</label>
                    <input type="number" id="purch-inv-amount" step="0.01">
                  </div>
                  <div class="field">
                    <label data-i18n="paymentType">Payment Type</label>
                    <select id="purch-inv-paytype">
                      <option value="cash" data-i18n="cash">Cash</option>
                      <option value="credit" selected data-i18n="credit">Credit</option>
                    </select>
                  </div>
                  <div class="field">
                    <label data-i18n="notes">Notes</label>
                    <input id="purch-inv-notes">
                  </div>
                </div>
                <div class="form-actions">
                  <button class="btn btn-primary" type="submit" form="form-purch-invoice" data-i18n="addInvoice">Add Invoice</button>
                </div>
              </div>
              <form id="form-purch-invoice" style="display:none;"></form>
            </div>
          </section>

          <!-- PURCHASE RETURN -->
          <section id="page-purch-return" class="page">
            <div class="page-header">
              <div>
                <h2>â†© <span data-i18n="purchaseReturn">Purchase Return</span></h2>
                <p data-i18n="returnLinkedSameDay">Return linked to same-day invoices for the same supplier.</p>
              </div>
              <button class="btn-print-page" onclick="printCurrentPage()">
                <span class="icon">ğŸ–¨</span>
                <span data-i18n="printPageLabel">Ø·Ø¨Ø§Ø¹Ø©</span>
              </button>
            </div>
            <div class="page-inner">
              <div class="form-card">
                <div class="form-grid">
                  <div class="field">
                    <label data-i18n="date">Date</label>
                    <input type="date" id="purch-ret-date">
                  </div>
                  <div class="field">
                    <label data-i18n="supplier">Supplier</label>
                    <select id="purch-ret-supplier"></select>
                  </div>
                  <div class="field">
                    <label data-i18n="amount">Amount</label>
                    <input type="number" id="purch-ret-amount" step="0.01">
                  </div>
                  <div class="field">
                    <label data-i18n="originalInvoiceType">Original Invoice Type</label>
                    <select id="purch-ret-paytype">
                      <option value="cash" data-i18n="cash">Cash</option>
                      <option value="credit" data-i18n="credit">Credit</option>
                    </select>
                  </div>
                  <div class="field">
                    <label data-i18n="notes">Notes</label>
                    <input id="purch-ret-notes">
                  </div>
                </div>
                <div class="form-actions">
                  <button class="btn btn-primary" type="submit" form="form-purch-return" data-i18n="addReturn">Add Return</button>
                </div>
              </div>
              <form id="form-purch-return" style="display:none;"></form>
            </div>
          </section>

          <!-- PURCHASE REPORT -->
          <section id="page-purch-report" class="page">
            <div class="page-header">
              <div>
                <h2>ğŸ“Š <span data-i18n="purchaseReport">Purchase Report</span></h2>
                <p data-i18n="detailDailyMonthlyView">Detail / daily / monthly view including invoices, returns and net.</p>
              </div>
              <button class="btn-print-page" onclick="printCurrentPage()">
                <span class="icon">ğŸ–¨</span>
                <span data-i18n="printPageLabel">Ø·Ø¨Ø§Ø¹Ø©</span>
              </button>
            </div>
            <div class="page-inner">
              <div class="form-card">
                <div class="section-title" data-i18n="filter">Filter</div>
                <div class="row" style="margin-bottom:12px;gap:6px;flex-wrap:wrap;">
                  <button type="button" class="btn btn-outline quick-filter" data-filter="today" data-report="purch" data-i18n="today">Today</button>
                  <button type="button" class="btn btn-outline quick-filter" data-filter="last7" data-report="purch" data-i18n="last7Days">Last 7 Days</button>
                  <button type="button" class="btn btn-outline quick-filter" data-filter="month" data-report="purch" data-i18n="thisMonth">This Month</button>
                  <button type="button" class="btn btn-outline quick-filter" data-filter="year" data-report="purch" data-i18n="thisYear">This Year</button>
                  <button type="button" class="btn btn-outline quick-filter active" data-filter="custom" data-report="purch" data-i18n="custom">Custom</button>
                </div>
                <div class="form-grid">
                  <div class="field">
                    <label data-i18n="from">From</label>
                    <input type="date" id="purch-report-from">
                  </div>
                  <div class="field">
                    <label data-i18n="to">To</label>
                    <input type="date" id="purch-report-to">
                  </div>
                  <div class="field">
                    <label data-i18n="supplier">Supplier</label>
                    <select id="purch-report-supplier"></select>
                  </div>
                  <div class="field">
                    <label data-i18n="mode">Mode</label>
                    <select id="purch-report-mode">
                      <option value="detail" data-i18n="detail">Detail</option>
                      <option value="daily" data-i18n="dailyInvoicesReturnsNet">Daily (Invoices / Returns / Net)</option>
                      <option value="monthly" data-i18n="monthlyInvoicesReturnsNet">Monthly (Invoices / Returns / Net)</option>
                    </select>
                  </div>
                </div>
                <div class="form-actions">
                  <button class="btn btn-primary" type="submit" form="form-purch-report" data-i18n="show">Show</button>
                </div>
              </div>
              <form id="form-purch-report" style="display:none;"></form>
              <div class="section-box">
                <div class="table-responsive">
                  <table>
                    <thead>
                      <tr>
                        <th data-i18n="periodDateCol">Period / Date</th>
                        <th data-i18n="supplierCol">Supplier</th>
                        <th data-i18n="invoicesTotal">Invoices Total</th>
                        <th data-i18n="returnsTotal">Returns Total</th>
                        <th data-i18n="netAfterReturns">Net After Returns</th>
                        <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                      </tr>
                    </thead>
                    <tbody id="tbl-purch-report"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>

          <!-- SUPPLIERS MANAGE -->
          <section id="page-sup-manage" class="page">
            <div class="page-header">
              <div>
                <h2>ğŸ‘¥ <span data-i18n="suppliers">Suppliers</span></h2>
                <p data-i18n="addSuppliersOpening">Add suppliers and opening balances (amount you already owe them).</p>
              </div>
              <button class="btn-print-page" onclick="printCurrentPage()">
                <span class="icon">ğŸ–¨</span>
                <span data-i18n="printPageLabel">Ø·Ø¨Ø§Ø¹Ø©</span>
              </button>
            </div>
            <div class="page-inner">
              <div class="form-card">
                <div class="form-grid">
                  <div class="field">
                    <label data-i18n="name">Name</label>
                    <input id="sup-name">
                  </div>
                  <div class="field">
                    <label data-i18n="code">Code</label>
                    <input id="sup-code">
                  </div>
                  <div class="field">
                    <label data-i18n="openingBalance">Opening Balance (you owe him)</label>
                    <input type="number" id="sup-opening" step="0.01">
                  </div>
                </div>
                <div class="form-actions">
                  <button class="btn btn-primary" type="submit" form="form-sup-add" data-i18n="saveSupplier">Save Supplier</button>
                </div>
              </div>
              <form id="form-sup-add" style="display:none;"></form>
              <div class="section-box">
                <div class="section-title" data-i18n="supplierOverview">Supplier Overview</div>
                <div class="field">
                  <label data-i18n="supplier">Supplier</label>
                  <select id="sup-overview-select"></select>
                </div>
                <div id="sup-overview-card" style="margin-top:12px;"></div>
              </div>
              <div class="section-box">
                <div class="section-title" data-i18n="suppliersList">Suppliers List</div>
                <div class="table-responsive">
                  <table>
                    <thead>
                      <tr>
                        <th data-i18n="name">Name</th><th data-i18n="code">Code</th><th data-i18n="openingBalanceCol">Opening Balance</th>
                      </tr>
                    </thead>
                    <tbody id="tbl-sup-list"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>

          <!-- SUPPLIER STATEMENT -->
          <section id="page-sup-statement" class="page">
            <div class="page-header">
              <div>
                <h2>ğŸ“„ <span data-i18n="supplierStatement">Supplier Statement</span></h2>
                <p data-i18n="statementIncludingPurchases">Statement including purchases, returns and payments.</p>
              </div>
              <button class="btn-print-page" onclick="printCurrentPage()">
                <span class="icon">ğŸ–¨</span>
                <span data-i18n="printPageLabel">Ø·Ø¨Ø§Ø¹Ø©</span>
              </button>
            </div>
            <div class="page-inner">
              <div class="form-card">
                <div class="section-title" data-i18n="filter">Filter</div>
                <div class="form-grid">
                  <div class="field">
                    <label data-i18n="supplier">Supplier</label>
                    <select id="stmt-supplier"></select>
                  </div>
                  <div class="field">
                    <label data-i18n="from">From</label>
                    <input type="date" id="stmt-from">
                  </div>
                  <div class="field">
                    <label data-i18n="to">To</label>
                    <input type="date" id="stmt-to">
                  </div>
                </div>
                <div class="form-actions">
                  <button class="btn btn-primary" type="submit" form="form-sup-statement" data-i18n="show">Show</button>
                </div>
              </div>
              <form id="form-sup-statement" style="display:none;"></form>
              <div class="section-box">
                <div class="table-responsive">
                  <table>
                    <thead>
                      <tr>
                        <th data-i18n="date">Date</th>
                        <th data-i18n="type">Type</th>
                        <th data-i18n="amount">Amount</th>
                        <th data-i18n="note">Note</th>
                      </tr>
                    </thead>
                    <tbody id="tbl-sup-statement"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>

          <!-- SUPPLIERS MONTHLY SUMMARY -->
          <section id="page-sup-monthly" class="page">
            <div class="page-header">
              <div>
                <h2>ğŸ“Š <span data-i18n="suppliersMonthlySummary">Suppliers Monthly Summary</span></h2>
                <p data-i18n="openingBalanceWithdrawals">Opening balance, withdrawals (invoices), returns, payments and remaining per supplier.</p>
              </div>
              <button class="btn-print-page" onclick="printCurrentPage()">
                <span class="icon">ğŸ–¨</span>
                <span data-i18n="printPageLabel">Ø·Ø¨Ø§Ø¹Ø©</span>
              </button>
            </div>
            <div class="page-inner">
              <div class="form-card">
                <div class="section-title" data-i18n="chooseMonth">Choose Month</div>
                <div class="form-grid">
                  <div class="field">
                    <label data-i18n="branch">Branch</label>
                    <input type="text" id="sup-monthly-branch" readonly>
                  </div>
                  <div class="field">
                    <label data-i18n="monthly">Month</label>
                    <input type="month" id="sup-monthly-month">
                  </div>
                </div>
                <div class="form-actions">
                  <button class="btn btn-primary" type="submit" form="form-sup-monthly" data-i18n="generate">Generate</button>
                </div>
              </div>
              <form id="form-sup-monthly" style="display:none;"></form>
              <div class="section-box">
                <div class="table-responsive">
                  <table>
                    <thead>
                      <tr>
                        <th data-i18n="supplierName">Supplier Name</th>
                        <th data-i18n="openingBalance">Opening Balance</th>
                        <th data-i18n="purchases">Purchases</th>
                        <th data-i18n="returns">Returns</th>
                        <th data-i18n="payments">Payments</th>
                        <th data-i18n="closingBalance">Closing Balance</th>
                      </tr>
                    </thead>
                    <tbody id="tbl-sup-monthly"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>

          <!-- CASH OUT -->
          <section id="page-cash-out" class="page">
            <div class="page-header">
              <div>
                <h2>ğŸ¦ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ùˆ Ø§Ù„Ø®Ø²ÙŠÙ†Ø©</h2>
                <p data-i18n="registerCashExpenses">Register cash expenses, supplier payments, transfers and profit withdrawals.</p>
              </div>
              <button class="btn-print-page" onclick="printCurrentPage()">
                <span class="icon">ğŸ–¨</span>
                <span data-i18n="printPageLabel">Ø·Ø¨Ø§Ø¹Ø©</span>
              </button>
            </div>
            <div class="page-inner">
              <div class="section-box" id="treasury-opening-card">
                <h3>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ Ù„Ù„Ø®Ø²Ù†Ø©</h3>
                <p>Ù‡Ø°Ø§ Ø§Ù„Ø±ØµÙŠØ¯ Ø®Ø§Øµ Ø¨Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ ÙÙŠ Ø­Ø³Ø§Ø¨ Ø±ØµÙŠØ¯ Ø§Ù„Ø®Ø²Ù†Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ.</p>
                <div class="form-grid">
                  <div>
                    <label>Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ</label>
                    <input type="number" id="treasury-opening-input" step="0.01">
                  </div>
                </div>
                <div class="form-actions">
                  <button type="button" class="btn btn-primary" id="treasury-opening-save-btn">Ø­ÙØ¸</button>
                </div>
              </div>
              <div class="form-card">
                <div class="section-title">ØµØ±Ù Ù†Ù‚Ø¯ÙŠØ©</div>
                <div class="form-grid">
                  <div class="field">
                    <label data-i18n="date">Date</label>
                    <input type="date" id="cash-date">
                  </div>
                  <div class="field">
                    <label data-i18n="type">Type</label>
                    <select id="cash-out-type">
                      <option value="operatingExpense">Ù…ØµØ±ÙˆÙØ§Øª ØªØ´ØºÙŠÙ„ÙŠØ©</option>
                      <option value="supplierPayment">Ø³Ø¯Ø§Ø¯ Ù…ÙˆØ±Ø¯</option>
                      <option value="transferToHome">ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ù…Ù†Ø²Ù„ (Ø³Ø­Ø¨ Ø£Ø±Ø¨Ø§Ø­)</option>
                    </select>
                  </div>
                  <div id="expense-category-wrapper" class="field" style="display:none;">
                    <label>Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ</label>
                    <select id="expense-category">
                      <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ</option>
                      <option value="electricity">ÙƒÙ‡Ø±Ø¨Ø§Ø¡</option>
                      <option value="rent">Ø¥ÙŠØ¬Ø§Ø±</option>
                      <option value="salary">Ù…Ø±ØªØ¨</option>
                      <option value="maintenance">ØµÙŠØ§Ù†Ø©</option>
                      <option value="other">Ø£Ø®Ø±Ù‰</option>
                    </select>
                  </div>
                  <div id="cash-out-supplier-wrapper" class="field" style="display:none;">
                    <label>Ø§Ù„Ù…ÙˆØ±Ø¯</label>
                    <select id="cash-out-supplier"></select>
                  </div>
                  <div class="field">
                    <label data-i18n="amount">Amount</label>
                    <input type="number" id="cash-amount" step="0.01">
                  </div>
                  <div class="field">
                    <label data-i18n="note">Note</label>
                    <input id="cash-note">
                  </div>
                </div>
                <div class="form-actions">
                  <button class="btn btn-primary" type="submit" form="form-cash-out" data-i18n="save">Save</button>
                </div>
              </div>
              <form id="form-cash-out" style="display:none;"></form>
            </div>
          </section>

          <!-- EXPENSES REPORT -->
          <section id="page-expenses-report" class="page">
            <div class="page-header">
              <div>
                <h2>ğŸ“‘ <span data-i18n="expensesReport">Expenses Report</span></h2>
                <p data-i18n="filterCashExpenses">Filter cash expenses between dates.</p>
              </div>
              <button class="btn-print-page" onclick="printCurrentPage()">
                <span class="icon">ğŸ–¨</span>
                <span data-i18n="printPageLabel">Ø·Ø¨Ø§Ø¹Ø©</span>
              </button>
            </div>
            <div class="page-inner">
              <div class="form-card">
                <div class="section-title" data-i18n="filter">Filter</div>
                <div class="form-grid">
                  <div class="field">
                    <label data-i18n="from">From</label>
                    <input type="date" id="exp-from">
                  </div>
                  <div class="field">
                    <label data-i18n="to">To</label>
                    <input type="date" id="exp-to">
                  </div>
                </div>
                <div class="form-actions">
                  <button class="btn btn-primary" type="submit" form="form-expenses-report" data-i18n="show">Show</button>
                </div>
              </div>
              <form id="form-expenses-report" style="display:none;"></form>
              <div class="section-box">
                <div class="table-responsive">
                  <table>
                    <thead>
                      <tr>
                        <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                        <th>Ø§Ù„Ù†ÙˆØ¹</th>
                        <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                        <th>Ø§Ù„Ù…ÙˆØ±Ø¯ / Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ</th>
                        <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                        <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                      </tr>
                    </thead>
                    <tbody id="tbl-expenses"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>

          <!-- PROFIT ANALYSIS (SIMPLE) -->
          <section id="page-profit-analysis" class="page">
            <div class="page-header">
              <div>
                <h2>ğŸ“ˆ <span data-i18n="profitAnalysis">Profit Analysis</span></h2>
                <p data-i18n="simpleGrossNet">Simple gross / net profit based on sales, net purchases and expenses.</p>
              </div>
              <button class="btn-print-page" onclick="printCurrentPage()">
                <span class="icon">ğŸ–¨</span>
                <span data-i18n="printPageLabel">Ø·Ø¨Ø§Ø¹Ø©</span>
              </button>
            </div>
            <div class="page-inner">
              <div class="profit-filter-bar">
                <button class="profit-filter-btn active" data-period-mode="weekly">Ø£Ø³Ø¨ÙˆØ¹ÙŠ</button>
                <button class="profit-filter-btn" data-period-mode="monthly">Ø´Ù‡Ø±ÙŠ</button>
                <button class="profit-filter-btn" data-period-mode="yearly">Ø³Ù†ÙˆÙŠ</button>
                <select id="profit-period-select"></select>
              </div>
              <div class="form-card">
                <div class="section-title" data-i18n="period">Period</div>
                <div class="form-grid">
                  <div class="field">
                    <label data-i18n="from">From</label>
                    <input type="date" id="profit-from">
                  </div>
                  <div class="field">
                    <label data-i18n="to">To</label>
                    <input type="date" id="profit-to">
                  </div>
                </div>
                <div class="form-actions">
                  <button class="btn btn-primary" type="submit" form="form-profit" data-i18n="calculate">Calculate</button>
                </div>
              </div>
              <form id="form-profit" style="display:none;"></form>
              <div class="section-box">
                <div class="table-responsive">
                  <table>
                    <thead>
                      <tr><th data-i18n="item">Item</th><th data-i18n="value">Value</th></tr>
                    </thead>
                    <tbody id="tbl-profit"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>

          <!-- INVENTORY -->
          <section id="page-inventory" class="page">
            <div class="page-header">
              <div>
                <h2>ğŸ“¦ <span data-i18n="openingClosingStock">Opening / Closing Stock</span></h2>
                <p data-i18n="inventoryPerBranchMonth">Track opening and closing stock per branch and month.</p>
              </div>
              <button class="btn-print-page" onclick="printCurrentPage()">
                <span class="icon">ğŸ–¨</span>
                <span data-i18n="printPageLabel">Ø·Ø¨Ø§Ø¹Ø©</span>
              </button>
            </div>
            <div class="page-inner">
              <div class="form-card">
                <div class="form-grid">
                  <div class="field">
                    <label data-i18n="month">Month</label>
                    <input type="month" id="inv-month">
                  </div>
                  <div class="field">
                    <label data-i18n="openingStock">Opening Stock</label>
                    <input type="number" id="inv-opening" step="0.01">
                  </div>
                  <div class="field">
                    <label data-i18n="closingStock">Closing Stock</label>
                    <input type="number" id="inv-closing" step="0.01">
                  </div>
                </div>
                <div class="form-actions">
                  <button class="btn btn-primary" type="submit" form="form-inventory" data-i18n="save">Save</button>
                </div>
              </div>
              <form id="form-inventory" style="display:none;"></form>
              <div class="section-box">
                <div class="section-title" data-i18n="inventoryList">Inventory List</div>
                <div class="table-responsive">
                  <table>
                    <thead>
                      <tr>
                        <th data-i18n="branchCol">Branch</th>
                        <th data-i18n="monthCol">Month</th>
                        <th data-i18n="openingCol">Opening</th>
                        <th data-i18n="closingCol">Closing</th>
                        <th data-i18n="difference">Difference</th>
                      </tr>
                    </thead>
                    <tbody id="tbl-inventory"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>

          <!-- HOME: DASHBOARD -->
          <section id="page-home-dashboard" class="page">
            <div class="page-header">
              <div>
                <h2>ğŸ  <span data-i18n="homeDashboard">Home Dashboard</span></h2>
                <p data-i18n="homeDashboardDesc">Monthly overview of transfers, expenses, and beneficiaries.</p>
              </div>
              <button class="btn-print-page" onclick="printCurrentPage()">
                <span class="icon">ğŸ–¨</span>
                <span data-i18n="printPageLabel">Ø·Ø¨Ø§Ø¹Ø©</span>
              </button>
            </div>
            <div class="page-inner">
              <div class="section-box">
                <div class="section-title" data-i18n="selectMonth">Select Month</div>
                <div class="field">
                  <input type="month" id="home-dashboard-month" style="max-width:200px;">
                </div>
              </div>
              <div class="section-box">
                <div class="section-title" data-i18n="monthlySummary">Monthly Summary</div>
                <div id="home-dashboard-summary"></div>
              </div>
              <div class="section-box">
                <div class="section-title" data-i18n="transfersFromBranches">Transfers from Branches</div>
                <div class="table-responsive">
                  <table>
                    <thead>
                      <tr><th data-i18n="branch">Branch</th><th data-i18n="date">Date</th><th data-i18n="amount">Amount</th></tr>
                    </thead>
                    <tbody id="home-dashboard-transfers"></tbody>
                  </table>
                </div>
              </div>
              <div class="section-box">
                <div class="section-title" data-i18n="beneficiariesSummary">Beneficiaries Summary</div>
                <div class="table-responsive">
                  <table>
                    <thead>
                      <tr><th data-i18n="name">Name</th><th data-i18n="monthlySpent">Monthly Spent</th><th data-i18n="ytdSpent">YTD Spent</th><th data-i18n="monthlyAllowance">Monthly Allowance</th></tr>
                    </thead>
                    <tbody id="home-dashboard-beneficiaries"></tbody>
                  </table>
                </div>
              </div>
              <div class="section-box">
                <div class="section-title" data-i18n="trendAnalysis">Trend Analysis (Last 6 Months)</div>
                <div class="table-responsive">
                  <table>
                    <thead>
                      <tr><th data-i18n="month">Month</th><th data-i18n="transfersIn">Transfers In</th><th data-i18n="expenses">Expenses</th><th data-i18n="netResult">Net Result</th></tr>
                    </thead>
                    <tbody id="home-dashboard-trend"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>

          <!-- HOME: BENEFICIARIES -->
          <section id="page-home-benef" class="page">
            <div class="page-header">
              <div>
                <h2>ğŸ  <span data-i18n="beneficiaries">Beneficiaries</span></h2>
                <p data-i18n="houseWalletBeneficiaries">House wallet beneficiaries and monthly allocations.</p>
              </div>
              <button class="btn-print-page" onclick="printCurrentPage()">
                <span class="icon">ğŸ–¨</span>
                <span data-i18n="printPageLabel">Ø·Ø¨Ø§Ø¹Ø©</span>
              </button>
            </div>
            <div class="page-inner">
              <div class="form-card">
                <div class="form-grid">
                  <div class="field">
                    <label data-i18n="name">Name</label>
                    <input id="benef-name">
                  </div>
                  <div class="field">
                    <label data-i18n="monthlyAmount">Monthly Amount</label>
                    <input type="number" id="benef-amount" step="0.01">
                  </div>
                </div>
                <div class="form-actions">
                  <button class="btn btn-primary" type="submit" form="form-benef" data-i18n="save">Save</button>
                </div>
              </div>
              <form id="form-benef" style="display:none;"></form>
              <div class="section-box">
                <div class="section-title" data-i18n="beneficiariesList">Beneficiaries List</div>
                <div class="table-responsive">
                  <table>
                    <thead>
                      <tr><th data-i18n="name">Name</th><th data-i18n="monthly">Monthly</th></tr>
                    </thead>
                    <tbody id="tbl-benef"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>

          <!-- HOME: EXPENSES -->
          <section id="page-home-exp" class="page">
            <div class="page-header">
              <div>
                <h2>ğŸ  <span data-i18n="houseExpenses">House Expenses</span></h2>
                <p data-i18n="houseMonthlyExpenses">House monthly expenses paid from home wallet.</p>
              </div>
              <button class="btn-print-page" onclick="printCurrentPage()">
                <span class="icon">ğŸ–¨</span>
                <span data-i18n="printPageLabel">Ø·Ø¨Ø§Ø¹Ø©</span>
              </button>
            </div>
            <div class="page-inner">
              <div class="form-card">
                <div class="form-grid">
                  <div class="field">
                    <label data-i18n="date">Date</label>
                    <input type="date" id="home-exp-date">
                  </div>
                  <div class="field">
                    <label data-i18n="beneficiary">Beneficiary</label>
                    <select id="home-exp-benef"></select>
                  </div>
                  <div class="field">
                    <label data-i18n="amount">Amount</label>
                    <input type="number" id="home-exp-amount" step="0.01">
                  </div>
                  <div class="field">
                    <label data-i18n="note">Note</label>
                    <input id="home-exp-note">
                  </div>
                </div>
                <div class="form-actions">
                  <button class="btn btn-primary" type="submit" form="form-home-exp" data-i18n="save">Save</button>
                </div>
              </div>
              <form id="form-home-exp" style="display:none;"></form>
              <div class="section-box">
                <div class="table-responsive">
                  <table>
                    <thead>
                      <tr>
                        <th data-i18n="date">Date</th>
                        <th data-i18n="beneficiary">Beneficiary</th>
                        <th data-i18n="amount">Amount</th>
                        <th data-i18n="note">Note</th>
                        <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                      </tr>
                    </thead>
                    <tbody id="tbl-home-exp-report"></tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>

          <!-- SEARCH -->
          <section id="page-search" class="page">
            <div class="page-header">
              <div>
                <h2>ğŸ” <span data-i18n="globalSearch">Global Search</span></h2>
                <p data-i18n="globalSearchDesc">Search across suppliers, sales, purchases, expenses, home, beneficiaries.</p>
              </div>
              <button class="btn-print-page" onclick="printCurrentPage()">
                <span class="icon">ğŸ–¨</span>
                <span data-i18n="printPageLabel">Ø·Ø¨Ø§Ø¹Ø©</span>
              </button>
            </div>
            <div class="section-box">
              <div id="search-results-container"></div>
            </div>
          </section>

          <!-- BACKUP -->
          <section id="page-backup" class="page">
            <div class="page-header">
              <div>
                <h2>ğŸ’¾ <span data-i18n="backupRestore">Backup & Restore</span></h2>
                <p data-i18n="backupRestoreDesc">Export and import all application data.</p>
              </div>
              <button class="btn-print-page" onclick="printCurrentPage()">
                <span class="icon">ğŸ–¨</span>
                <span data-i18n="printPageLabel">Ø·Ø¨Ø§Ø¹Ø©</span>
              </button>
            </div>
            <div class="section-box">
              <div class="section-title" data-i18n="manualBackup">Manual Backup</div>
              <button class="btn btn-primary" type="button" onclick="downloadBackup()" data-i18n="downloadBackupJson">Download Backup JSON</button>
              <p style="margin-top:6px;font-size:12px;opacity:.7;" data-i18n="backupFileDesc">
                A JSON file containing all branches, sales, purchases, suppliers, treasury, home, etc.
              </p>
            </div>
            <div class="section-box">
              <div class="section-title" data-i18n="restoreFromBackup">Restore From Backup</div>
              <input type="file" id="backup-file-input" accept="application/json" />
              <button class="btn btn-outline" type="button" onclick="restoreBackup()" style="margin-top:8px;" data-i18n="restore">Restore</button>
              <p style="margin-top:6px;font-size:12px;opacity:.7;" data-i18n="restoreWarning">
                Current data will be replaced. Use carefully.
              </p>
            </div>
            <div class="section-box">
              <div class="section-title" data-i18n="autoBackupStatus">Auto Backup Status</div>
              <p id="auto-backup-status" data-i18n="lastAutoBackupNone">Last auto backup: none</p>
              <button class="btn btn-outline" type="button" onclick="restoreAutoBackup()" style="margin-top:8px;" data-i18n="restoreLastAutoBackup">Restore Last Auto Backup</button>
            </div>
          </section>

          <!-- SYSTEM SETTINGS -->
          <section id="page-settings" class="page">
            <div class="page-header">
              <div>
                <h2>âš™ï¸ ØµÙØ­Ø© Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
                <p>Ø¶Ø¨Ø· Ù‡ÙˆÙŠØ© Ø§Ù„Ù†Ø¸Ø§Ù…ØŒ Ø§Ù„Ù„ØºØ©ØŒ Ø§Ù„Ø´Ø¹Ø§Ø±ØŒ Ø§Ù„Ø«ÙŠÙ…ØŒ ÙˆØ­Ø¯ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø®Ø²Ù†Ø©.</p>
              </div>
              <button class="btn-print-page" onclick="printCurrentPage()">
                <span class="icon">ğŸ–¨</span>
                <span>Ø·Ø¨Ø§Ø¹Ø©</span>
              </button>
            </div>
            <div class="page-inner">
              <div class="form-card">
                <div class="section-title">Ù‡ÙˆÙŠØ© Ø§Ù„Ù†Ø¸Ø§Ù…</div>
                <div class="form-grid">
                  <div class="field">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø¤Ø³Ø³Ø©</label>
                    <input id="settings-company-name">
                  </div>
                  <div class="field">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù†Ø¸Ø§Ù…</label>
                    <input id="settings-app-name">
                  </div>
                </div>
                <div style="margin-top:10px;">
                  <strong>Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©:</strong>
                  <div id="settings-identity-preview" style="margin-top:6px;">â€”</div>
                </div>
              </div>

              <div class="form-card">
                <div class="section-title">Ø§Ù„Ù„ØºØ©</div>
                <div class="row">
                  <label><input type="radio" name="settings-lang" value="ar"> Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</label>
                  <label><input type="radio" name="settings-lang" value="en"> English</label>
                </div>
              </div>

              <div class="form-card">
                <div class="section-title">Ø§Ù„Ø´Ø¹Ø§Ø±</div>
                <div class="form-grid">
                  <div class="field">
                    <label>Ø±Ø§Ø¨Ø· Ø§Ù„Ù„ÙˆØ¬Ùˆ</label>
                    <input id="settings-logo-url" placeholder="logo.png">
                  </div>
                  <div class="field">
                    <label>Ù…Ø¹Ø§ÙŠÙ†Ø©</label>
                    <img id="settings-logo-preview" style="height:64px;width:64px;border-radius:18px;object-fit:cover;" alt="Logo Preview">
                  </div>
                </div>
              </div>

              <div class="form-card">
                <div class="section-title">Ø§Ù„Ø«ÙŠÙ…</div>
                <div class="row">
                  <label><input type="radio" name="settings-theme" value="light"> Light</label>
                  <label><input type="radio" name="settings-theme" value="teal"> Teal</label>
                </div>
              </div>

              <div class="form-card">
                <div class="section-title">Ø­Ø¯ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø®Ø²Ù†Ø©</div>
                <div class="form-grid">
                  <div class="field">
                    <label>Ø­Ø¯ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø®Ø²Ù†Ø©</label>
                    <input type="number" id="settings-treasury-limit" step="0.01" placeholder="200">
                  </div>
                </div>
              </div>

              <div class="form-actions">
                <button class="btn btn-primary" type="button" id="settings-save-btn">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                <button class="btn btn-outline" type="button" id="settings-reset-btn">Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©</button>
                <button class="btn btn-outline" type="button" onclick="showPage('page-backup')">Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ</button>
              </div>
            </div>
          </section>

        </div>

      </main>

      </div>

      <footer class="app-statusbar">
        <div class="status-left">
          <div class="status-chip" id="status-branch-treasury">
            <div class="status-pill" id="status-treasury-pill">
              <span data-i18n="branchTreasury">Branch Treasury:</span>
              <strong id="status-treasury">0.00</strong>
            </div>
          </div>
          <div class="status-chip" id="status-home-wallet">
            <div class="status-pill" id="status-home-pill">
              <span data-i18n="homeWallet">Home Wallet:</span>
              <strong id="status-home">0.00</strong>
            </div>
          </div>
        </div>
        <div class="status-right">
          <span id="status-alerts"></span>
          <button class="alerts-btn" id="btn-alerts" data-i18n-title="alerts" title="Alerts">
            ğŸ””
            <span class="alerts-badge" id="alerts-badge"></span>
          </button>
          <button class="status-icon-btn" id="status-settings-btn" data-i18n-title="navSettings" title="Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª">âš™</button>
        </div>
      </footer>
      <div id="alerts-panel">
        <div class="alerts-header">
          <span data-i18n="alerts">Alerts</span>
          <button class="alerts-btn" id="btn-alerts-close" style="font-size:14px;">âœ•</button>
        </div>
        <div class="alerts-list" id="alerts-list"></div>
      </div>

    </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    // ========= STATE =========
    const LS_KEY = 'pharmaFinanceState_v1';
    const defaultState = {
      user: null,
      currentUser: null,
      currentBranch: null,
      language: 'ar',
      branches: ['Qotour','Beltaj','Samatay','HOME'],
      treasuryOpening: {Qotour:0,Beltaj:0,Samatay:0,HOME:0},
      sales: [],
      purchases: [],
      suppliers: [],
      cashMoves: [],
      beneficiaries: [],
      homeExpenses: [],
      inventory: [],
      users: [],
      settings: {
        companyName: '',
        appName: '',
        logoUrl: '',
        language: 'ar',
        theme: 'light',
        treasuryWarningLimit: 200
      }
    };
    let state = loadState();
    let editingCashOutId = null;
    let editingSaleId = null;
    let editingPurchaseId = null;
    let editingHomeExpenseId = null;
    let editingUserId = null;

    function loadState(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw){
          const state = structuredClone(defaultState);
          if(!Array.isArray(state.users)) state.users = [];
          if(!state.users.length){
            const defaultAdmin = {
              id: 'u_admin',
              username: 'admin',
              displayName: 'Administrator',
              role: 'admin',
              isActive: true,
              password: 'admin',
              createdAt: new Date().toISOString()
            };
            state.users = [defaultAdmin];
          }
          (state.users || []).forEach(u=>{ if(typeof u.password === 'undefined') u.password = ''; });
          state.currentUser = null;
          return state;
        }
        const obj = JSON.parse(raw);
        if(!obj.treasuryOpening) obj.treasuryOpening = {};
        const branchList = obj.branches && obj.branches.length ? obj.branches : defaultState.branches;
        branchList.forEach(branch=>{
          if(typeof obj.treasuryOpening[branch] !== 'number'){
            obj.treasuryOpening[branch] = 0;
          }
        });
        const state = Object.assign(structuredClone(defaultState),obj);
        if(!state.settings){
          state.settings = structuredClone(defaultState.settings);
        }else{
          state.settings = Object.assign(structuredClone(defaultState.settings), state.settings);
        }
        if(state.cashMoves){
          state.cashMoves.forEach((c,i)=>{
            if(!c.id) c.id = String(Date.now()) + '_' + i;
            if(c.type === 'ProfitWithdraw' || c.type === 'TransferToHome') c.type = 'transferToHome';
            else if(c.type === 'Expense') c.type = 'operatingExpense';
            else if(c.type === 'SupplierPayment') c.type = 'supplierPayment';
            else if(!c.type) c.type = 'other';
            if(c.note && !c.notes) c.notes = c.note;
            if(typeof c.supplierId === 'undefined') c.supplierId = null;
            if(typeof c.expenseCategory === 'undefined') c.expenseCategory = null;
          });
        }
        if(state.sales){
          state.sales.forEach((s,i)=>{ if(!s.id) s.id = String(Date.now()) + '_sale_' + i; });
        }
        if(state.purchases){
          state.purchases.forEach((p,i)=>{ if(!p.id) p.id = String(Date.now()) + '_purch_' + i; });
        }
        if(state.homeExpenses){
          state.homeExpenses.forEach((h,i)=>{ if(!h.id) h.id = String(Date.now()) + '_home_' + i; });
        }
        if(!Array.isArray(state.users)) state.users = [];
        if(!state.users.length){
          const defaultAdmin = {
            id: 'u_admin',
            username: 'admin',
            displayName: 'Administrator',
            role: 'admin',
            isActive: true,
            password: 'admin',
            createdAt: new Date().toISOString()
          };
          state.users = [defaultAdmin];
        }
        (state.users || []).forEach(u=>{ if(typeof u.password === 'undefined') u.password = ''; });
        if(typeof state.currentUser === 'undefined') state.currentUser = null;
        return state;
      }catch(e){
        console.error(e);
        const state = structuredClone(defaultState);
        if(!Array.isArray(state.users)) state.users = [];
        if(!state.users.length){
          const defaultAdmin = {
            id: 'u_admin',
            username: 'admin',
            displayName: 'Administrator',
            role: 'admin',
            isActive: true,
            password: 'admin',
            createdAt: new Date().toISOString()
          };
          state.users = [defaultAdmin];
        }
        (state.users || []).forEach(u=>{ if(typeof u.password === 'undefined') u.password = ''; });
        state.currentUser = null;
        return state;
      }
    }
    function saveState(){
      localStorage.setItem(LS_KEY,JSON.stringify(state));
      localStorage.setItem('pharma_auto_backup', JSON.stringify({
        savedAt: new Date().toISOString(),
        state: state
      }));
      updateTreasuryLabels();
    }
    function userCanEdit(){
      if(!state.currentUser) return false;
      const role = state.currentUser.role || 'viewer';
      return role === 'admin' || role === 'cashier';
    }
    function requireEditPermission(){
      if(!userCanEdit()){
        alert("Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø· ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ†Ù‡ Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        return false;
      }
      return true;
    }
    function num(v){return v?Number(v):0;}
    function today(){
      const d = new Date();
      return d.toISOString().slice(0,10);
    }
    function getDateRange(filter){
      const d = new Date();
      const todayStr = today();
      if(filter==='today'){
        return {from:todayStr,to:todayStr};
      }else if(filter==='last7'){
        const from = new Date(d);
        from.setDate(d.getDate()-6);
        return {from:from.toISOString().slice(0,10),to:todayStr};
      }else if(filter==='month'){
        const from = new Date(d.getFullYear(),d.getMonth(),1);
        const to = new Date(d.getFullYear(),d.getMonth()+1,0);
        return {from:from.toISOString().slice(0,10),to:to.toISOString().slice(0,10)};
      }else if(filter==='year'){
        const from = new Date(d.getFullYear(),0,1);
        const to = new Date(d.getFullYear(),11,31);
        return {from:from.toISOString().slice(0,10),to:to.toISOString().slice(0,10)};
      }
      return null;
    }
    function showToast(msgKey){
      const t = document.getElementById('toast');
      const lang = state.language || 'ar';
      const msg = i18n[lang] && i18n[lang][msgKey] ? i18n[lang][msgKey] : msgKey;
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'),1700);
    }

    // ========= LOGIN / SCREENS =========
    const screenLogin = document.getElementById('screen-login');
    const screenApp = document.getElementById('screen-app');

    const loginFormEl = document.getElementById('login-form');
    if(loginFormEl && !loginFormEl.dataset.bound){
      loginFormEl.dataset.bound = 'true';
      loginFormEl.addEventListener('submit',e=>{
        e.preventDefault();
        const unameRaw = document.getElementById('login-username').value.trim();
        const pval = (document.getElementById('login-password') && document.getElementById('login-password').value) ? document.getElementById('login-password').value : '';
        const uname = unameRaw.toLowerCase();
        const userObj = (state.users || []).find(u=>String(u.username || '').toLowerCase() === uname);
        if(!userObj){
          alert('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯. Ø§Ø·Ù„Ø¨ Ù…Ù† Ø§Ù„Ù…Ø¯ÙŠØ± Ø¥Ø¶Ø§ÙØªÙƒ.');
          return;
        }
        if(userObj.isActive === false){
          alert('Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙØ¹Ù„.');
          return;
        }
        const savedPass = userObj.password || '';
        if(savedPass && savedPass !== pval){
          alert('ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
          return;
        }
        state.currentUser = userObj;
        state.user = userObj.displayName || userObj.username;
        saveState();
        if(screenLogin){
          screenLogin.classList.remove('active');
          screenLogin.classList.remove('hidden');
        }
        if(screenApp){
          screenApp.classList.remove('hidden');
          screenApp.classList.add('active');
        }
        initAfterLogin();
      });
    }

    function initAfterLogin(){
      initLanguage();
      initBranchPicker();
      initNav();
      initForms();
      applySettingsVisuals();
      applyTheme(state.settings && state.settings.theme ? state.settings.theme : 'light');
      renderSuppliersList();
      renderSupplierSelects();
      setDefaultDates();
      renderInventory();
      renderDashboard();
      state.currentBranch = null;
      saveState();
      showBranchSelectionScreen();
    }

    // ========= BRANCH PICKER =========
    function showBranchSelectionScreen(){
      const appShell = document.getElementById('app-shell');
      const branchSelect = document.getElementById('page-branch-select');
      if(appShell) appShell.classList.remove('show');
      if(branchSelect) branchSelect.classList.add('show');
      renderBranchSelectionButtons();
    }

    function showAppShell(){
      const appShell = document.getElementById('app-shell');
      const branchSelect = document.getElementById('page-branch-select');
      if(branchSelect) branchSelect.classList.remove('show');
      if(appShell) appShell.classList.add('show');
    }

    function renderBranchSelectionButtons(){
      const container = document.getElementById('branch-select-buttons');
      if(!container) return;
      container.innerHTML = '';
      const lang = state.language || 'ar';
      state.branches.forEach(branch=>{
        const btn = document.createElement('div');
        btn.className = 'glass-branch-btn';
        btn.setAttribute('data-branch', branch);
        const name = branch === 'HOME' ? (i18n[lang].homeHouse || 'HOME') : branch;
        const tagKey = branch === 'HOME' ? 'houseWalletMonthlyBeneficiaries' : 
                      branch === 'Qotour' ? 'mainPharmacyBranch' :
                      branch === 'Beltaj' ? 'secondaryPharmacy' : 'villagePharmacy';
        btn.innerHTML = '<div class="branch-name">' + name + '</div><div class="branch-tag" data-i18n="' + tagKey + '"></div>';
        const tagEl = btn.querySelector('.branch-tag');
        if(tagEl && i18n[lang] && i18n[lang][tagKey]){
          tagEl.textContent = i18n[lang][tagKey];
        }
        btn.addEventListener('click',()=>selectBranch(branch));
        container.appendChild(btn);
      });
    }

    function selectBranch(branchId){
      state.currentBranch = branchId;
      saveState();
      renderBranchLabel();
      renderSidebar();
      renderInventory();
      renderDashboard();
      syncTreasuryOpeningInput();
      updateStatusBar();
      showAppShell();
      if(branchId === 'HOME'){
        showPage('page-home-dashboard');
        renderHomeDashboard();
      }else{
        showPage('page-dashboard');
      }
    }

    function initBranchPicker(){
      document.querySelectorAll('.branch-card').forEach(card=>{
        card.addEventListener('click',()=>{
          const branch = card.getAttribute('data-branch');
          selectBranch(branch);
        });
      });
      document.getElementById('btn-change-branch').addEventListener('click',()=>{
        showBranchSelectionScreen();
      });
    }
    function renderBranchLabel(){
      const el = document.getElementById('branch-name-label');
      const headerBranchEl = document.getElementById('header-current-branch-name');
      const langPack = i18n[state.language || 'ar'];
      if(!state.currentBranch){
        if(el) el.textContent = langPack.none;
        if(headerBranchEl) headerBranchEl.textContent = langPack.none;
        return;
      }
      const label = state.currentBranch === 'HOME' ? langPack.homeHouse : state.currentBranch;
      if(el) el.textContent = label;
      if(headerBranchEl) headerBranchEl.textContent = label;
      const supMonthlyBranchEl = document.getElementById('sup-monthly-branch');
      if(supMonthlyBranchEl){
        supMonthlyBranchEl.value = state.currentBranch === 'HOME' ? (langPack.homeHouse || 'Home') : state.currentBranch;
      }
      const supOverviewSelect = document.getElementById('sup-overview-select');
      if(supOverviewSelect && supOverviewSelect.value && state.currentBranch){
        renderSupplierOverview(supOverviewSelect.value, state.currentBranch);
      } else if(supOverviewSelect){
        const card = document.getElementById('sup-overview-card');
        if(card) card.innerHTML='';
      }
    }
    function isHomeBranch(){
      return state.currentBranch === 'HOME';
    }

    function renderSidebar(){
      const groups = document.querySelectorAll('.sidebar-group');
      if(!groups.length) return;
      if(!state.currentBranch){
        groups.forEach(group=>{
          group.style.display = 'none';
          group.classList.remove('open');
        });
        return;
      }
      const isHome = isHomeBranch();
      groups.forEach(group=>{
        const type = group.getAttribute('data-sidebar-group');
        let visible = true;
        if(type === 'home'){
          visible = isHome;
        }else if(type === 'pharmacy'){
          visible = !isHome;
        }
        group.style.display = visible ? '' : 'none';
        if(!visible){
          group.classList.remove('open');
        }
      });
      const visibleGroups = Array.from(groups).filter(g=>g.style.display !== 'none');
      if(visibleGroups.length && !visibleGroups.some(g=>g.classList.contains('open'))){
        visibleGroups[0].classList.add('open');
      }
      const usersItem = document.querySelector('.sidebar-item[data-page-id="page-users"]');
      if(usersItem){
        usersItem.style.display = (state.currentUser && state.currentUser.role === 'admin') ? '' : 'none';
      }
    }

    // ========= NAVIGATION =========
    const homePages = ['page-home-dashboard','page-home-benef','page-home-exp','page-home-report'];
    const pharmacyPages = ['page-dashboard','page-sales-entry','page-sales-report','page-purch-invoice','page-purch-return','page-purch-report','page-sup-manage','page-sup-statement','page-sup-monthly','page-cash-out','page-expenses-report','page-profit-analysis','page-inventory','page-users'];

    function showPage(id){
      if(!state.currentBranch && id !== 'page-users'){
        showBranchSelectionScreen();
        return;
      }
      const isHome = isHomeBranch();
      if(isHome && pharmacyPages.includes(id)){
        return;
      }
      if(!isHome && homePages.includes(id)){
        return;
      }
      document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
      const pageEl = document.getElementById(id);
      if(pageEl) pageEl.classList.add('active');
      document.querySelectorAll('.sidebar-item').forEach(b=>b.classList.remove('active'));
      const btn = document.querySelector('.sidebar-item[data-page-id="'+id+'"]');
      if(btn){
        btn.classList.add('active');
        const parentGroup = btn.closest('.sidebar-group');
        if(parentGroup){
          document.querySelectorAll('.sidebar-group').forEach(g=>g.classList.remove('open'));
          parentGroup.classList.add('open');
        }
      }
      if(id==='page-dashboard') renderDashboard();
      if(id==='page-home-dashboard') renderHomeDashboard();
      if(id==='page-home-exp') renderHomeExpensesTable();
      if(id==='page-backup') updateAutoBackupStatus();
      if(id==='page-search') renderSearchResults(globalSearch(''), '');
      if(id==='page-branch-picker') renderBranchSelectionButtons();
      if(id==='page-users') renderUsersTable();
    }
    function initSidebarAccordion(){
      document.querySelectorAll('.sidebar-group-header').forEach(header=>{
        header.addEventListener('click',()=>{
          const group = header.closest('.sidebar-group');
          if(!group) return;
          const wasOpen = group.classList.contains('open');
          document.querySelectorAll('.sidebar-group').forEach(g=>g.classList.remove('open'));
          if(!wasOpen){
            group.classList.add('open');
          }
        });
      });
    }
    function initNav(){
      document.querySelectorAll('.sidebar-item').forEach(item=>{
        item.addEventListener('click',()=>{
          const id = item.getAttribute('data-page-id');
          if(id) showPage(id);
        });
      });
      const btnAlerts = document.getElementById('btn-alerts');
      const btnHeaderNotifications = document.getElementById('btn-header-notifications');
      const btnAlertsClose = document.getElementById('btn-alerts-close');
      const alertsPanel = document.getElementById('alerts-panel');
      const toggleAlertsPanel = ()=>{
        if(alertsPanel){
          alertsPanel.classList.toggle('open');
        }
      };
      if(btnAlerts){
        btnAlerts.addEventListener('click',toggleAlertsPanel);
      }
      if(btnHeaderNotifications){
        btnHeaderNotifications.addEventListener('click',toggleAlertsPanel);
      }
      if(btnAlertsClose && alertsPanel){
        btnAlertsClose.addEventListener('click',()=>{
          alertsPanel.classList.remove('open');
        });
      }
      const settingsBtn = document.getElementById('status-settings-btn');
      if(settingsBtn){
        settingsBtn.addEventListener('click',()=>{
          showPage('page-settings');
        });
      }
      const btnLogout = document.getElementById('btn-logout');
      if(btnLogout && !btnLogout.dataset.bound){
        btnLogout.dataset.bound = 'true';
        btnLogout.addEventListener('click',()=>{
          if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ØŸ')){
            state.currentUser = null;
            state.user = null;
            state.currentBranch = null;
            saveState();
            const loginForm = document.getElementById('login-form');
            const uEl = document.getElementById('login-username');
            const pEl = document.getElementById('login-password');
            if(uEl) uEl.value = '';
            if(pEl) pEl.value = '';
            if(screenApp) screenApp.classList.remove('active');
            if(screenLogin) screenLogin.classList.add('active');
          }
        });
      }
      initSidebarAccordion();
    }

    // ========= SUPPLIERS =========
    function renderSuppliersList(){
      const tb = document.getElementById('tbl-sup-list');
      tb.innerHTML = '';
      state.suppliers.forEach(s=>{
        const tr = document.createElement('tr');
        tr.innerHTML = '<td>'+s.name+'</td><td>'+ (s.code||'') +'</td><td>'+s.opening.toFixed(2)+'</td>';
        tb.appendChild(tr);
      });
    }
    function supplierName(id){
      const s = state.suppliers.find(x=>String(x.id)===String(id));
      return s? s.name : '';
    }
    function getSupplierNameById(id){
      return supplierName(id);
    }

    function getSupplierBalance(supplierId, branch){
      if(!supplierId || !branch) return 0;
      const s = state.suppliers.find(x=>String(x.id)===String(supplierId));
      if(!s) return 0;
      const opening = num(s.opening);
      const purchases = state.purchases.filter(p=>p.branch===branch && String(p.supplierId)===String(supplierId));
      let netPurch=0;
      purchases.forEach(p=>{
        if(p.kind==='invoice') netPurch+=num(p.amount);
        else netPurch-=num(p.amount);
      });
      const payments = state.cashMoves
        .filter(c=>c.branch===branch && (c.type==='supplierPayment' || c.type==='SupplierPayment') && String(c.supplierId)===String(supplierId))
        .reduce((a,c)=>a+num(c.amount),0);
      return opening + netPurch - payments;
    }

    function getSupplierMonthlyTotals(supplierId, branch, selectedMonth){
      if(!supplierId || !branch || !selectedMonth) return {purchases:0,returns:0,payments:0};
      const [y,m] = selectedMonth.split('-');
      const prefix = y+'-'+m+'-';
      const monthPurch = state.purchases
        .filter(p=>p.branch===branch && String(p.supplierId)===String(supplierId))
        .filter(p=>p.date && p.date.startsWith(prefix));
      let purchases=0,returns=0;
      monthPurch.forEach(p=>{
        if(p.kind==='invoice') purchases+=num(p.amount);
        else returns+=num(p.amount);
      });
      const payments = state.cashMoves
        .filter(c=>c.branch===branch && (c.type==='supplierPayment' || c.type==='SupplierPayment') && String(c.supplierId)===String(supplierId))
        .filter(c=>c.date && c.date.startsWith(prefix))
        .reduce((a,c)=>a+num(c.amount),0);
      return {purchases,returns,payments};
    }

    function getSupplierRecentTransactions(supplierId, branch, limit=5){
      if(!supplierId || !branch) return [];
      const rows=[];
      state.purchases.filter(p=>String(p.supplierId)===String(supplierId) && p.branch===branch)
        .forEach(p=>{
          rows.push({
            date:p.date,
            type:p.kind==='invoice'?'Purchase Invoice':'Purchase Return',
            amount:p.kind==='invoice'? num(p.amount): -num(p.amount),
            note:p.notes||''
          });
        });
      state.cashMoves.filter(c=>String(c.supplierId)===String(supplierId) && c.branch===branch && (c.type==='supplierPayment' || c.type==='SupplierPayment'))
        .forEach(c=>{
          rows.push({
            date:c.date,
            type:'Supplier Payment',
            amount:-num(c.amount),
            note:c.notes||c.note||''
          });
        });
      rows.sort((a,b)=>b.date.localeCompare(a.date));
      return rows.slice(0,limit);
    }
    function renderSupplierSelects(){
      const selectIds = ['purch-inv-supplier','purch-ret-supplier','purch-report-supplier','stmt-supplier','cash-out-supplier','cash-supplier','sup-overview-select'];
      selectIds.forEach(id=>{
        const el = document.getElementById(id);
        if(!el) return;
        const isOverview = id === 'sup-overview-select';
        const lang = state.language || 'ar';
        el.innerHTML = isOverview ? '<option value="">' + (i18n[lang].chooseSupplier || 'Select Supplier') + '</option>' : '<option value="">' + (i18n[lang].all || 'All') + '</option>';
        state.suppliers.forEach(s=>{
          const opt = document.createElement('option');
          opt.value = s.id;
          opt.textContent = s.name;
          el.appendChild(opt);
        });
      });
    }

    function renderSupplierOverview(supplierId, branch){
      const card = document.getElementById('sup-overview-card');
      if(!card) return;
      if(!supplierId || !branch){
        card.innerHTML = '';
        return;
      }
      const balance = getSupplierBalance(supplierId, branch);
      const today = new Date();
      const currentMonth = today.getFullYear()+'-'+(String(today.getMonth()+1).padStart(2,'0'));
      const monthly = getSupplierMonthlyTotals(supplierId, branch, currentMonth);
      const recent = getSupplierRecentTransactions(supplierId, branch, 5);
      let html = '<div style="padding:12px;background:#f5f5f5;border-radius:6px;">';
      html += '<div style="margin-bottom:12px;"><strong>Current Balance:</strong> '+balance.toFixed(2)+'</div>';
      html += '<div style="margin-bottom:12px;"><strong>This Month:</strong></div>';
      html += '<div style="margin-left:12px;margin-bottom:8px;">Purchases: '+monthly.purchases.toFixed(2)+'</div>';
      html += '<div style="margin-left:12px;margin-bottom:8px;">Returns: '+monthly.returns.toFixed(2)+'</div>';
      html += '<div style="margin-left:12px;margin-bottom:12px;">Payments: '+monthly.payments.toFixed(2)+'</div>';
      html += '<div style="margin-bottom:8px;"><strong>Last 5 Transactions:</strong></div>';
      if(recent.length){
        html += '<table style="width:100%;font-size:0.9em;"><thead><tr><th>Date</th><th>Type</th><th>Amount</th></tr></thead><tbody>';
        recent.forEach(t=>{
          html += '<tr><td>'+t.date+'</td><td>'+t.type+'</td><td>'+t.amount.toFixed(2)+'</td></tr>';
        });
        html += '</tbody></table>';
      } else {
        html += '<div style="margin-left:12px;">No transactions</div>';
      }
      html += '</div>';
      card.innerHTML = html;
    }

    // ========= TREASURY =========
    function treasuryOfBranch(b){
      let t = state.treasuryOpening[b] || 0;
      state.sales.filter(x=>x.branch===b).forEach(s=> t += num(s.amount));
      state.purchases.filter(x=>x.branch===b && x.kind==='invoice' && x.paytype==='cash').forEach(p=> t -= num(p.amount));
      state.purchases.filter(x=>x.branch===b && x.kind==='return' && x.paytype==='cash').forEach(p=> t += num(p.amount));
      state.cashMoves.filter(x=>x.branch===b).forEach(c=>{
        const cashOutType = c.type==='operatingExpense' || c.type==='supplierPayment' || c.type==='transferToHome' || c.type==='Expense' || c.type==='SupplierPayment' || c.type==='ProfitWithdraw' || c.type==='TransferToHome';
        if(cashOutType){
          t -= num(c.amount);
        }
      });
      return t;
    }
    function homeWallet(){
      let t = state.treasuryOpening.HOME || 0;
      state.cashMoves.filter(x=>x.type==='transferToHome' || x.type==='TransferToHome').forEach(c=> t += num(c.amount));
      state.homeExpenses.forEach(h=> t -= num(h.amount));
      return t;
    }
    function ensureTreasuryOpeningEntry(branch){
      if(!branch) return;
      if(!state.treasuryOpening) state.treasuryOpening = {};
      if(typeof state.treasuryOpening[branch] !== 'number'){
        state.treasuryOpening[branch] = 0;
      }
    }
    function syncTreasuryOpeningInput(){
      const input = document.getElementById('treasury-opening-input');
      const btn = document.getElementById('treasury-opening-save-btn');
      if(!input || !btn) return;
      if(!state.currentBranch || isHomeBranch()){
        input.value = '';
        input.disabled = true;
        btn.disabled = true;
        return;
      }
      ensureTreasuryOpeningEntry(state.currentBranch);
      input.disabled = false;
      btn.disabled = false;
      input.value = (state.treasuryOpening[state.currentBranch] || 0).toFixed(2);
    }

    // ========= HOME DASHBOARD =========
    function getHomeMonthSummary(selectedMonth){
      if(!selectedMonth) return {transfersIn:0,expenses:0,netBalance:0};
      const [y,m] = selectedMonth.split('-');
      const prefix = y+'-'+m+'-';
      
      const transfers = state.cashMoves
        .filter(c=> (c.type==='transferToHome' || c.type==='TransferToHome') && c.date && c.date.startsWith(prefix))
        .reduce((sum,c)=>sum+num(c.amount),0);
      
      const expenses = state.homeExpenses
        .filter(h=>h.date && h.date.startsWith(prefix))
        .reduce((sum,h)=>sum+num(h.amount),0);
      
      return {
        transfersIn: transfers,
        expenses: expenses,
        netBalance: transfers - expenses
      };
    }

    function getHomeTransfersByBranch(selectedMonth){
      if(!selectedMonth) return {};
      const [y,m] = selectedMonth.split('-');
      const prefix = y+'-'+m+'-';
      
      const branchTotals = {};
      state.cashMoves
        .filter(c=> (c.type==='transferToHome' || c.type==='TransferToHome') && c.date && c.date.startsWith(prefix))
        .forEach(c=>{
          const branch = c.branch || 'Unknown';
          branchTotals[branch] = (branchTotals[branch] || 0) + num(c.amount);
        });
      
      return branchTotals;
    }

    function getHomeBeneficiariesSummary(selectedMonth){
      if(!selectedMonth) return [];
      const [y,m] = selectedMonth.split('-');
      const prefix = y+'-'+m+'-';
      const yearPrefix = y+'-';
      
      const benefMap = {};
      
      state.beneficiaries.forEach(b=>{
        benefMap[b.id] = {
          id: b.id,
          name: b.name,
          monthlyAllowance: num(b.amount) || 0,
          monthlySpent: 0,
          ytdSpent: 0
        };
      });
      
      state.homeExpenses.forEach(h=>{
        if(h.date && h.date.startsWith(yearPrefix)){
          const benefId = String(h.benefId);
          if(benefMap[benefId]){
            const amount = num(h.amount);
            benefMap[benefId].ytdSpent += amount;
            if(h.date.startsWith(prefix)){
              benefMap[benefId].monthlySpent += amount;
            }
          }
        }
      });
      
      return Object.values(benefMap);
    }

    function getHomeTrendLastMonths(){
      const months = [];
      const today = new Date();
      for(let i=5; i>=0; i--){
        const d = new Date(today.getFullYear(), today.getMonth()-i, 1);
        const monthStr = d.getFullYear()+'-'+(String(d.getMonth()+1).padStart(2,'0'));
        months.push(monthStr);
      }
      
      return months.map(month=>{
        const summary = getHomeMonthSummary(month);
        return {
          month: month,
          transfersIn: summary.transfersIn,
          expenses: summary.expenses,
          netResult: summary.netBalance
        };
      });
    }

    function renderHomeDashboard(){
      if(state.currentBranch !== 'HOME') return;
      
      const monthInput = document.getElementById('home-dashboard-month');
      if(!monthInput) return;
      
      if(!monthInput.value){
        const today = new Date();
        monthInput.value = today.getFullYear()+'-'+(String(today.getMonth()+1).padStart(2,'0'));
      }
      
      const selectedMonth = monthInput.value;
      const summary = getHomeMonthSummary(selectedMonth);
      const benefSummary = getHomeBeneficiariesSummary(selectedMonth);
      const trend = getHomeTrendLastMonths();
      
      // Render summary
      const summaryEl = document.getElementById('home-dashboard-summary');
      if(summaryEl){
        summaryEl.innerHTML = `
          <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:12px;">
            <div style="padding:12px;background:#f5f5f5;border-radius:6px;">
              <div style="font-size:0.9em;color:#666;">${i18n[state.language || 'ar'].transfersIn || 'Transfers In'}</div>
              <div style="font-size:1.5em;font-weight:bold;color:#2196F3;">${summary.transfersIn.toFixed(2)}</div>
            </div>
            <div style="padding:12px;background:#f5f5f5;border-radius:6px;">
              <div style="font-size:0.9em;color:#666;">${i18n[state.language || 'ar'].expenses || 'Expenses'}</div>
              <div style="font-size:1.5em;font-weight:bold;color:#f44336;">${summary.expenses.toFixed(2)}</div>
            </div>
            <div style="padding:12px;background:#f5f5f5;border-radius:6px;">
              <div style="font-size:0.9em;color:#666;">${i18n[state.language || 'ar'].netBalance || 'Net Balance'}</div>
              <div style="font-size:1.5em;font-weight:bold;color:${summary.netBalance>=0?'#4CAF50':'#f44336'};">${summary.netBalance.toFixed(2)}</div>
            </div>
          </div>
        `;
      }
      
      // Render transfers table
      const transfersTb = document.getElementById('home-dashboard-transfers');
      if(transfersTb){
        transfersTb.innerHTML = '';
        const transfers = state.cashMoves
          .filter(c=>c.type==='transferToHome' || c.type==='TransferToHome' || c.type==='ProfitWithdraw')
          .filter(c=>!selectedMonth || c.date.startsWith(selectedMonth))
          .sort((a,b)=>a.date.localeCompare(b.date));
        let total = 0;
        transfers.forEach(c=>{
          total += num(c.amount);
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${c.branch || 'Unknown'}</td><td>${c.date}</td><td>${num(c.amount).toFixed(2)}</td>`;
          transfersTb.appendChild(tr);
        });
        if(transfers.length === 0){
          const tr = document.createElement('tr');
          tr.innerHTML = '<td colspan="3" style="text-align:center;color:#999;">No transfers in this month</td>';
          transfersTb.appendChild(tr);
        }else{
          const tr = document.createElement('tr');
          tr.style.fontWeight = 'bold';
          tr.innerHTML = `<td>${i18n[state.language || 'ar'].total || 'Total'}</td><td></td><td>${total.toFixed(2)}</td>`;
          transfersTb.appendChild(tr);
        }
      }
      
      // Render beneficiaries table
      const benefTb = document.getElementById('home-dashboard-beneficiaries');
      if(benefTb){
        benefTb.innerHTML = '';
        if(benefSummary.length === 0){
          const tr = document.createElement('tr');
          tr.innerHTML = '<td colspan="4" style="text-align:center;color:#999;">No beneficiaries found</td>';
          benefTb.appendChild(tr);
        }else{
          benefSummary.forEach(b=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${b.name}</td>
              <td>${b.monthlySpent.toFixed(2)}</td>
              <td>${b.ytdSpent.toFixed(2)}</td>
              <td>${b.monthlyAllowance.toFixed(2)}</td>
            `;
            benefTb.appendChild(tr);
          });
        }
      }
      
      // Render trend table
      const trendTb = document.getElementById('home-dashboard-trend');
      if(trendTb){
        trendTb.innerHTML = '';
        trend.forEach(t=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${t.month}</td>
            <td>${t.transfersIn.toFixed(2)}</td>
            <td>${t.expenses.toFixed(2)}</td>
            <td style="color:${t.netResult>=0?'#4CAF50':'#f44336'};font-weight:bold;">${t.netResult.toFixed(2)}</td>
          `;
          trendTb.appendChild(tr);
        });
      }
    }

    function updateStatusBar(){
      const treasuryEl = document.getElementById('status-treasury-pill');
      const homeEl = document.getElementById('status-home-pill');
      if(!treasuryEl || !homeEl) return;
      if(!state.currentBranch){
        treasuryEl.style.display = 'none';
        homeEl.style.display = 'none';
        return;
      }
      const isHome = isHomeBranch();
      if(isHome){
        treasuryEl.style.display = 'none';
        homeEl.style.display = 'flex';
        document.getElementById('status-home').textContent = homeWallet().toFixed(2);
      }else{
        treasuryEl.style.display = 'flex';
        homeEl.style.display = 'none';
        document.getElementById('status-treasury').textContent = treasuryOfBranch(state.currentBranch).toFixed(2);
      }
      renderAlerts();
    }
    function updateTreasuryLabels(){
      updateStatusBar();
    }

    // ========= ALERTS =========
    function computeAlerts(){
      const alerts = [];
      const branch = state.currentBranch;
      if(!branch) return alerts;

      const todayStr = today();
      const todayDate = new Date(todayStr);
      const sevenDaysAgo = new Date(todayDate);
      sevenDaysAgo.setDate(todayDate.getDate() - 7);
      const sevenDaysAgoStr = sevenDaysAgo.toISOString().slice(0,10);
      const threeDaysAgo = new Date(todayDate);
      threeDaysAgo.setDate(todayDate.getDate() - 3);
      const threeDaysAgoStr = threeDaysAgo.toISOString().slice(0,10);

      // 1. HIGH SUPPLIER DEBT
      const debtThreshold = 50000;
      state.suppliers.forEach(supplier => {
        const balance = getSupplierBalance(supplier.id, branch);
        if(balance > debtThreshold){
          alerts.push({
            message: `Supplier ${supplier.name} has high debt: ${balance.toFixed(2)}`,
            category: 'Supplier',
            severity: 'danger'
          });
        }
      });

      // 2. MONTHLY EXPENSE SPIKE
      const now = new Date();
      const thisMonth = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2,'0');
      const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
      const lastMonthStr = lastMonth.getFullYear() + '-' + String(lastMonth.getMonth() + 1).padStart(2,'0');
      const thisMonthPrefix = thisMonth + '-';
      const lastMonthPrefix = lastMonthStr + '-';
      
      const thisMonthExpenses = state.cashMoves
        .filter(c => c.branch === branch && (c.type === 'operatingExpense' || c.type === 'Expense') && c.date && c.date.startsWith(thisMonthPrefix))
        .reduce((sum, c) => sum + num(c.amount), 0);
      const lastMonthExpenses = state.cashMoves
        .filter(c => c.branch === branch && (c.type === 'operatingExpense' || c.type === 'Expense') && c.date && c.date.startsWith(lastMonthPrefix))
        .reduce((sum, c) => sum + num(c.amount), 0);
      
      if(lastMonthExpenses > 0 && thisMonthExpenses > lastMonthExpenses * 1.3){
        alerts.push({
          message: 'Expenses this month are significantly higher than last month.',
          category: 'Expenses',
          severity: 'warning'
        });
      }

      // 3. NO PURCHASES IN LAST 7 DAYS
      const hasPurchases7Days = state.purchases.some(p => 
        p.branch === branch && p.date && p.date >= sevenDaysAgoStr
      );
      if(!hasPurchases7Days){
        alerts.push({
          message: 'No purchases recorded in the last 7 days.',
          category: 'Purchases',
          severity: 'warning'
        });
      }

      // 4. NO SALES IN LAST 3 DAYS
      const hasSales3Days = state.sales.some(s => 
        s.branch === branch && s.date && s.date >= threeDaysAgoStr
      );
      if(!hasSales3Days){
        alerts.push({
          message: 'No sales have been recorded in the last 3 days.',
          category: 'Sales',
          severity: 'warning'
        });
      }

      // 5. LOW TREASURY BALANCE
      const treasury = treasuryOfBranch(branch);
      const warnLimit = (state.settings && typeof state.settings.treasuryWarningLimit === 'number') ? state.settings.treasuryWarningLimit : 200;
      if(treasury < 0 || treasury < warnLimit){
        alerts.push({
          message: 'Branch treasury is low.',
          category: 'Treasury',
          severity: treasury < 0 ? 'danger' : 'warning'
        });
      }

      // 6. LOW HOME WALLET
      if(branch === 'HOME'){
        const wallet = homeWallet();
        const warnLimitHome = (state.settings && typeof state.settings.treasuryWarningLimit === 'number') ? state.settings.treasuryWarningLimit : 200;
        if(wallet < 0 || wallet < warnLimitHome){
          alerts.push({
            message: 'Home wallet balance is low.',
            category: 'Home Wallet',
            severity: wallet < 0 ? 'danger' : 'warning'
          });
        }
      }

      return alerts;
    }

    function renderAlerts(){
      const alerts = computeAlerts();
      const badge = document.getElementById('alerts-badge');
      const list = document.getElementById('alerts-list');
      const statusAlerts = document.getElementById('status-alerts');
      const langPack = i18n[state.language || 'ar'] || {};
      
      if(badge){
        badge.textContent = alerts.length > 0 ? alerts.length : '';
      }
      if(statusAlerts){
        statusAlerts.textContent = alerts.length > 0
          ? alerts.length + ' ' + (langPack.alerts || 'Alerts')
          : (langPack.alerts || 'Alerts') + ': ' + (langPack.none || 'None');
      }
      
      if(list){
        if(alerts.length === 0){
          list.innerHTML = '<div style="padding:20px;text-align:center;color:var(--muted);font-size:12px;">No alerts</div>';
        } else {
          list.innerHTML = alerts.map(alert => `
            <div class="alert-item ${alert.severity}">
              <div class="alert-category">${alert.category}</div>
              <div class="alert-message">${alert.message}</div>
            </div>
          `).join('');
        }
      }
    }

    // ========= FORMS =========
    function setDefaultDates(){
      const todayStr = today();
      ['sale-date','purch-inv-date','purch-ret-date','cash-date','home-exp-date',
       'sales-report-from','sales-report-to',
       'purch-report-from','purch-report-to',
       'stmt-from','stmt-to',
       'exp-from','exp-to','profit-from','profit-to',
       'home-dashboard-month'
      ].forEach(id=>{
        const el = document.getElementById(id);
        if(el && !el.value) el.value = todayStr;
      });
      const minput = document.getElementById('sup-monthly-month');
      if(minput && !minput.value){
        minput.value = todayStr.slice(0,7);
      }
      const invMonth = document.getElementById('inv-month');
      if(invMonth && !invMonth.value){
        invMonth.value = todayStr.slice(0,7);
      }
      const homeDashMonth = document.getElementById('home-dashboard-month');
      if(homeDashMonth && !homeDashMonth.value){
        homeDashMonth.value = todayStr.slice(0,7);
      }
    }

    function requireBranch(){
      if(!state.currentBranch){
        showToast('Choose branch first');
        showPage('page-branch-picker');
        return false;
      }
      return true;
    }

    function initForms(){
      // sales entry
      document.getElementById('form-sale-entry').addEventListener('submit',e=>{
        e.preventDefault();
        if(!requireEditPermission()) return;
        if(!requireBranch()) return;
        if(state.currentBranch==='HOME'){
          showToast('Sales not allowed on HOME');
          return;
        }
        const obj = {
          id: editingSaleId ? String(editingSaleId) : String(Date.now()),
          branch:state.currentBranch,
          date:document.getElementById('sale-date').value,
          amount:num(document.getElementById('sale-amount').value),
          notes:document.getElementById('sale-notes').value||''
        };
        if(!obj.date || !obj.amount){showToast('Date & amount required');return;}
        if(editingSaleId){
          const idx = state.sales.findIndex(x=>String(x.id)===String(editingSaleId));
          if(idx>=0){ state.sales[idx] = Object.assign({}, state.sales[idx], obj); }
          editingSaleId = null;
        }else{
          state.sales.push(obj);
        }
        saveState();
        updateTreasuryLabels();
        renderDashboard();
        showToast('Sale saved');
        e.target.reset();
        setDefaultDates();
        const addBtn = document.querySelector('button[form="form-sale-entry"]');
        if(addBtn) addBtn.textContent = (i18n[state.language || 'ar'].addSale || 'Add Sale');
      });

      // sales report
      document.getElementById('form-sales-report').addEventListener('submit',e=>{
        e.preventDefault();
        if(!requireBranch()) return;
        const from = document.getElementById('sales-report-from').value;
        const to = document.getElementById('sales-report-to').value;
        const mode = document.getElementById('sales-report-mode').value;
        renderSalesReport(from,to,mode);
      });
      const salesTb = document.getElementById('tbl-sales-report');
      if(salesTb && !salesTb.dataset.bound){
        salesTb.dataset.bound = 'true';
        salesTb.addEventListener('click',(ev)=>{
          const t = ev.target;
          if(t && t.matches('.btn-delete-sale')){
            if(!requireEditPermission()) return;
            const id = t.getAttribute('data-id');
            if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ')){
              const idx = state.sales.findIndex(r=>String(r.id)===String(id));
              if(idx>=0){
                state.sales.splice(idx,1);
                saveState();
                updateTreasuryLabels();
                renderDashboard();
                const from = document.getElementById('sales-report-from').value;
                const to = document.getElementById('sales-report-to').value;
                const mode = document.getElementById('sales-report-mode').value;
                renderSalesReport(from,to,mode);
              }
            }
          }else if(t && t.matches('.btn-edit-sale')){
            if(!requireEditPermission()) return;
            const id = t.getAttribute('data-id');
            const rec = state.sales.find(r=>String(r.id)===String(id));
            if(rec){
              editingSaleId = rec.id;
              const dEl = document.getElementById('sale-date');
              const aEl = document.getElementById('sale-amount');
              const nEl = document.getElementById('sale-notes');
              if(dEl) dEl.value = rec.date || today();
              if(aEl) aEl.value = String(rec.amount || 0);
              if(nEl) nEl.value = rec.notes || '';
              const addBtn = document.querySelector('button[form="form-sale-entry"]');
              if(addBtn) addBtn.textContent = 'ØªØ­Ø¯ÙŠØ«';
              showPage('page-sales-entry');
            }
          }
        });
      }
      document.querySelectorAll('.quick-filter[data-report="sales"]').forEach(btn=>{
        btn.addEventListener('click',()=>{
          document.querySelectorAll('.quick-filter[data-report="sales"]').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          const filter = btn.getAttribute('data-filter');
          if(filter!=='custom'){
            const range = getDateRange(filter);
            if(range){
              document.getElementById('sales-report-from').value = range.from;
              document.getElementById('sales-report-to').value = range.to;
              if(requireBranch()){
                const mode = document.getElementById('sales-report-mode').value;
                renderSalesReport(range.from,range.to,mode);
              }
            }
          }
        });
      });
      document.getElementById('sales-report-from').addEventListener('change',()=>{
        document.querySelectorAll('.quick-filter[data-report="sales"]').forEach(b=>{
          if(b.getAttribute('data-filter')==='custom') b.classList.add('active');
          else b.classList.remove('active');
        });
      });
      document.getElementById('sales-report-to').addEventListener('change',()=>{
        document.querySelectorAll('.quick-filter[data-report="sales"]').forEach(b=>{
          if(b.getAttribute('data-filter')==='custom') b.classList.add('active');
          else b.classList.remove('active');
        });
      });

      // supplier manage
      document.getElementById('form-sup-add').addEventListener('submit',e=>{
        e.preventDefault();
        if(!requireEditPermission()) return;
        const name = document.getElementById('sup-name').value.trim();
        if(!name){showToast('Name required');return;}
        const code = document.getElementById('sup-code').value.trim();
        const opening = num(document.getElementById('sup-opening').value);
        const s = {id:Date.now(),name,code,opening};
        state.suppliers.push(s);
        saveState();
        renderSuppliersList();
        renderSupplierSelects();
        e.target.reset();
        showToast('Supplier saved');
      });
      const supOverviewSelect = document.getElementById('sup-overview-select');
      if(supOverviewSelect){
        supOverviewSelect.addEventListener('change',()=>{
          const supId = supOverviewSelect.value;
          if(supId && state.currentBranch){
            renderSupplierOverview(supId, state.currentBranch);
          } else {
            const card = document.getElementById('sup-overview-card');
            if(card) card.innerHTML='';
          }
        });
      }

      // purchase invoice
      document.getElementById('form-purch-invoice').addEventListener('submit',e=>{
        e.preventDefault();
        if(!requireEditPermission()) return;
        if(!requireBranch()) return;
        const date = document.getElementById('purch-inv-date').value;
        const sup = document.getElementById('purch-inv-supplier').value;
        const amount = num(document.getElementById('purch-inv-amount').value);
        const paytype = document.getElementById('purch-inv-paytype').value;
        const notes = document.getElementById('purch-inv-notes').value||'';
        if(!date || !sup || !amount){showToast('Date, supplier & amount required');return;}
        const rec = {
          id: editingPurchaseId ? String(editingPurchaseId) : String(Date.now()),
          branch:state.currentBranch,
          date,
          supplierId:sup,
          amount,
          paytype,
          kind:'invoice',
          notes
        };
        if(editingPurchaseId){
          const idx = state.purchases.findIndex(x=>String(x.id)===String(editingPurchaseId));
          if(idx>=0){ state.purchases[idx] = Object.assign({}, state.purchases[idx], rec); }
          editingPurchaseId = null;
        }else{
          state.purchases.push(rec);
        }
        saveState();
        updateTreasuryLabels();
        renderDashboard();
        showToast('Invoice saved');
        e.target.reset();
        setDefaultDates();
        renderSupplierSelects();
        const addBtn = document.querySelector('button[form="form-purch-invoice"]');
        if(addBtn) addBtn.textContent = (i18n[state.language || 'ar'].addInvoice || 'Add Invoice');
      });

      // purchase return
      document.getElementById('form-purch-return').addEventListener('submit',e=>{
        e.preventDefault();
        if(!requireEditPermission()) return;
        if(!requireBranch()) return;
        const date = document.getElementById('purch-ret-date').value;
        const sup = document.getElementById('purch-ret-supplier').value;
        const amount = num(document.getElementById('purch-ret-amount').value);
        const paytype = document.getElementById('purch-ret-paytype').value;
        const notes = document.getElementById('purch-ret-notes').value||'';
        if(!date || !sup || !amount){showToast('Date, supplier & amount required');return;}
        state.purchases.push({
          id:Date.now(),
          branch:state.currentBranch,
          date,
          supplierId:sup,
          amount,
          paytype,
          kind:'return',
          notes
        });
        saveState();
        updateTreasuryLabels();
        renderDashboard();
        showToast('Return added');
        e.target.reset();
        setDefaultDates();
      });

      // purchase report
      document.getElementById('form-purch-report').addEventListener('submit',e=>{
        e.preventDefault();
        if(!requireBranch()) return;
        const from = document.getElementById('purch-report-from').value;
        const to = document.getElementById('purch-report-to').value;
        const sup = document.getElementById('purch-report-supplier').value;
        const mode = document.getElementById('purch-report-mode').value;
        renderPurchReport(from,to,sup,mode);
      });
      const purchTb = document.getElementById('tbl-purch-report');
      if(purchTb && !purchTb.dataset.bound){
        purchTb.dataset.bound = 'true';
        purchTb.addEventListener('click',(ev)=>{
          const t = ev.target;
          if(t && t.matches('.btn-delete-purchase')){
            if(!requireEditPermission()) return;
            const id = t.getAttribute('data-id');
            if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ')){
              const idx = state.purchases.findIndex(r=>String(r.id)===String(id));
              if(idx>=0){
                state.purchases.splice(idx,1);
                saveState();
                updateTreasuryLabels();
                renderDashboard();
                const from = document.getElementById('purch-report-from').value;
                const to = document.getElementById('purch-report-to').value;
                const sup = document.getElementById('purch-report-supplier').value;
                const mode = document.getElementById('purch-report-mode').value;
                renderPurchReport(from,to,sup,mode);
              }
            }
          }else if(t && t.matches('.btn-edit-purchase')){
            if(!requireEditPermission()) return;
            const id = t.getAttribute('data-id');
            const rec = state.purchases.find(r=>String(r.id)===String(id));
            if(rec){
              editingPurchaseId = rec.id;
              const dEl = document.getElementById('purch-inv-date');
              const sEl = document.getElementById('purch-inv-supplier');
              const aEl = document.getElementById('purch-inv-amount');
              const pEl = document.getElementById('purch-inv-paytype');
              const nEl = document.getElementById('purch-inv-notes');
              if(dEl) dEl.value = rec.date || today();
              if(sEl) sEl.value = rec.supplierId || '';
              if(aEl) aEl.value = String(rec.amount || 0);
              if(pEl) pEl.value = rec.paytype || 'credit';
              if(nEl) nEl.value = rec.notes || '';
              const addBtn = document.querySelector('button[form="form-purch-invoice"]');
              if(addBtn) addBtn.textContent = 'ØªØ­Ø¯ÙŠØ«';
              showPage('page-purch-invoice');
            }
          }
        });
      }
      document.querySelectorAll('.quick-filter[data-report="purch"]').forEach(btn=>{
        btn.addEventListener('click',()=>{
          document.querySelectorAll('.quick-filter[data-report="purch"]').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          const filter = btn.getAttribute('data-filter');
          if(filter!=='custom'){
            const range = getDateRange(filter);
            if(range){
              document.getElementById('purch-report-from').value = range.from;
              document.getElementById('purch-report-to').value = range.to;
              if(requireBranch()){
                const sup = document.getElementById('purch-report-supplier').value;
                const mode = document.getElementById('purch-report-mode').value;
                renderPurchReport(range.from,range.to,sup,mode);
              }
            }
          }
        });
      });
      document.getElementById('purch-report-from').addEventListener('change',()=>{
        document.querySelectorAll('.quick-filter[data-report="purch"]').forEach(b=>{
          if(b.getAttribute('data-filter')==='custom') b.classList.add('active');
          else b.classList.remove('active');
        });
      });
      document.getElementById('purch-report-to').addEventListener('change',()=>{
        document.querySelectorAll('.quick-filter[data-report="purch"]').forEach(b=>{
          if(b.getAttribute('data-filter')==='custom') b.classList.add('active');
          else b.classList.remove('active');
        });
      });

      // supplier statement
      document.getElementById('form-sup-statement').addEventListener('submit',e=>{
        e.preventDefault();
        if(!requireBranch()) return;
        const sup = document.getElementById('stmt-supplier').value;
        const from = document.getElementById('stmt-from').value;
        const to = document.getElementById('stmt-to').value;
        renderSupplierStatement(sup,from,to);
      });

      // suppliers monthly summary
      const supMonthlyBranchEl = document.getElementById('sup-monthly-branch');
      function updateSupMonthlyBranch(){
        if(supMonthlyBranchEl){
          if(!state.currentBranch){
            supMonthlyBranchEl.value = '';
            return;
          }
          supMonthlyBranchEl.value = state.currentBranch === 'HOME' ? (i18n[state.language || 'ar'].homeHouse || 'Home') : state.currentBranch;
        }
      }
      updateSupMonthlyBranch();
      document.getElementById('form-sup-monthly').addEventListener('submit',e=>{
        e.preventDefault();
        if(!requireBranch()) return;
        const m = document.getElementById('sup-monthly-month').value;
        renderSuppliersMonthly(m);
      });

      // cash out
      const cashTypeSelect = document.getElementById('cash-out-type');
      const expenseCategoryWrapper = document.getElementById('expense-category-wrapper');
      const expenseCategorySelect = document.getElementById('expense-category');
      const cashOutSupplierWrapper = document.getElementById('cash-out-supplier-wrapper');
      const cashOutSupplierSelect = document.getElementById('cash-out-supplier');
      if(cashTypeSelect){
        const updateCashOutUI = ()=>{
          const t = cashTypeSelect.value;
          if(t === 'operatingExpense'){
            expenseCategoryWrapper.style.display = '';
            cashOutSupplierWrapper.style.display = 'none';
          }else if(t === 'supplierPayment'){
            expenseCategoryWrapper.style.display = 'none';
            cashOutSupplierWrapper.style.display = '';
          }else{
            expenseCategoryWrapper.style.display = 'none';
            cashOutSupplierWrapper.style.display = 'none';
          }
        };
        cashTypeSelect.addEventListener('change', updateCashOutUI);
        updateCashOutUI();
      }
      document.getElementById('form-cash-out').addEventListener('submit',e=>{
        e.preventDefault();
        if(!requireEditPermission()) return;
        if(!requireBranch()) return;
        if(state.currentBranch==='HOME'){
          showToast('Use HOME pages for home expenses');
          return;
        }
        const date = document.getElementById('cash-date').value;
        let type = cashTypeSelect ? cashTypeSelect.value : 'other';
        const sup = cashOutSupplierSelect ? cashOutSupplierSelect.value : '';
        const category = expenseCategorySelect ? expenseCategorySelect.value : '';
        const amount = num(document.getElementById('cash-amount').value);
        const notes = document.getElementById('cash-note').value||'';
        if(!date || !amount){showToast('Date & amount required');return;}
        if(amount <= 0){
          alert("Ø§Ù„Ù…Ø¨Ù„Øº ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±");
          return;
        }
        if(type === 'ProfitWithdraw'){ type = 'transferToHome'; }
        const currentTreasury = treasuryOfBranch(state.currentBranch);
        if(currentTreasury < amount){
          alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±ØµÙŠØ¯ ÙƒØ§ÙÙ ÙÙŠ Ø§Ù„Ø®Ø²Ù†Ø©");
          return;
        }
        if(type === 'supplierPayment'){
          if(!cashOutSupplierSelect || !cashOutSupplierSelect.value){
            alert("ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù…ÙˆØ±Ø¯ Ø¹Ù†Ø¯ Ø³Ø¯Ø§Ø¯ Ù…ÙˆØ±Ø¯");
            return;
          }
        }
        if(type === 'operatingExpense'){
          if(!expenseCategorySelect || !expenseCategorySelect.value){
            alert("ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ");
            return;
          }
        }
        const record = {
          id: editingCashOutId ? String(editingCashOutId) : String(Date.now()),
          branch: state.currentBranch,
          date,
          type,
          amount,
          notes,
          supplierId: type==='supplierPayment' ? (sup||'') : null,
          expenseCategory: type==='operatingExpense' ? (category||'') : null
        };
        if(editingCashOutId){
          const idx = state.cashMoves.findIndex(x=>String(x.id)===String(editingCashOutId));
          if(idx>=0){
            state.cashMoves[idx] = Object.assign({}, state.cashMoves[idx], record);
          }
          editingCashOutId = null;
        }else{
          state.cashMoves.push(record);
        }
        saveState();
        updateTreasuryLabels();
        renderDashboard();
        if(type === 'transferToHome'){
          renderHomeDashboard();
        }
        const expFromEl = document.getElementById('exp-from');
        const expToEl = document.getElementById('exp-to');
        if(expFromEl && expToEl){
          renderExpensesReport(expFromEl.value, expToEl.value);
        }
        showToast('Cash movement saved');
        e.target.reset();
        setDefaultDates();
        if(cashTypeSelect){
          cashTypeSelect.value = 'operatingExpense';
          const evt = new Event('change');
          cashTypeSelect.dispatchEvent(evt);
        }
      });

      // expenses report
      document.getElementById('form-expenses-report').addEventListener('submit',e=>{
        e.preventDefault();
        if(!requireBranch()) return;
        const from = document.getElementById('exp-from').value;
        const to = document.getElementById('exp-to').value;
        renderExpensesReport(from,to);
      });
      const expTb = document.getElementById('tbl-expenses');
      if(expTb && !expTb.dataset.bound){
        expTb.dataset.bound = 'true';
        expTb.addEventListener('click',(ev)=>{
          const t = ev.target;
          if(t && t.matches('.btn-delete-cashout')){
            if(!requireEditPermission()) return;
            const id = t.getAttribute('data-id');
            const idx = state.cashMoves.findIndex(r=>String(r.id)===String(id));
            if(idx>=0){
              state.cashMoves.splice(idx,1);
              saveState();
              const from = document.getElementById('exp-from').value;
              const to = document.getElementById('exp-to').value;
              renderExpensesReport(from,to);
              updateTreasuryLabels();
              renderDashboard();
            }
          }else if(t && t.matches('.btn-edit-cashout')){
            if(!requireEditPermission()) return;
            const id = t.getAttribute('data-id');
            const rec = state.cashMoves.find(r=>String(r.id)===String(id));
            if(rec){
              editingCashOutId = rec.id;
              const dateEl = document.getElementById('cash-date');
              const amountEl = document.getElementById('cash-amount');
              const notesEl = document.getElementById('cash-note');
              if(dateEl) dateEl.value = rec.date || today();
              if(cashTypeSelect){
                cashTypeSelect.value = rec.type || 'operatingExpense';
                const evt = new Event('change');
                cashTypeSelect.dispatchEvent(evt);
              }
              if(amountEl) amountEl.value = String(rec.amount || 0);
              if(notesEl) notesEl.value = rec.notes || rec.note || '';
              if(rec.type==='supplierPayment'){
                if(cashOutSupplierSelect) cashOutSupplierSelect.value = rec.supplierId || '';
              }else if(rec.type==='operatingExpense'){
                if(expenseCategorySelect) expenseCategorySelect.value = rec.expenseCategory || '';
              }
              showPage('page-cash-out');
            }
          }
        });
      }

      // profit analysis
      document.getElementById('form-profit').addEventListener('submit',e=>{
        e.preventDefault();
        if(!requireBranch()) return;
        const from = document.getElementById('profit-from').value;
        const to = document.getElementById('profit-to').value;
        renderProfit(from,to);
      });
      // users management
      const userForm = document.getElementById('form-user');
      if(userForm && !userForm.dataset.bound){
        userForm.dataset.bound = 'true';
        userForm.addEventListener('submit',e=>{
          e.preventDefault();
          if(!requireEditPermission()) return;
          const unameEl = document.getElementById('user-username');
          const dnameEl = document.getElementById('user-displayName');
          const roleEl = document.getElementById('user-role');
          const activeEl = document.getElementById('user-active');
          const pwdEl = document.getElementById('user-password');
          const uname = unameEl ? unameEl.value.trim() : '';
          const dname = dnameEl ? dnameEl.value.trim() : '';
          const role = roleEl ? roleEl.value : 'cashier';
          const active = activeEl ? !!activeEl.checked : true;
          const pwd = pwdEl ? (pwdEl.value || '') : '';
          if(!uname){ alert('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø·Ù„ÙˆØ¨'); return; }
          if(!dname){ alert('Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¸Ø§Ù‡Ø± Ù…Ø·Ù„ÙˆØ¨'); return; }
          if(!editingUserId){
            const dup = (state.users || []).some(u=>String(u.username||'').toLowerCase() === uname.toLowerCase());
            if(dup){ alert('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„ÙØ¹Ù„'); return; }
            const newUser = {
              id: 'u_' + Date.now(),
              username: uname,
              displayName: dname,
              role: role,
              isActive: active,
              password: pwd || '',
              createdAt: new Date().toISOString()
            };
            state.users.push(newUser);
          }else{
            const idx = state.users.findIndex(u=>String(u.id)===String(editingUserId));
            if(idx>=0){
              const user = state.users[idx];
              user.displayName = dname;
              user.role = role;
              user.isActive = active;
              if(pwd && pwd.trim()!==''){ user.password = pwd.trim(); }
            }
            editingUserId = null;
          }
          saveState();
          renderUsersTable();
          if(pwdEl) pwdEl.value = '';
          if(unameEl) unameEl.disabled = false;
          userForm.reset();
          const resetBtn = document.getElementById('btn-user-reset');
          if(resetBtn) resetBtn.textContent = 'Ø¥Ù„ØºØ§Ø¡';
        });
      }
      const usersTable = document.getElementById('tbl-users');
      if(usersTable && !usersTable.dataset.bound){
        usersTable.dataset.bound = 'true';
        usersTable.addEventListener('click',(ev)=>{
          const t = ev.target;
          if(t && t.matches('.btn-user-edit')){
            const id = t.getAttribute('data-id');
            const u = state.users.find(x=>String(x.id)===String(id));
            if(u){
              editingUserId = u.id;
              const unameEl = document.getElementById('user-username');
              const dnameEl = document.getElementById('user-displayName');
              const roleEl = document.getElementById('user-role');
              const activeEl = document.getElementById('user-active');
              const pwdEl = document.getElementById('user-password');
              if(unameEl) { unameEl.value = u.username || ''; unameEl.disabled = true; }
              if(dnameEl) dnameEl.value = u.displayName || '';
              if(roleEl) roleEl.value = u.role || 'cashier';
              if(activeEl) activeEl.checked = (u.isActive !== false);
              if(pwdEl) pwdEl.value = '';
              showPage('page-users');
            }
          }else if(t && t.matches('.btn-user-toggle')){
            if(!requireEditPermission()) return;
            const id = t.getAttribute('data-id');
            const idx = state.users.findIndex(x=>String(x.id)===String(id));
            if(idx>=0){
              state.users[idx].isActive = !state.users[idx].isActive;
              saveState();
              renderUsersTable();
            }
          }
        });
      }
      const btnUserNew = document.getElementById('btn-user-new');
      if(btnUserNew && !btnUserNew.dataset.bound){
        btnUserNew.dataset.bound = 'true';
        btnUserNew.addEventListener('click',()=>{
          editingUserId = null;
          const unameEl = document.getElementById('user-username');
          const dnameEl = document.getElementById('user-displayName');
          const roleEl = document.getElementById('user-role');
          const activeEl = document.getElementById('user-active');
          const pwdEl = document.getElementById('user-password');
          if(unameEl){ unameEl.value=''; unameEl.disabled=false; }
          if(dnameEl) dnameEl.value='';
          if(roleEl) roleEl.value='cashier';
          if(activeEl) activeEl.checked=true;
          if(pwdEl) pwdEl.value='';
        });
      }
      const resetBtn = document.getElementById('btn-user-reset');
      if(resetBtn && !resetBtn.dataset.bound){
        resetBtn.dataset.bound = 'true';
        resetBtn.addEventListener('click',()=>{
          editingUserId = null;
          const userFormEl = document.getElementById('form-user');
          if(userFormEl) userFormEl.reset();
        });
      }
      // profit filter buttons
      const profitFilterBtns = document.querySelectorAll('.profit-filter-btn');
      const profitPeriodSelect = document.getElementById('profit-period-select');
      let currentProfitPeriodMode = 'weekly';
      function updateProfitPeriodSelect(){
        if(!profitPeriodSelect) return;
        profitPeriodSelect.innerHTML = '';
        const today = new Date();
        if(currentProfitPeriodMode === 'weekly'){
          for(let i=3;i>=0;i--){
            const d = new Date(today);
            d.setDate(d.getDate() - (i*7));
            const weekStart = new Date(d);
            weekStart.setDate(weekStart.getDate() - weekStart.getDay());
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            const opt = document.createElement('option');
            opt.value = weekStart.toISOString().slice(0,10) + '|' + weekEnd.toISOString().slice(0,10);
            opt.textContent = weekStart.toISOString().slice(0,10) + ' - ' + weekEnd.toISOString().slice(0,10);
            if(i===0) opt.selected = true;
            profitPeriodSelect.appendChild(opt);
          }
        }else if(currentProfitPeriodMode === 'monthly'){
          const months = [];
          const allDates = [
            ...state.sales.map(s=>s.date),
            ...state.purchases.map(p=>p.date),
            ...state.cashMoves.map(c=>c.date)
          ].filter(d=>d).sort();
          if(allDates.length){
            const firstDate = new Date(allDates[0]);
            const lastDate = new Date(allDates[allDates.length-1]);
            for(let d = new Date(lastDate.getFullYear(), lastDate.getMonth(), 1); d >= new Date(firstDate.getFullYear(), firstDate.getMonth(), 1); d.setMonth(d.getMonth()-1)){
              const monthStr = d.getFullYear()+'-'+(String(d.getMonth()+1).padStart(2,'0'));
              const monthNames = ['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'];
              const opt = document.createElement('option');
              opt.value = monthStr + '-01|' + monthStr + '-' + new Date(d.getFullYear(), d.getMonth()+1, 0).getDate();
              opt.textContent = monthNames[d.getMonth()] + ' ' + d.getFullYear();
              if(d.getMonth() === today.getMonth() && d.getFullYear() === today.getFullYear()) opt.selected = true;
              profitPeriodSelect.appendChild(opt);
            }
          }
        }else if(currentProfitPeriodMode === 'yearly'){
          const years = new Set();
          [...state.sales.map(s=>s.date),...state.purchases.map(p=>p.date),...state.cashMoves.map(c=>c.date)]
            .filter(d=>d).forEach(d=>years.add(d.slice(0,4)));
          Array.from(years).sort().reverse().forEach(y=>{
            const opt = document.createElement('option');
            opt.value = y+'-01-01|'+y+'-12-31';
            opt.textContent = y;
            if(y === String(today.getFullYear())) opt.selected = true;
            profitPeriodSelect.appendChild(opt);
    });
        }
        if(profitPeriodSelect.options.length > 0){
          const selected = profitPeriodSelect.value.split('|');
          document.getElementById('profit-from').value = selected[0];
          document.getElementById('profit-to').value = selected[1];
        }
      }
      profitFilterBtns.forEach(btn=>{
        btn.addEventListener('click',()=>{
          profitFilterBtns.forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          currentProfitPeriodMode = btn.getAttribute('data-period-mode');
          updateProfitPeriodSelect();
          if(profitPeriodSelect.value){
            const selected = profitPeriodSelect.value.split('|');
            renderProfit(selected[0], selected[1]);
          }
        });
      });
      if(profitPeriodSelect){
        profitPeriodSelect.addEventListener('change',()=>{
          if(profitPeriodSelect.value){
            const selected = profitPeriodSelect.value.split('|');
            document.getElementById('profit-from').value = selected[0];
            document.getElementById('profit-to').value = selected[1];
            renderProfit(selected[0], selected[1]);
          }
        });
      }
      updateProfitPeriodSelect();

      // home beneficiaries
      document.getElementById('form-benef').addEventListener('submit',e=>{
        e.preventDefault();
        const name = document.getElementById('benef-name').value.trim();
        const amount = num(document.getElementById('benef-amount').value);
        if(!name || !amount){showToast('Name & amount required');return;}
        state.beneficiaries.push({id:Date.now(),name,amount});
        saveState();
        renderBeneficiaries();
        e.target.reset();
      });

      // home dashboard month selector
      const homeDashboardMonth = document.getElementById('home-dashboard-month');
      if(homeDashboardMonth){
        homeDashboardMonth.addEventListener('change',()=>{
          renderHomeDashboard();
        });
      }

      // home expenses
      document.getElementById('form-home-exp').addEventListener('submit',e=>{
        e.preventDefault();
        if(!requireEditPermission()) return;
        const date = document.getElementById('home-exp-date').value;
        const bid = document.getElementById('home-exp-benef').value;
        const amount = num(document.getElementById('home-exp-amount').value);
        const note = document.getElementById('home-exp-note').value||'';
        if(!date || !bid || !amount){showToast('Date, beneficiary & amount required');return;}
        const rec = {id: editingHomeExpenseId ? String(editingHomeExpenseId) : String(Date.now()), date, benefId:bid, amount, note};
        if(editingHomeExpenseId){
          const idx = state.homeExpenses.findIndex(x=>String(x.id)===String(editingHomeExpenseId));
          if(idx>=0){ state.homeExpenses[idx] = Object.assign({}, state.homeExpenses[idx], rec); }
          editingHomeExpenseId = null;
        }else{
          state.homeExpenses.push(rec);
        }
        saveState();
        updateTreasuryLabels();
        renderHomeDashboard();
        renderHomeExpensesTable();
        showToast('House expense saved');
        e.target.reset();
        setDefaultDates();
        const addBtn = document.querySelector('button[form="form-home-exp"]');
        if(addBtn) addBtn.textContent = (i18n[state.language || 'ar'].save || 'Save');
      });

      const homeTb = document.getElementById('tbl-home-exp-report');
      if(homeTb && !homeTb.dataset.bound){
        homeTb.dataset.bound = 'true';
        homeTb.addEventListener('click',(ev)=>{
          const t = ev.target;
          if(t && t.matches('.btn-delete-home-exp')){
            if(!requireEditPermission()) return;
            const id = t.getAttribute('data-id');
            if(confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©ØŸ')){
              const idx = state.homeExpenses.findIndex(r=>String(r.id)===String(id));
              if(idx>=0){
                state.homeExpenses.splice(idx,1);
                saveState();
                updateTreasuryLabels();
                renderHomeDashboard();
                renderHomeExpensesTable();
              }
            }
          }else if(t && t.matches('.btn-edit-home-exp')){
            const id = t.getAttribute('data-id');
            const rec = state.homeExpenses.find(r=>String(r.id)===String(id));
            if(rec){
              editingHomeExpenseId = rec.id;
              const dEl = document.getElementById('home-exp-date');
              const bEl = document.getElementById('home-exp-benef');
              const aEl = document.getElementById('home-exp-amount');
              const nEl = document.getElementById('home-exp-note');
              if(dEl) dEl.value = rec.date || today();
              if(bEl) bEl.value = rec.benefId || '';
              if(aEl) aEl.value = String(rec.amount || 0);
              if(nEl) nEl.value = rec.note || '';
              const addBtn = document.querySelector('button[form="form-home-exp"]');
              if(addBtn) addBtn.textContent = 'ØªØ­Ø¯ÙŠØ«';
              showPage('page-home-exp');
            }
          }
        });
      }

      // inventory
      document.getElementById('form-inventory').addEventListener('submit',e=>{
        e.preventDefault();
        if(!requireEditPermission()) return;
        if(!requireBranch()) return;
        if(state.currentBranch==='HOME'){
          showToast('inventoryNotAllowedHome');
          return;
        }
        const month = document.getElementById('inv-month').value;
        const opening = num(document.getElementById('inv-opening').value);
        const closing = num(document.getElementById('inv-closing').value);
        if(!month){showToast('monthRequired');return;}
        const existing = state.inventory.findIndex(x=>x.branch===state.currentBranch && x.month===month);
        if(existing>=0){
          state.inventory[existing].opening = opening;
          state.inventory[existing].closing = closing;
        }else{
          state.inventory.push({
            id:Date.now(),
            branch:state.currentBranch,
            month,
            opening,
            closing
          });
        }
        saveState();
        renderInventory();
        showToast('inventorySaved');
        e.target.reset();
        const minput = document.getElementById('inv-month');
        if(minput && !minput.value){
          minput.value = today().slice(0,7);
        }
      });

      const openingInput = document.getElementById('treasury-opening-input');
      const openingBtn = document.getElementById('treasury-opening-save-btn');
      if(openingBtn && openingInput){
        openingBtn.addEventListener('click',()=>{
          if(!requireEditPermission()) return;
          if(!requireBranch()) return;
          if(isHomeBranch()) return;
          const val = num(openingInput.value);
          ensureTreasuryOpeningEntry(state.currentBranch);
          state.treasuryOpening[state.currentBranch] = val;
          saveState();
          updateTreasuryLabels();
          renderDashboard();
          syncTreasuryOpeningInput();
          showToast('ØªÙ… Ø§Ù„Ø­ÙØ¸');
        });
      }
      syncTreasuryOpeningInput();
    }

    // ========= GLOBAL SEARCH =========
    function globalSearch(query){
      const q = query.toLowerCase();
      const results = {
        suppliers: [],
        sales: [],
        purchases: [],
        returns: [],
        expenses: [],
        homeExpenses: [],
        beneficiaries: []
      };
      if(!state.currentBranch) return results;
      state.suppliers.forEach(s=>{
        const matchName = (s.name || '').toLowerCase().includes(q);
        const matchCode = (s.code || '').toLowerCase().includes(q);
        if(matchName || matchCode) results.suppliers.push(s);
      });
      state.sales.filter(s=>s.branch===state.currentBranch).forEach(s=>{
        const matchNotes = (s.notes || '').toLowerCase().includes(q);
        const matchId = String(s.id || '').includes(q);
        if(matchNotes || matchId) results.sales.push(s);
      });
      state.purchases.filter(p=>p.branch===state.currentBranch).forEach(p=>{
        const sup = state.suppliers.find(s=>String(s.id)===String(p.supplierId));
        const matchSup = sup ? (sup.name || '').toLowerCase().includes(q) : false;
        const matchNotes = (p.notes || '').toLowerCase().includes(q);
        const matchId = String(p.id || '').includes(q);
        if(matchSup || matchNotes || matchId){
          if(p.kind === 'invoice') results.purchases.push(p);
          else results.returns.push(p);
        }
      });
      state.cashMoves.filter(c=>c.branch===state.currentBranch && (c.type==='operatingExpense' || c.type==='Expense')).forEach(c=>{
        const matchType = (c.type || '').toLowerCase().includes(q);
        const matchNote = (c.notes || c.note || '').toLowerCase().includes(q);
        if(matchType || matchNote) results.expenses.push(c);
      });
      state.homeExpenses.forEach(h=>{
        const benef = state.beneficiaries.find(b=>String(b.id)===String(h.benefId));
        const matchBenef = benef ? (benef.name || '').toLowerCase().includes(q) : false;
        const matchNote = (h.note || '').toLowerCase().includes(q);
        if(matchBenef || matchNote) results.homeExpenses.push(h);
      });
      state.beneficiaries.forEach(b=>{
        const matchName = (b.name || '').toLowerCase().includes(q);
        if(matchName) results.beneficiaries.push(b);
      });
      return results;
    }
    function renderSearchResults(results, query){
      const container = document.getElementById('search-results-container');
      container.innerHTML = '';
      const limit = 50;
      const lang = state.language || 'ar';
      if(results.suppliers.length){
        const div = document.createElement('div');
        div.style.marginBottom = '24px';
        div.innerHTML = '<div class="section-title">' + (i18n[lang].suppliers || 'Suppliers') + ' (' + Math.min(results.suppliers.length, limit) + ')</div>';
        if(results.suppliers.length > limit) div.innerHTML += '<p style="font-size:11px;color:#999;">' + (i18n[lang].showingFirst || 'Showing first') + ' ' + limit + ' ' + (i18n[lang].results || 'results') + '</p>';
        const tb = document.createElement('table');
        tb.style.width = '100%';
        tb.style.fontSize = '12px';
        tb.innerHTML = '<thead><tr><th>' + (i18n[lang].name || 'Name') + '</th><th>' + (i18n[lang].code || 'Code') + '</th></tr></thead><tbody></tbody>';
        results.suppliers.slice(0, limit).forEach(s=>{
          const tr = document.createElement('tr');
          tr.innerHTML = '<td>' + (s.name || '') + '</td><td>' + (s.code || '') + '</td>';
          tb.querySelector('tbody').appendChild(tr);
        });
        div.appendChild(tb);
        container.appendChild(div);
      }else{
        const div = document.createElement('div');
        div.style.marginBottom = '24px';
        div.innerHTML = '<div class="section-title">' + (i18n[lang].suppliers || 'Suppliers') + '</div><p style="font-size:11px;color:#999;">' + (i18n[lang].noMatches || 'No matches') + '</p>';
        container.appendChild(div);
      }
      if(results.sales.length){
        const div = document.createElement('div');
        div.style.marginBottom = '24px';
        div.innerHTML = '<div class="section-title">' + (i18n[lang].sales || 'Sales') + ' (' + Math.min(results.sales.length, limit) + ')</div>';
        if(results.sales.length > limit) div.innerHTML += '<p style="font-size:11px;color:#999;">' + (i18n[lang].showingFirst || 'Showing first') + ' ' + limit + ' ' + (i18n[lang].results || 'results') + '</p>';
        const tb = document.createElement('table');
        tb.style.width = '100%';
        tb.style.fontSize = '12px';
        tb.innerHTML = '<thead><tr><th>' + (i18n[lang].date || 'Date') + '</th><th>' + (i18n[lang].amount || 'Amount') + '</th><th>' + (i18n[lang].notes || 'Notes') + '</th><th></th></tr></thead><tbody></tbody>';
        results.sales.slice(0, limit).forEach(s=>{
          const tr = document.createElement('tr');
          tr.innerHTML = '<td>' + (s.date || '') + '</td><td>' + num(s.amount).toFixed(2) + '</td><td>' + (s.notes || '') + '</td><td><button class="btn btn-outline btn-sm" onclick="printInvoice(\'sale\',' + s.id + ')">ğŸ–¨ ' + (i18n[lang].print || 'Print') + '</button></td>';
          tb.querySelector('tbody').appendChild(tr);
        });
        div.appendChild(tb);
        container.appendChild(div);
      }else{
        const div = document.createElement('div');
        div.style.marginBottom = '24px';
        div.innerHTML = '<div class="section-title">' + (i18n[lang].sales || 'Sales') + '</div><p style="font-size:11px;color:#999;">' + (i18n[lang].noMatches || 'No matches') + '</p>';
        container.appendChild(div);
      }
      if(results.purchases.length){
        const div = document.createElement('div');
        div.style.marginBottom = '24px';
        div.innerHTML = '<div class="section-title">' + (i18n[lang].purchases || 'Purchases') + ' (' + Math.min(results.purchases.length, limit) + ')</div>';
        if(results.purchases.length > limit) div.innerHTML += '<p style="font-size:11px;color:#999;">' + (i18n[lang].showingFirst || 'Showing first') + ' ' + limit + ' ' + (i18n[lang].results || 'results') + '</p>';
        const tb = document.createElement('table');
        tb.style.width = '100%';
        tb.style.fontSize = '12px';
        tb.innerHTML = '<thead><tr><th>' + (i18n[lang].date || 'Date') + '</th><th>' + (i18n[lang].supplier || 'Supplier') + '</th><th>' + (i18n[lang].amount || 'Amount') + '</th><th>' + (i18n[lang].notes || 'Notes') + '</th><th></th></tr></thead><tbody></tbody>';
        results.purchases.slice(0, limit).forEach(p=>{
          const sup = state.suppliers.find(s=>String(s.id)===String(p.supplierId));
          const tr = document.createElement('tr');
          tr.innerHTML = '<td>' + (p.date || '') + '</td><td>' + (sup ? sup.name : '') + '</td><td>' + num(p.amount).toFixed(2) + '</td><td>' + (p.notes || '') + '</td><td><button class="btn btn-outline btn-sm" onclick="printInvoice(\'purchase\',' + p.id + ')">ğŸ–¨ ' + (i18n[lang].print || 'Print') + '</button></td>';
          tb.querySelector('tbody').appendChild(tr);
        });
        div.appendChild(tb);
        container.appendChild(div);
      }else{
        const div = document.createElement('div');
        div.style.marginBottom = '24px';
        div.innerHTML = '<div class="section-title">' + (i18n[lang].purchases || 'Purchases') + '</div><p style="font-size:11px;color:#999;">' + (i18n[lang].noMatches || 'No matches') + '</p>';
        container.appendChild(div);
      }
      if(results.returns.length){
        const div = document.createElement('div');
        div.style.marginBottom = '24px';
        div.innerHTML = '<div class="section-title">' + (i18n[lang].returns || 'Returns') + ' (' + Math.min(results.returns.length, limit) + ')</div>';
        if(results.returns.length > limit) div.innerHTML += '<p style="font-size:11px;color:#999;">' + (i18n[lang].showingFirst || 'Showing first') + ' ' + limit + ' ' + (i18n[lang].results || 'results') + '</p>';
        const tb = document.createElement('table');
        tb.style.width = '100%';
        tb.style.fontSize = '12px';
        tb.innerHTML = '<thead><tr><th>' + (i18n[lang].date || 'Date') + '</th><th>' + (i18n[lang].supplier || 'Supplier') + '</th><th>' + (i18n[lang].amount || 'Amount') + '</th><th>' + (i18n[lang].notes || 'Notes') + '</th></tr></thead><tbody></tbody>';
        results.returns.slice(0, limit).forEach(p=>{
          const sup = state.suppliers.find(s=>String(s.id)===String(p.supplierId));
          const tr = document.createElement('tr');
          tr.innerHTML = '<td>' + (p.date || '') + '</td><td>' + (sup ? sup.name : '') + '</td><td>' + num(p.amount).toFixed(2) + '</td><td>' + (p.notes || '') + '</td>';
          tb.querySelector('tbody').appendChild(tr);
        });
        div.appendChild(tb);
        container.appendChild(div);
      }else{
        const div = document.createElement('div');
        div.style.marginBottom = '24px';
        div.innerHTML = '<div class="section-title">' + (i18n[lang].returns || 'Returns') + '</div><p style="font-size:11px;color:#999;">' + (i18n[lang].noMatches || 'No matches') + '</p>';
        container.appendChild(div);
      }
      if(results.expenses.length){
        const div = document.createElement('div');
        div.style.marginBottom = '24px';
        div.innerHTML = '<div class="section-title">' + (i18n[lang].expenses || 'Expenses') + ' (' + Math.min(results.expenses.length, limit) + ')</div>';
        if(results.expenses.length > limit) div.innerHTML += '<p style="font-size:11px;color:#999;">' + (i18n[lang].showingFirst || 'Showing first') + ' ' + limit + ' ' + (i18n[lang].results || 'results') + '</p>';
        const tb = document.createElement('table');
        tb.style.width = '100%';
        tb.style.fontSize = '12px';
        tb.innerHTML = '<thead><tr><th>' + (i18n[lang].date || 'Date') + '</th><th>' + (i18n[lang].type || 'Type') + '</th><th>' + (i18n[lang].amount || 'Amount') + '</th><th>' + (i18n[lang].note || 'Note') + '</th></tr></thead><tbody></tbody>';
        results.expenses.slice(0, limit).forEach(c=>{
          const tr = document.createElement('tr');
          tr.innerHTML = '<td>' + (c.date || '') + '</td><td>' + (c.type || '') + '</td><td>' + num(c.amount).toFixed(2) + '</td><td>' + (c.note || '') + '</td>';
          tb.querySelector('tbody').appendChild(tr);
        });
        div.appendChild(tb);
        container.appendChild(div);
      }else{
        const div = document.createElement('div');
        div.style.marginBottom = '24px';
        div.innerHTML = '<div class="section-title">' + (i18n[lang].expenses || 'Expenses') + '</div><p style="font-size:11px;color:#999;">' + (i18n[lang].noMatches || 'No matches') + '</p>';
        container.appendChild(div);
      }
      if(results.homeExpenses.length){
        const div = document.createElement('div');
        div.style.marginBottom = '24px';
        div.innerHTML = '<div class="section-title">' + (i18n[lang].houseExpenses || 'Home Expenses') + ' (' + Math.min(results.homeExpenses.length, limit) + ')</div>';
        if(results.homeExpenses.length > limit) div.innerHTML += '<p style="font-size:11px;color:#999;">' + (i18n[lang].showingFirst || 'Showing first') + ' ' + limit + ' ' + (i18n[lang].results || 'results') + '</p>';
        const tb = document.createElement('table');
        tb.style.width = '100%';
        tb.style.fontSize = '12px';
        tb.innerHTML = '<thead><tr><th>' + (i18n[lang].date || 'Date') + '</th><th>' + (i18n[lang].beneficiary || 'Beneficiary') + '</th><th>' + (i18n[lang].amount || 'Amount') + '</th><th>' + (i18n[lang].note || 'Note') + '</th></tr></thead><tbody></tbody>';
        results.homeExpenses.slice(0, limit).forEach(h=>{
          const benef = state.beneficiaries.find(b=>String(b.id)===String(h.benefId));
          const tr = document.createElement('tr');
          tr.innerHTML = '<td>' + (h.date || '') + '</td><td>' + (benef ? benef.name : '') + '</td><td>' + num(h.amount).toFixed(2) + '</td><td>' + (h.note || '') + '</td>';
          tb.querySelector('tbody').appendChild(tr);
        });
        div.appendChild(tb);
        container.appendChild(div);
      }else{
        const div = document.createElement('div');
        div.style.marginBottom = '24px';
        div.innerHTML = '<div class="section-title">' + (i18n[lang].houseExpenses || 'Home Expenses') + '</div><p style="font-size:11px;color:#999;">' + (i18n[lang].noMatches || 'No matches') + '</p>';
        container.appendChild(div);
      }
      if(results.beneficiaries.length){
        const div = document.createElement('div');
        div.style.marginBottom = '24px';
        div.innerHTML = '<div class="section-title">' + (i18n[lang].beneficiaries || 'Beneficiaries') + ' (' + Math.min(results.beneficiaries.length, limit) + ')</div>';
        if(results.beneficiaries.length > limit) div.innerHTML += '<p style="font-size:11px;color:#999;">' + (i18n[lang].showingFirst || 'Showing first') + ' ' + limit + ' ' + (i18n[lang].results || 'results') + '</p>';
        const tb = document.createElement('table');
        tb.style.width = '100%';
        tb.style.fontSize = '12px';
        tb.innerHTML = '<thead><tr><th>' + (i18n[lang].name || 'Name') + '</th><th>' + (i18n[lang].amount || 'Amount') + '</th></tr></thead><tbody></tbody>';
        results.beneficiaries.slice(0, limit).forEach(b=>{
          const tr = document.createElement('tr');
          tr.innerHTML = '<td>' + (b.name || '') + '</td><td>' + num(b.amount).toFixed(2) + '</td>';
          tb.querySelector('tbody').appendChild(tr);
        });
        div.appendChild(tb);
        container.appendChild(div);
      }else{
        const div = document.createElement('div');
        div.style.marginBottom = '24px';
        div.innerHTML = '<div class="section-title">' + (i18n[lang].beneficiaries || 'Beneficiaries') + '</div><p style="font-size:11px;color:#999;">' + (i18n[lang].noMatches || 'No matches') + '</p>';
        container.appendChild(div);
      }

      const setCompanyEl = document.getElementById('settings-company-name');
      const setAppEl = document.getElementById('settings-app-name');
      const setPreviewEl = document.getElementById('settings-identity-preview');
      const setLogoEl = document.getElementById('settings-logo-url');
      const setLogoPrev = document.getElementById('settings-logo-preview');
      const setThemeInputs = document.querySelectorAll('input[name="settings-theme"]');
      const setLangInputs = document.querySelectorAll('input[name="settings-lang"]');
      const setLimitEl = document.getElementById('settings-treasury-limit');
      const setSaveBtn = document.getElementById('settings-save-btn');
      const setResetBtn = document.getElementById('settings-reset-btn');
      const s = state.settings || {};
      if(setCompanyEl) setCompanyEl.value = s.companyName || '';
      if(setAppEl) setAppEl.value = s.appName || '';
      if(setPreviewEl) setPreviewEl.textContent = (s.appName || 'Pharma Financial Suite') + ' - ' + (s.companyName || 'Dr. Magdy Hemdan Pharmacies');
      if(setLogoEl) setLogoEl.value = s.logoUrl || '';
      if(setLogoPrev) setLogoPrev.src = s.logoUrl || getLogoUrl();
      if(setLimitEl) setLimitEl.value = (typeof s.treasuryWarningLimit === 'number') ? s.treasuryWarningLimit : 200;
      if(setThemeInputs){
        setThemeInputs.forEach(r=>{ r.checked = (s.theme || 'light') === r.value; });
      }
      if(setLangInputs){
        setLangInputs.forEach(r=>{ r.checked = (s.language || state.language || 'ar') === r.value; });
      }
      const updatePreview = ()=>{
        if(setPreviewEl){
          const appName = setAppEl ? (setAppEl.value || 'Pharma Financial Suite') : 'Pharma Financial Suite';
          const companyName = setCompanyEl ? (setCompanyEl.value || 'Dr. Magdy Hemdan Pharmacies') : 'Dr. Magdy Hemdan Pharmacies';
          setPreviewEl.textContent = appName + ' - ' + companyName;
        }
      };
      if(setCompanyEl) setCompanyEl.addEventListener('input', updatePreview);
      if(setAppEl) setAppEl.addEventListener('input', updatePreview);
      if(setLogoEl) setLogoEl.addEventListener('input', ()=>{
        if(setLogoPrev) setLogoPrev.src = setLogoEl.value || getLogoUrl();
      });
      if(setThemeInputs){
        setThemeInputs.forEach(r=>{
          r.addEventListener('change',()=>{
            applyTheme(r.value);
          });
        });
      }
      if(setLangInputs){
        setLangInputs.forEach(r=>{
          r.addEventListener('change',()=>{
            const lang = r.value;
            state.settings.language = lang;
            state.language = lang;
            applyLanguage(lang);
          });
        });
      }
      if(setSaveBtn){
        setSaveBtn.addEventListener('click',()=>{
          state.settings.companyName = setCompanyEl ? setCompanyEl.value.trim() : '';
          state.settings.appName = setAppEl ? setAppEl.value.trim() : '';
          state.settings.logoUrl = setLogoEl ? setLogoEl.value.trim() : '';
          state.settings.theme = (document.querySelector('input[name="settings-theme"]:checked')?.value) || 'light';
          state.settings.language = (document.querySelector('input[name="settings-lang"]:checked')?.value) || (state.language || 'ar');
          state.language = state.settings.language;
          state.settings.treasuryWarningLimit = setLimitEl ? num(setLimitEl.value) : 200;
          saveState();
          applyLanguage(state.language);
          applyTheme(state.settings.theme);
          applySettingsVisuals();
          showToast('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª');
        });
      }
      if(setResetBtn){
        setResetBtn.addEventListener('click',()=>{
          state.settings = {
            companyName: '',
            appName: '',
            logoUrl: '',
            language: 'ar',
            theme: 'light',
            treasuryWarningLimit: 200
          };
          state.language = 'ar';
          saveState();
          applyLanguage('ar');
          applyTheme('light');
          applySettingsVisuals();
          if(setCompanyEl) setCompanyEl.value = '';
          if(setAppEl) setAppEl.value = '';
          if(setLogoEl) setLogoEl.value = '';
          if(setLogoPrev) setLogoPrev.src = getLogoUrl();
          if(setLimitEl) setLimitEl.value = 200;
          setThemeInputs.forEach(r=>{ r.checked = r.value==='light'; });
          setLangInputs.forEach(r=>{ r.checked = r.value==='ar'; });
          updatePreview();
          showToast('ØªÙ… Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©');
        });
      }
    }

    // ========= RENDERERS =========
    function renderSalesReport(from,to,mode){
      const tb = document.getElementById('tbl-sales-report');
      tb.innerHTML = '';
      const list = state.sales
        .filter(s=>s.branch===state.currentBranch)
        .filter(s=>!from || s.date>=from)
        .filter(s=>!to || s.date<=to);
      if(!list.length){
        const tr = document.createElement('tr');
        tr.innerHTML='<td colspan="4">' + (i18n[state.language || 'ar'].noSalesInPeriod || 'No sales in this period.') + '</td>';
        tb.appendChild(tr);
        return;
      }
      mode = mode || 'detail';
      let total = 0;
      if(mode==='daily'){
        const groups = {};
        list.forEach(s=>{
          if(!groups[s.date]) groups[s.date]=0;
          groups[s.date]+=num(s.amount);
        });
        Object.keys(groups).sort().forEach(d=>{
          const val = groups[d];
          total+=val;
          const tr = document.createElement('tr');
          tr.innerHTML='<td>'+d+'</td><td>'+val.toFixed(2)+'</td><td>Daily total</td><td></td>';
          tb.appendChild(tr);
        });
      }else if(mode==='monthly'){
        const groups = {};
        list.forEach(s=>{
          const ym = s.date.slice(0,7);
          if(!groups[ym]) groups[ym]=0;
          groups[ym]+=num(s.amount);
        });
        Object.keys(groups).sort().forEach(m=>{
          const val = groups[m];
          total+=val;
          const tr = document.createElement('tr');
          tr.innerHTML='<td>'+m+'</td><td>'+val.toFixed(2)+'</td><td>'+ (i18n[state.language || 'ar'].monthlyTotal || 'Monthly total') + '</td><td></td>';
          tb.appendChild(tr);
        });
      }else{
        list.sort((a,b)=>a.date.localeCompare(b.date)).forEach(s=>{
          total+=num(s.amount);
          const tr = document.createElement('tr');
          const actions = '<button class="btn-xs btn-edit-sale" data-id="'+s.id+'">ØªØ¹Ø¯ÙŠÙ„</button>\n<button class="btn-xs btn-delete-sale" data-id="'+s.id+'">Ø­Ø°Ù</button>\n<button class="btn btn-outline btn-sm" onclick="printInvoice(\'sale\','+s.id+')">ğŸ–¨ ' + (i18n[state.language || 'ar'].print || 'Print') + '</button>';
          tr.innerHTML='<td>'+s.date+'</td><td>'+s.amount.toFixed(2)+'</td><td>'+(s.notes||'')+'</td><td>'+actions+'</td>';
          tb.appendChild(tr);
        });
      }
      const tr = document.createElement('tr');
      tr.innerHTML='<th>' + (i18n[state.language || 'ar'].total || 'Total') + '</th><th>'+total.toFixed(2)+'</th><th></th><th></th>';
      tb.appendChild(tr);
    }

    function renderPurchReport(from,to,sup,mode){
      const tb = document.getElementById('tbl-purch-report');
      tb.innerHTML='';
      const base = state.purchases
        .filter(p=>p.branch===state.currentBranch)
        .filter(p=>!from || p.date>=from)
        .filter(p=>!to || p.date<=to)
        .filter(p=>!sup || String(p.supplierId)===String(sup));
      if(!base.length){
        const tr = document.createElement('tr');
        tr.innerHTML='<td colspan="6">No purchases in this period.</td>';
        tb.appendChild(tr);
        return;
      }
      mode = mode || 'detail';
      let totalNet = 0;
      if(mode==='daily'){
        const groups={};
        base.forEach(p=>{
          const d = p.date;
          if(!groups[d]) groups[d]={inv:0,ret:0};
          if(p.kind==='invoice') groups[d].inv+=num(p.amount);
          else groups[d].ret+=num(p.amount);
        });
        Object.keys(groups).sort().forEach(d=>{
          const g = groups[d];
          const net = g.inv-g.ret;
          totalNet+=net;
          const tr=document.createElement('tr');
          tr.innerHTML='<td>'+d+'</td><td>'+ (sup? supplierName(sup):(i18n[state.language || 'ar'].all || 'All')) +'</td><td>'+g.inv.toFixed(2)+'</td><td>'+g.ret.toFixed(2)+'</td><td>'+net.toFixed(2)+'</td><td></td>';
          tb.appendChild(tr);
        });
      }else if(mode==='monthly'){
        const groups={};
        base.forEach(p=>{
          const ym = p.date.slice(0,7);
          if(!groups[ym]) groups[ym]={inv:0,ret:0};
          if(p.kind==='invoice') groups[ym].inv+=num(p.amount);
          else groups[ym].ret+=num(p.amount);
        });
        Object.keys(groups).sort().forEach(m=>{
          const g = groups[m];
          const net = g.inv-g.ret;
          totalNet+=net;
          const tr=document.createElement('tr');
          tr.innerHTML='<td>'+m+'</td><td>'+ (sup? supplierName(sup):(i18n[state.language || 'ar'].all || 'All')) +'</td><td>'+g.inv.toFixed(2)+'</td><td>'+g.ret.toFixed(2)+'</td><td>'+net.toFixed(2)+'</td><td></td>';
          tb.appendChild(tr);
        });
      }else{
        const groups={};
        const detailPurchases = [];
        base.forEach(p=>{
          const key = p.date+'|'+String(p.supplierId||'');
          if(!groups[key]) groups[key]={date:p.date,supplierId:p.supplierId,inv:0,ret:0,invId:null};
          if(p.kind==='invoice'){
            groups[key].inv+=num(p.amount);
            if(!groups[key].invId) groups[key].invId = p.id;
          }else groups[key].ret+=num(p.amount);
        });
        Object.values(groups).sort((a,b)=>a.date.localeCompare(b.date)).forEach(g=>{
          const net = g.inv-g.ret;
          totalNet+=net;
          const tr=document.createElement('tr');
          const printBtn = g.invId ? '<button class="btn btn-outline btn-sm" onclick="printInvoice(\'purchase\','+g.invId+')">ğŸ–¨ ' + (i18n[state.language || 'ar'].print || 'Print') + '</button>' : '';
          const actions = g.invId ? ('<button class="btn-xs btn-edit-purchase" data-id="'+g.invId+'">ØªØ¹Ø¯ÙŠÙ„</button>\n<button class="btn-xs btn-delete-purchase" data-id="'+g.invId+'">Ø­Ø°Ù</button>\n' + printBtn) : '';
          tr.innerHTML='<td>'+g.date+'</td><td>'+supplierName(g.supplierId)+'</td><td>'+g.inv.toFixed(2)+'</td><td>'+g.ret.toFixed(2)+'</td><td>'+net.toFixed(2)+'</td><td>'+actions+'</td>';
          tb.appendChild(tr);
        });
      }
      const tr=document.createElement('tr');
      tr.innerHTML='<th>Total Net Purchases</th><th></th><th></th><th></th><th>'+totalNet.toFixed(2)+'</th><th></th>';
      tb.appendChild(tr);
    }

    function renderHomeExpensesTable(){
      const tb = document.getElementById('tbl-home-exp-report');
      if(!tb) return;
      tb.innerHTML = '';
      const list = (state.homeExpenses || []).slice().sort((a,b)=>{
        if(!a.date) return 1; if(!b.date) return -1; return a.date.localeCompare(b.date);
      });
      if(!list.length){
        const tr=document.createElement('tr');
        tr.innerHTML='<td colspan="5" style="text-align:center;color:#999;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª Ù…Ù†Ø²Ù„ÙŠØ©</td>';
        tb.appendChild(tr);
        return;
      }
      list.forEach(h=>{
        const benef = state.beneficiaries.find(b=>String(b.id)===String(h.benefId));
        const actions = '<button class="btn-xs btn-edit-home-exp" data-id="'+h.id+'">ØªØ¹Ø¯ÙŠÙ„</button>\n<button class="btn-xs btn-delete-home-exp" data-id="'+h.id+'">Ø­Ø°Ù</button>';
        const tr=document.createElement('tr');
        tr.innerHTML = '<td>'+(h.date||'')+'</td><td>'+(benef?benef.name:'')+'</td><td>'+num(h.amount).toFixed(2)+'</td><td>'+(h.note||'')+'</td><td>'+actions+'</td>';
        tb.appendChild(tr);
      });
    }

    // ========= PRINT INVOICE =========
    function buildPrintHeader(title, branchName, dateRangeText){
      const settings = state.settings || {};
      const appName = settings.appName || 'Pharma Financial Suite';
      const companyName = settings.companyName || 'Dr. Magdy Hemdan Pharmacies';
      const logoUrl = settings.logoUrl || 'logo.png';
      return (
        '<div class="print-header">'
        + '<div class="print-header-left">'
        + '<img src="'+logoUrl+'" class="print-logo" alt="Logo" />'
        + '</div>'
        + '<div class="print-header-center">'
        + '<h1 class="print-app-name">'+appName+'</h1>'
        + '<div class="print-company-name">'+companyName+'</div>'
        + '<div class="print-report-title">'+(title||'')+'</div>'
        + (dateRangeText ? ('<div class="print-dates">'+dateRangeText+'</div>') : '')
        + '</div>'
        + '<div class="print-header-right">'
        + '<div class="print-branch">Ø§Ù„ÙØ±Ø¹: '+(branchName || (state.currentBranch && state.currentBranch.name) || '')+'</div>'
        + '<div class="print-date">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©: '+new Date().toLocaleString()+'</div>'
        + '</div>'
        + '</div>'
      );
    }

    function printInvoice(type, id){
      let record = null;
      let html = '';
      let body = '';
      let title = '';
      let branch = '';
      if(type === 'sale'){
        record = state.sales.find(s=>String(s.id)===String(id));
        if(!record) {showToast('Sale not found');return;}
        branch = record.branch || state.currentBranch || 'N/A';
        title = 'ÙØ§ØªÙˆØ±Ø© Ø¨ÙŠØ¹';
        body += '<table class="print-table">';
        body += '<thead><tr><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead><tbody>';
        body += '<tr><td>Ù‚ÙŠÙ…Ø© Ø§Ù„Ø¨ÙŠØ¹</td><td>' + num(record.amount).toFixed(2) + '</td></tr>';
        if(record.notes) body += '<tr><td>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</td><td>' + record.notes + '</td></tr>';
        body += '</tbody></table>';
        body += '<div style="text-align:right;margin-top:10px;font-weight:600;">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: ' + num(record.amount).toFixed(2) + '</div>';
      }else if(type === 'purchase'){
        record = state.purchases.find(p=>String(p.id)===String(id));
        if(!record) {showToast('Purchase not found');return;}
        const returns = state.purchases.filter(p=>p.branch===record.branch && p.supplierId===record.supplierId && p.kind==='return' && p.date===record.date);
        const returnsTotal = returns.reduce((a,p)=>a+num(p.amount),0);
        const netAmount = num(record.amount) - returnsTotal;
        const sup = state.suppliers.find(s=>String(s.id)===String(record.supplierId));
        branch = record.branch || state.currentBranch || 'N/A';
        title = 'ÙØ§ØªÙˆØ±Ø© Ù…Ø´ØªØ±ÙŠØ§Øª';
        body += '<table class="print-table">';
        body += '<thead><tr><th>Ø§Ù„ÙˆØµÙ</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th></tr></thead><tbody>';
        body += '<tr><td>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</td><td>' + num(record.amount).toFixed(2) + '</td></tr>';
        if(returnsTotal>0) body += '<tr><td>Ù…Ø±ØªØ¬Ø¹Ø§Øª</td><td>-' + returnsTotal.toFixed(2) + '</td></tr>';
        body += '<tr><td><strong>ØµØ§ÙÙŠ</strong></td><td><strong>' + netAmount.toFixed(2) + '</strong></td></tr>';
        if(record.notes) body += '<tr><td>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</td><td>' + record.notes + '</td></tr>';
        body += '</tbody></table>';
        body += '<div style="text-align:right;margin-top:10px;font-weight:600;">Ø§Ù„ØµØ§ÙÙŠ: ' + netAmount.toFixed(2) + '</div>';
      }
      html += '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Print</title>';
      html += '<style>@media print{body{margin:0;padding:20px;background:#fff;font-family:system-ui,sans-serif;}table{width:100%;border-collapse:collapse;}th,td{border:1px solid #ddd;padding:6px;text-align:center;}}</style>';
      html += '</head><body>';
      html += buildPrintHeader(title, branch, '');
      html += body;
      html += '</body></html>';
      const w = window.open('', '_blank');
      if(!w) return;
      w.document.open();
      w.document.write(html);
      w.document.close();
      w.focus();
      w.print();
    }

    function printCurrentPage(){
      const currentPage = document.querySelector('.page:not(.hidden)');
      if(!currentPage) return;
      const clone = currentPage.cloneNode(true);
      let html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><title>Print</title>';
      html += '<style>@media print{body{margin:0;padding:20px;background:#fff;font-family:system-ui,sans-serif;}table{width:100%;border-collapse:collapse;}th,td{border:1px solid #ddd;padding:6px;text-align:center;}}</style>';
      html += '</head><body>';
      const title = currentPage.querySelector('.page-header h2') ? currentPage.querySelector('.page-header h2').textContent : document.title;
      const branchName = (state && state.currentBranch && state.currentBranch.name) || '';
      html += buildPrintHeader(title, branchName, '');
      html += clone.innerHTML;
      html += '</body></html>';
      const w = window.open('', '_blank');
      if(!w) return;
      w.document.open();
      w.document.write(html);
      w.document.close();
      w.focus();
      w.print();
    }

    function renderSupplierStatement(supId,from,to){
      const tb = document.getElementById('tbl-sup-statement');
      tb.innerHTML='';
      if(!supId){
        const tr=document.createElement('tr');
        tr.innerHTML='<td colspan="4">Choose supplier first.</td>';
        tb.appendChild(tr);
        return;
      }
      const rows=[];
      state.purchases.filter(p=>String(p.supplierId)===String(supId) && p.branch===state.currentBranch)
        .filter(p=>!from||p.date>=from)
        .filter(p=>!to||p.date<=to)
        .forEach(p=>{
          rows.push({
            date:p.date,
            type:p.kind==='invoice'?'ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡':'Ù…Ø±ØªØ¬Ø¹ Ø´Ø±Ø§Ø¡',
            amount: p.kind==='invoice'? num(p.amount): -num(p.amount),
            note:p.notes||''
          });
        });
      state.cashMoves.filter(c=>String(c.supplierId)===String(supId) && c.branch===state.currentBranch && (c.type==='supplierPayment' || c.type==='SupplierPayment'))
        .filter(c=>!from||c.date>=from)
        .filter(c=>!to||c.date<=to)
        .forEach(c=>{
          rows.push({
            date:c.date,
            type:'Ø³Ø¯Ø§Ø¯ Ù…ÙˆØ±Ø¯',
            amount:-num(c.amount),
            note:c.notes||c.note||''
          });
        });
      if(!rows.length){
        const tr=document.createElement('tr');
        tr.innerHTML='<td colspan="4">No movements in this period.</td>';
        tb.appendChild(tr);
        return;
      }
      rows.sort((a,b)=>a.date.localeCompare(b.date));
      rows.forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML='<td>'+r.date+'</td><td>'+r.type+'</td><td>'+r.amount.toFixed(2)+'</td><td>'+(r.note||'')+'</td>';
        tb.appendChild(tr);
      });
    }

    function renderSuppliersMonthly(monthStr){
      const tb = document.getElementById('tbl-sup-monthly');
      tb.innerHTML='';
      if(!monthStr){
        const tr=document.createElement('tr');
        tr.innerHTML='<td colspan="6">Choose month.</td>';
        tb.appendChild(tr);
        return;
      }
      const [y,m] = monthStr.split('-');
      const prefix = y+'-'+m+'-';
      const startDate = y+'-'+m+'-01';

      let totalOpening=0,totalInv=0,totalRet=0,totalPay=0,totalRemain=0;

      state.suppliers.forEach(s=>{
        const id = s.id;
        const openingBase = num(s.opening);

        const prevPurch = state.purchases
          .filter(p=>p.branch===state.currentBranch && String(p.supplierId)===String(id))
          .filter(p=>p.date && p.date<startDate);
        let prevNet=0;
        prevPurch.forEach(p=>{
          if(p.kind==='invoice') prevNet+=num(p.amount);
          else prevNet-=num(p.amount);
        });

        const prevPay = state.cashMoves
          .filter(c=>c.branch===state.currentBranch && (c.type==='supplierPayment' || c.type==='SupplierPayment') && String(c.supplierId)===String(id))
          .filter(c=>c.date && c.date<startDate)
          .reduce((a,c)=>a+num(c.amount),0);

        const opening = openingBase + prevNet - prevPay;

        const monthPurch = state.purchases
          .filter(p=>p.branch===state.currentBranch && String(p.supplierId)===String(id))
          .filter(p=>p.date && p.date.startsWith(prefix));
        let inv=0,ret=0;
        monthPurch.forEach(p=>{
          if(p.kind==='invoice') inv+=num(p.amount);
          else ret+=num(p.amount);
        });

        const monthPay = state.cashMoves
          .filter(c=>c.branch===state.currentBranch && (c.type==='supplierPayment' || c.type==='SupplierPayment') && String(c.supplierId)===String(id))
          .filter(c=>c.date && c.date.startsWith(prefix))
          .reduce((a,c)=>a+num(c.amount),0);

        const remain = opening + (inv-ret) - monthPay;

        if(Math.abs(opening)<0.001 && Math.abs(inv)<0.001 && Math.abs(ret)<0.001 && Math.abs(monthPay)<0.001){
          return;
        }

        totalOpening+=opening;
        totalInv+=inv;
        totalRet+=ret;
        totalPay+=monthPay;
        totalRemain+=remain;

        const tr=document.createElement('tr');
        tr.innerHTML='<td>'+s.name+'</td><td>'+opening.toFixed(2)+'</td><td>'+inv.toFixed(2)+'</td><td>'+ret.toFixed(2)+'</td><td>'+monthPay.toFixed(2)+'</td><td>'+remain.toFixed(2)+'</td>';
        tb.appendChild(tr);
      });

      if(!tb.children.length){
        const tr=document.createElement('tr');
        tr.innerHTML='<td colspan="6">No data for this month.</td>';
        tb.appendChild(tr);
        return;
      }

      const tr=document.createElement('tr');
      tr.innerHTML='<th>Total</th><th>'+totalOpening.toFixed(2)+'</th><th>'+totalInv.toFixed(2)+'</th><th>'+totalRet.toFixed(2)+'</th><th>'+totalPay.toFixed(2)+'</th><th>'+totalRemain.toFixed(2)+'</th>';
      tb.appendChild(tr);
    }

    function renderExpensesReport(from,to){
      const tb = document.getElementById('tbl-expenses');
      tb.innerHTML='';
      const list = state.cashMoves
        .filter(c=>c.branch===state.currentBranch && (
          c.type==='operatingExpense' || c.type==='supplierPayment' || c.type==='transferToHome' ||
          c.type==='Expense' || c.type==='SupplierPayment' || c.type==='TransferToHome' || c.type==='ProfitWithdraw'
        ))
        .filter(c=>!from || c.date>=from)
        .filter(c=>!to || c.date<=to);
      if(!list.length){
        const tr=document.createElement('tr');
        tr.innerHTML='<td colspan="6">' + (i18n[state.language || 'ar'].noExpenses || 'No expenses.') + '</td>';
        tb.appendChild(tr);
        return;
      }
      let sum=0;
      list.sort((a,b)=>a.date.localeCompare(b.date)).forEach(c=>{
        sum+=num(c.amount);
        const tr=document.createElement('tr');
        let typeLabel = 'Ø£Ø®Ø±Ù‰';
        const t = c.type;
        if(t==='operatingExpense' || t==='Expense') typeLabel = 'Ù…ØµØ±ÙˆÙØ§Øª ØªØ´ØºÙŠÙ„ÙŠØ©';
        else if(t==='supplierPayment' || t==='SupplierPayment') typeLabel = 'Ø³Ø¯Ø§Ø¯ Ù…ÙˆØ±Ø¯';
        else if(t==='transferToHome' || t==='TransferToHome' || t==='ProfitWithdraw') typeLabel = 'ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ù…Ù†Ø²Ù„ (Ø³Ø­Ø¨ Ø£Ø±Ø¨Ø§Ø­)';
        let displayText = 'â€”';
        if((t==='supplierPayment' || t==='SupplierPayment') && c.supplierId){
          displayText = getSupplierNameById(c.supplierId) || 'â€”';
        } else if((t==='operatingExpense' || t==='Expense') && c.expenseCategory){
          switch(c.expenseCategory){
            case 'electricity': displayText = 'ÙƒÙ‡Ø±Ø¨Ø§Ø¡'; break;
            case 'rent': displayText = 'Ø¥ÙŠØ¬Ø§Ø±'; break;
            case 'salary': displayText = 'Ù…Ø±ØªØ¨'; break;
            case 'maintenance': displayText = 'ØµÙŠØ§Ù†Ø©'; break;
            case 'other': displayText = 'Ø£Ø®Ø±Ù‰'; break;
            default: displayText = c.expenseCategory;
          }
        }
        const actions = '<button class="btn-xs btn-edit-cashout" data-id="'+c.id+'">ØªØ¹Ø¯ÙŠÙ„</button>\n<button class="btn-xs btn-delete-cashout" data-id="'+c.id+'">Ø­Ø°Ù</button>';
        tr.innerHTML='<td>'+c.date+'</td><td>'+typeLabel+'</td><td>'+num(c.amount).toFixed(2)+'</td><td>'+displayText+'</td><td>'+(c.notes||c.note||'')+'</td><td>'+actions+'</td>';
        tb.appendChild(tr);
      });
      const tr=document.createElement('tr');
      tr.innerHTML='<th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th></th><th>'+sum.toFixed(2)+'</th><th></th><th></th><th></th>';
      tb.appendChild(tr);
    }

    function getInventoryForDate(branch, targetDate){
      if(!branch || !targetDate) return null;
      const branchInv = state.inventory.filter(x=>x.branch===branch);
      if(!branchInv.length) return null;
      const targetMonth = targetDate.slice(0,7);
      const candidates = branchInv.filter(x=>x.month<=targetMonth);
      if(!candidates.length) return null;
      candidates.sort((a,b)=>b.month.localeCompare(a.month));
      return candidates[0];
    }

    function renderProfit(from,to){
      const tb = document.getElementById('tbl-profit');
      tb.innerHTML='';
      const sales = state.sales
        .filter(s=>s.branch===state.currentBranch)
        .filter(s=>!from||s.date>=from)
        .filter(s=>!to||s.date<=to)
        .reduce((a,s)=>a+num(s.amount),0);
      const purchasesInv = state.purchases
        .filter(p=>p.branch===state.currentBranch && p.kind==='invoice')
        .filter(p=>!from||p.date>=from)
        .filter(p=>!to||p.date<=to)
        .reduce((a,p)=>a+num(p.amount),0);
      const purchasesRet = state.purchases
        .filter(p=>p.branch===state.currentBranch && p.kind==='return')
        .filter(p=>!from||p.date>=from)
        .filter(p=>!to||p.date<=to)
        .reduce((a,p)=>a+num(p.amount),0);
      const netPurch = purchasesInv - purchasesRet;
      const expenses = state.cashMoves
        .filter(c=>c.branch===state.currentBranch && (c.type==='operatingExpense' || c.type==='Expense'))
        .filter(c=>!from||c.date>=from)
        .filter(c=>!to||c.date<=to)
        .reduce((a,c)=>a+num(c.amount),0);
      const withdrawnProfit = state.cashMoves
        .filter(c=>c.branch===state.currentBranch && (c.type==='transferToHome' || c.type==='TransferToHome' || c.type==='ProfitWithdraw'))
        .filter(c=>!from||c.date>=from)
        .filter(c=>!to||c.date<=to)
        .reduce((a,c)=>a+num(c.amount),0);

      const gross = sales - netPurch;
      const netOperatingProfit = gross - expenses;
      const retainedProfit = netOperatingProfit - withdrawnProfit;

      const openingInv = getInventoryForDate(state.currentBranch, from);
      const closingInv = getInventoryForDate(state.currentBranch, to);
      const openingStock = openingInv ? num(openingInv.opening) : 0;
      const closingStock = closingInv ? num(closingInv.closing) : 0;
      const stockDifference = closingStock - openingStock;
      const adjustedProfit = gross + stockDifference;
      const adjustedNetOperatingProfit = adjustedProfit - expenses;
      const adjustedRetainedProfit = adjustedNetOperatingProfit - withdrawnProfit;

      const lang = state.language || 'ar';
      const rows=[
        [i18n[lang].salesCol || 'Sales',sales],
        [i18n[lang].netPurchasesInvoicesReturns || 'Net Purchases (Invoices - Returns)',netPurch],
        [i18n[lang].grossProfit || 'Gross Profit',gross],
        [i18n[lang].openingStock || 'Opening Stock',openingStock],
        [i18n[lang].closingStock || 'Closing Stock',closingStock],
        [i18n[lang].stockDifference || 'Stock Difference',stockDifference],
        [i18n[lang].adjustedProfit || 'Adjusted Profit',adjustedProfit],
        [i18n[lang].operatingExpenses || 'Operating Expenses',expenses],
        [i18n[lang].netOperatingProfit || 'Net Operating Profit',adjustedNetOperatingProfit],
        [i18n[lang].withdrawnProfit || 'Withdrawn Profit to Home',withdrawnProfit],
        [i18n[lang].retainedProfit || 'Retained Profit in Branch',adjustedRetainedProfit]
      ];
      rows.forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML='<td>'+r[0]+'</td><td>'+r[1].toFixed(2)+'</td>';
        tb.appendChild(tr);
      });
    }

    function renderUsersTable(){
      const tb = document.querySelector('#tbl-users tbody');
      if(!tb) return;
      tb.innerHTML = '';
      const list = (state.users || []).slice();
      if(!list.length){
        const tr=document.createElement('tr');
        tr.innerHTML = '<td colspan="6" style="text-align:center;color:#999;">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ†</td>';
        tb.appendChild(tr);
        return;
      }
      const roleLabel = (r)=> r==='admin' ? 'Ù…Ø¯ÙŠØ±' : (r==='cashier' ? 'ÙƒØ§Ø´ÙŠØ±' : 'Ø¹Ø±Ø¶ ÙÙ‚Ø·');
      list.forEach(u=>{
        const tr=document.createElement('tr');
        const createdShort = (u.createdAt||'').slice(0,10);
        const status = u.isActive ? 'Ù…ÙØ¹Ù„' : 'Ù…ÙˆÙ‚ÙˆÙ';
        const actions = '<button class="btn-xs btn-user-edit" data-id="'+u.id+'">ØªØ¹Ø¯ÙŠÙ„</button>\n<button class="btn-xs btn-user-toggle" data-id="'+u.id+'">ØªÙØ¹ÙŠÙ„/Ø¥ÙŠÙ‚Ø§Ù</button>';
        tr.innerHTML = '<td>'+ (u.username||'') +'</td><td>'+ (u.displayName||'') +'</td><td>'+ roleLabel(u.role||'viewer') +'</td><td>'+ status +'</td><td>'+ createdShort +'</td><td>'+ actions +'</td>';
        tb.appendChild(tr);
      });
    }

    function renderBeneficiaries(){
      const tb = document.getElementById('tbl-benef');
      const sel = document.getElementById('home-exp-benef');
      tb.innerHTML='';
      sel.innerHTML='<option value="">Choose</option>';
      state.beneficiaries.forEach(b=>{
        const tr=document.createElement('tr');
        tr.innerHTML='<td>'+b.name+'</td><td>'+b.amount.toFixed(2)+'</td>';
        tb.appendChild(tr);
        const opt=document.createElement('option');
        opt.value=b.id;
        opt.textContent=b.name;
        sel.appendChild(opt);
      });
    }

    function renderInventory(){
      const tb = document.getElementById('tbl-inventory');
      if(!tb) return;
      tb.innerHTML='';
      if(!state.currentBranch || state.currentBranch==='HOME'){
        const tr=document.createElement('tr');
        const msg = i18n[state.language || 'ar'].chooseBranchFirst || 'Choose a branch first.';
        tr.innerHTML='<td colspan="5">'+msg+'</td>';
        tb.appendChild(tr);
        return;
      }
      const list = state.inventory
        .filter(x=>x.branch===state.currentBranch)
        .sort((a,b)=>a.month.localeCompare(b.month));
      if(!list.length){
        const tr=document.createElement('tr');
        const msg = i18n[state.language || 'ar'].noInventoryRecords || 'No inventory records.';
        tr.innerHTML='<td colspan="5">'+msg+'</td>';
        tb.appendChild(tr);
        return;
      }
      list.forEach(inv=>{
        const diff = inv.closing - inv.opening;
        const tr=document.createElement('tr');
        tr.innerHTML='<td>'+inv.branch+'</td><td>'+inv.month+'</td><td>'+inv.opening.toFixed(2)+'</td><td>'+inv.closing.toFixed(2)+'</td><td>'+diff.toFixed(2)+'</td>';
        tb.appendChild(tr);
      });
    }

    function getSupplierDebtTotal(branch){
      if(!branch || branch==='HOME') return 0;
      let total=0;
      state.suppliers.forEach(s=>{
        const id = s.id;
        const opening = num(s.opening);
        const purchases = state.purchases.filter(p=>p.branch===branch && String(p.supplierId)===String(id));
        let netPurch=0;
        purchases.forEach(p=>{
          if(p.kind==='invoice') netPurch+=num(p.amount);
          else netPurch-=num(p.amount);
        });
        const payments = state.cashMoves
          .filter(c=>c.branch===branch && (c.type==='supplierPayment' || c.type==='SupplierPayment') && String(c.supplierId)===String(id))
          .reduce((a,c)=>a+num(c.amount),0);
        total += opening + netPurch - payments;
      });
      return total;
    }

    function renderDashboard(){
      if(!state.currentBranch || state.currentBranch==='HOME') return;
      const todayStr = today();
      const branch = state.currentBranch;
      const lang = state.language || 'ar';

      const todaySales = state.sales
        .filter(s=>s.branch===branch && s.date===todayStr)
        .reduce((a,s)=>a+num(s.amount),0);
      const todayPurchases = state.purchases
        .filter(p=>p.branch===branch && p.date===todayStr && p.kind==='invoice')
        .reduce((a,p)=>a+num(p.amount),0);
      const todayReturns = state.purchases
        .filter(p=>p.branch===branch && p.date===todayStr && p.kind==='return')
        .reduce((a,p)=>a+num(p.amount),0);
      const todayNetPurchases = todayPurchases - todayReturns;
      const todayExpenses = state.cashMoves
        .filter(c=>c.branch===branch && c.date===todayStr && (c.type==='operatingExpense' || c.type==='Expense'))
        .reduce((a,c)=>a+num(c.amount),0);
      const todayProfit = todaySales - todayNetPurchases;
      const todayExpensesTotal = todayExpenses;

      const monthStart = new Date();
      monthStart.setDate(1);
      const monthStr = monthStart.toISOString().slice(0,10);
      const monthSales = state.sales
        .filter(s=>s.branch===branch && s.date>=monthStr && s.date<=todayStr)
        .reduce((a,s)=>a+num(s.amount),0);
      const monthPurchases = state.purchases
        .filter(p=>p.branch===branch && p.date>=monthStr && p.date<=todayStr && p.kind==='invoice')
        .reduce((a,p)=>a+num(p.amount),0);
      const monthReturns = state.purchases
        .filter(p=>p.branch===branch && p.date>=monthStr && p.date<=todayStr && p.kind==='return')
        .reduce((a,p)=>a+num(p.amount),0);
      const monthNetPurchases = monthPurchases - monthReturns;
      const monthExpenses = state.cashMoves
        .filter(c=>c.branch===branch && c.date>=monthStr && c.date<=todayStr && (c.type==='operatingExpense' || c.type==='Expense'))
        .reduce((a,c)=>a+num(c.amount),0);
      const monthProfitToDate = monthSales - monthNetPurchases - monthExpenses;

      const cashInToday = state.sales
        .filter(s=>s.branch===branch && s.date===todayStr)
        .reduce((a,s)=>a+num(s.amount),0) +
        state.purchases
        .filter(p=>p.branch===branch && p.date===todayStr && p.kind==='return' && p.paytype==='cash')
        .reduce((a,p)=>a+num(p.amount),0);

      const cashOutToday = state.purchases
        .filter(p=>p.branch===branch && p.date===todayStr && p.kind==='invoice' && p.paytype==='cash')
        .reduce((a,p)=>a+num(p.amount),0) +
        state.cashMoves
        .filter(c=>c.branch===branch && c.date===todayStr && (c.type==='operatingExpense' || c.type==='Expense' || c.type==='supplierPayment' || c.type==='SupplierPayment' || c.type==='transferToHome' || c.type==='TransferToHome'))
        .reduce((a,c)=>a+num(c.amount),0);

      const supplierDebt = getSupplierDebtTotal(branch);
      const salesCountToday = state.sales.filter(s=>s.branch===branch && s.date===todayStr).length;
      const purchasesCountToday = state.purchases.filter(p=>p.branch===branch && p.date===todayStr && p.kind==='invoice').length;

      const setDashValue = (id,val)=>{const el=document.getElementById(id);if(el) el.textContent=val;};
      setDashValue('dash-today-sales', todaySales.toFixed(2));
      setDashValue('dash-today-purchases', todayNetPurchases.toFixed(2));
      setDashValue('dash-today-profit', todayProfit.toFixed(2));
      setDashValue('dash-today-expenses', todayExpensesTotal.toFixed(2));
      setDashValue('dash-month-profit', monthProfitToDate.toFixed(2));
      if(todaySales===0){
        setDashValue('dash-gross-margin','â€”');
      }else{
        const grossMargin = (todayProfit / todaySales) * 100;
        setDashValue('dash-gross-margin', grossMargin.toFixed(1) + '%');
      }

      const last7Days = [];
      for(let i=6;i>=0;i--){
        const d = new Date();
        d.setDate(d.getDate()-i);
        last7Days.push(d.toISOString().slice(0,10));
      }

      const salesData = last7Days.map(d=>
        state.sales.filter(s=>s.branch===branch && s.date===d).reduce((a,s)=>a+num(s.amount),0)
      );
      const purchasesData = last7Days.map(d=>
        state.purchases.filter(p=>p.branch===branch && p.date===d && p.kind==='invoice').reduce((a,p)=>a+num(p.amount),0) -
        state.purchases.filter(p=>p.branch===branch && p.date===d && p.kind==='return').reduce((a,p)=>a+num(p.amount),0)
      );

      const maxSales = Math.max(...salesData,1);
      const maxPurchases = Math.max(...purchasesData,Math.abs(Math.min(...purchasesData)),1);

      const salesCanvas = document.getElementById('chart-sales');
      if(salesCanvas){
        const ctx = salesCanvas.getContext('2d');
        const w = salesCanvas.width = salesCanvas.offsetWidth;
        const h = salesCanvas.height = 120;
        ctx.clearRect(0,0,w,h);
        ctx.strokeStyle = '#0ea5e9';
        ctx.fillStyle = 'rgba(14,165,233,0.1)';
        ctx.lineWidth = 2;
        ctx.beginPath();
        const step = w/(salesData.length-1);
        salesData.forEach((val,i)=>{
          const x = i*step;
          const y = h - (val/maxSales)*h;
          if(i===0) ctx.moveTo(x,y);
          else ctx.lineTo(x,y);
        });
        ctx.lineTo(w,h);
        ctx.lineTo(0,h);
        ctx.closePath();
        ctx.fill();
        ctx.stroke();
      }

      const purchasesCanvas = document.getElementById('chart-purchases');
      if(purchasesCanvas){
        const ctx = purchasesCanvas.getContext('2d');
        const w = purchasesCanvas.width = purchasesCanvas.offsetWidth;
        const h = purchasesCanvas.height = 120;
        ctx.clearRect(0,0,w,h);
        const barWidth = w/purchasesData.length*0.7;
        const barStep = w/purchasesData.length;
        purchasesData.forEach((val,i)=>{
          const x = i*barStep + (barStep-barWidth)/2;
          const barHeight = (Math.abs(val)/maxPurchases)*h;
          const y = val>=0 ? h-barHeight : h;
          ctx.fillStyle = val>=0 ? '#22c55e' : '#ef4444';
          ctx.fillRect(x,y,barWidth,barHeight);
        });
      }
    }

    // ========= I18N =========
    const i18n = {
      ar: {
        appTitle: 'Ù†Ø¸Ø§Ù… Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª Ø§Ù„Ù…Ø§Ù„ÙŠ',
        branch: 'Ø§Ù„ÙØ±Ø¹:',
        change: 'ØªØºÙŠÙŠØ±',
        langToggle: 'EN',
        none: 'Ù„Ø§ ÙŠÙˆØ¬Ø¯',
        homeHouse: 'Ø§Ù„Ù…Ù†Ø²Ù„ / Ø§Ù„Ø¨ÙŠØª',
        systemName: 'ØµÙŠØ¯Ù„ÙŠØ§Øª Ø¯. Ù…Ø¬Ø¯ÙŠ Ø­Ù…Ø¯Ø§Ù†',
        systemSubtitle: 'Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø§Ù„ÙŠØ©',
        currentBranchLabel: 'Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø­Ø§Ù„ÙŠ:',
        navDashboard: 'Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…',
        navSales: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
        navPurchases: 'Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª',
        navSuppliers: 'Ø§Ù„Ù…ÙˆØ±Ø¯ÙˆÙ†',
        navTreasury: 'Ø§Ù„Ø®Ø²ÙŠÙ†Ø©',
        navInventory: 'Ø§Ù„Ù…Ø®Ø²ÙˆÙ†',
        navReports: 'Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±',
        navHome: 'Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ù†Ø²Ù„',
        navSettings: 'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª',
        branchSelectTitle: 'Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹',
        branchSelectSubtitle: 'Ø§Ø®ØªØ± ÙØ±Ø¹ ØµÙŠØ¯Ù„ÙŠØ© Ø£Ùˆ Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ù†Ø²Ù„',
        tools: 'Ø§Ù„Ø£Ø¯ÙˆØ§Øª',
        navigation: 'Ø§Ù„ØªÙ†Ù‚Ù„',
        branches: 'Ø§Ù„ÙØ±ÙˆØ¹',
        chooseBranch: 'Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹',
        sales: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
        todaySales: 'Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…',
        salesReport: 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
        purchases: 'Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª',
        purchaseInvoice: 'ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡',
        purchaseReturn: 'Ø¥Ø±Ø¬Ø§Ø¹ Ø´Ø±Ø§Ø¡',
        purchaseReport: 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª',
        suppliers: 'Ø§Ù„Ù…ÙˆØ±Ø¯ÙˆÙ†',
        addManageSupplier: 'Ø¥Ø¶Ø§ÙØ© / Ø¥Ø¯Ø§Ø±Ø© Ù…ÙˆØ±Ø¯',
        supplierStatement: 'ÙƒØ´Ù Ø­Ø³Ø§Ø¨ Ù…ÙˆØ±Ø¯',
        suppliersMonthlySummary: 'Ù…Ù„Ø®Øµ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† Ø§Ù„Ø´Ù‡Ø±ÙŠ',
        cashAnalysis: 'Ø§Ù„Ù†Ù‚Ø¯ ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„',
        cashOut: 'ØµØ±Ù Ù†Ù‚Ø¯ÙŠ',
        expensesReport: 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª',
        profitAnalysis: 'ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø±Ø¨Ø­',
        houseWallet: 'Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ù†Ø²Ù„',
        beneficiaries: 'Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙˆÙ†',
        houseExpenses: 'Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…Ù†Ø²Ù„',
        homeDashboard: 'Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ù†Ø²Ù„',
        homeDashboardDesc: 'Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø´Ù‡Ø±ÙŠØ© Ø¹Ù„Ù‰ Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙˆØ§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ†.',
        selectMonth: 'Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±',
        monthlySummary: 'Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø´Ù‡Ø±ÙŠ',
        transfersFromBranches: 'Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª Ù…Ù† Ø§Ù„ÙØ±ÙˆØ¹',
        beneficiariesSummary: 'Ù…Ù„Ø®Øµ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ†',
        monthlySpent: 'Ø§Ù„Ù…ØµØ±ÙˆÙ Ø´Ù‡Ø±ÙŠØ§Ù‹',
        ytdSpent: 'Ø§Ù„Ù…ØµØ±ÙˆÙ Ù…Ù†Ø° Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø³Ù†Ø©',
        monthlyAllowance: 'Ø§Ù„Ø¨Ø¯Ù„ Ø§Ù„Ø´Ù‡Ø±ÙŠ',
        trendAnalysis: 'ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø§ØªØ¬Ø§Ù‡ (Ø¢Ø®Ø± 6 Ø£Ø´Ù‡Ø±)',
        transfersIn: 'Ø§Ù„ØªØ­ÙˆÙŠÙ„Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø©',
        netBalance: 'Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„ØµØ§ÙÙŠ',
        total: 'Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ',
        branchDashboard: 'Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„ÙØ±Ø¹',
        dashboardOverview: 'Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø£Ø¯Ø§Ø¡ Ø§Ù„ÙŠÙˆÙ… ÙˆØ§Ù„Ù…Ø¤Ø´Ø±Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.',
        todayPurchases: 'Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…',
        todayNetProfit: 'ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ÙŠÙˆÙ…',
        cashInToday: 'Ø§Ù„Ù†Ù‚Ø¯ Ø§Ù„Ø¯Ø§Ø®Ù„ Ø§Ù„ÙŠÙˆÙ…',
        cashOutToday: 'Ø§Ù„Ù†Ù‚Ø¯ Ø§Ù„Ø®Ø§Ø±Ø¬ Ø§Ù„ÙŠÙˆÙ…',
        supplierDebtTotal: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø¯ÙŠÙˆÙ† Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†',
        salesInvoicesToday: 'ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…',
        purchaseInvoicesToday: 'ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„ÙŠÙˆÙ…',
        salesLast7Days: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª - Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…',
        purchasesLast7Days: 'Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª - Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…',
        inventory: 'Ø§Ù„Ù…Ø®Ø²ÙˆÙ†',
        openingClosingStock: 'ÙØªØ­ / Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†',
        inventoryPerBranchMonth: 'ØªØªØ¨Ø¹ ÙØªØ­ ÙˆØ¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù„ÙƒÙ„ ÙØ±Ø¹ ÙˆØ´Ù‡Ø±.',
        addUpdateInventory: 'Ø¥Ø¶Ø§ÙØ© / ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ†',
        openingStock: 'Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ',
        closingStock: 'Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø®ØªØ§Ù…ÙŠ',
        inventoryList: 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†',
        branchCol: 'Ø§Ù„ÙØ±Ø¹',
        monthCol: 'Ø§Ù„Ø´Ù‡Ø±',
        openingCol: 'Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ',
        closingCol: 'Ø§Ù„Ø®ØªØ§Ù…ÙŠ',
        difference: 'Ø§Ù„ÙØ±Ù‚',
        inventoryNotAllowedHome: 'Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†Ø²Ù„',
        monthRequired: 'Ø§Ù„Ø´Ù‡Ø± Ù…Ø·Ù„ÙˆØ¨',
        inventorySaved: 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†',
        chooseBranchFirst: 'Ø§Ø®ØªØ± ÙØ±Ø¹Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹',
        noInventoryRecords: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…Ø®Ø²ÙˆÙ†',
        stockDifference: 'ÙØ±Ù‚ Ø§Ù„Ù…Ø®Ø²ÙˆÙ†',
        adjustedProfit: 'Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ù…Ø¹Ø¯Ù„',
        branchTreasury: 'Ø®Ø²ÙŠÙ†Ø© Ø§Ù„ÙØ±Ø¹:',
        homeWallet: 'Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ù†Ø²Ù„:',
        signIn: 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„',
        secureAccess: 'ÙˆØµÙˆÙ„ Ø¢Ù…Ù† Ø¥Ù„Ù‰ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ù„Ù„ØµÙŠØ¯Ù„ÙŠØ©.',
        username: 'Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…',
        password: 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±',
        enterWorkspace: 'Ø¯Ø®ÙˆÙ„ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ø¹Ù…Ù„',
        firstTime: 'Ø£ÙˆÙ„ Ù…Ø±Ø©ØŸ Ø§Ø³ØªØ®Ø¯Ù… Ø£ÙŠ Ø§Ø³Ù… Ù…Ø³ØªØ®Ø¯Ù…ØŒ Ø³ÙŠØªÙ… Ø­ÙØ¸Ù‡ Ù…Ø­Ù„ÙŠØ§Ù‹ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² ÙÙ‚Ø·.',
        pharmaFinanceConsole: 'Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ©',
        branchesTreasurySuppliers: 'ÙØ±ÙˆØ¹ Â· Ø®Ø²ÙŠÙ†Ø© Â· Ù…ÙˆØ±Ø¯ÙˆÙ†',
        selectWorkingBranch: 'Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø¹Ø§Ù…Ù„. "Ø§Ù„Ù…Ù†Ø²Ù„" Ù„Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ù†Ø²Ù„ ÙˆØ§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ†.',
        mainPharmacyBranch: 'ÙØ±Ø¹ Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ',
        secondaryPharmacy: 'ØµÙŠØ¯Ù„ÙŠØ© Ø«Ø§Ù†ÙˆÙŠØ©',
        villagePharmacy: 'ØµÙŠØ¯Ù„ÙŠØ© Ø§Ù„Ù‚Ø±ÙŠØ©',
        houseWalletMonthlyBeneficiaries: 'Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ù†Ø²Ù„ ÙˆØ§Ù„Ù…Ø³ØªÙÙŠØ¯ÙˆÙ† Ø§Ù„Ø´Ù‡Ø±ÙŠÙˆÙ†',
        registerDailySales: 'Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ù„ÙƒÙ„ ÙØ±Ø¹. Ø§Ù„Ù†Ù‚Ø¯ Ø³ÙŠØ²ÙŠØ¯ Ø§Ù„Ø®Ø²ÙŠÙ†Ø©.',
        newSale: 'Ø¨ÙŠØ¹ Ø¬Ø¯ÙŠØ¯',
        date: 'Ø§Ù„ØªØ§Ø±ÙŠØ®',
        amount: 'Ø§Ù„Ù…Ø¨Ù„Øº',
        notes: 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª',
        addSale: 'Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ¹',
        detailedDailyMonthly: 'ØªÙØµÙŠÙ„ÙŠ / ÙŠÙˆÙ…ÙŠ / Ø´Ù‡Ø±ÙŠ Ù„Ù„Ù…Ø¨ÙŠØ¹Ø§Øª.',
        filter: 'ØªØµÙÙŠØ©',
        from: 'Ù…Ù†',
        to: 'Ø¥Ù„Ù‰',
        mode: 'Ø§Ù„ÙˆØ¶Ø¹',
        detail: 'ØªÙØµÙŠÙ„ÙŠ',
        dailySummary: 'Ù…Ù„Ø®Øµ ÙŠÙˆÙ…ÙŠ',
        monthlySummary: 'Ù…Ù„Ø®Øµ Ø´Ù‡Ø±ÙŠ',
        show: 'Ø¹Ø±Ø¶',
        periodDate: 'Ø§Ù„ÙØªØ±Ø© / Ø§Ù„ØªØ§Ø±ÙŠØ®',
        total: 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹',
        recordSupplierPurchase: 'Ø³Ø¬Ù„ ÙÙˆØ§ØªÙŠØ± Ø´Ø±Ø§Ø¡ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†. Ø§Ù„ÙÙˆØ§ØªÙŠØ± Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© Ø³ØªÙ‚Ù„Ù„ Ø§Ù„Ø®Ø²ÙŠÙ†Ø©.',
        newPurchaseInvoice: 'ÙØ§ØªÙˆØ±Ø© Ø´Ø±Ø§Ø¡ Ø¬Ø¯ÙŠØ¯Ø©',
        supplier: 'Ø§Ù„Ù…ÙˆØ±Ø¯',
        paymentType: 'Ù†ÙˆØ¹ Ø§Ù„Ø¯ÙØ¹',
        cash: 'Ù†Ù‚Ø¯ÙŠ',
        credit: 'Ø¢Ø¬Ù„',
        addInvoice: 'Ø¥Ø¶Ø§ÙØ© ÙØ§ØªÙˆØ±Ø©',
        returnLinkedSameDay: 'Ø¥Ø±Ø¬Ø§Ø¹ Ù…Ø±ØªØ¨Ø· Ø¨ÙÙˆØ§ØªÙŠØ± Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ… Ù„Ù†ÙØ³ Ø§Ù„Ù…ÙˆØ±Ø¯.',
        newReturn: 'Ø¥Ø±Ø¬Ø§Ø¹ Ø¬Ø¯ÙŠØ¯',
        originalInvoiceType: 'Ù†ÙˆØ¹ Ø§Ù„ÙØ§ØªÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©',
        addReturn: 'Ø¥Ø¶Ø§ÙØ© Ø¥Ø±Ø¬Ø§Ø¹',
        detailDailyMonthlyView: 'Ø¹Ø±Ø¶ ØªÙØµÙŠÙ„ÙŠ / ÙŠÙˆÙ…ÙŠ / Ø´Ù‡Ø±ÙŠ ÙŠØ´Ù…Ù„ Ø§Ù„ÙÙˆØ§ØªÙŠØ± ÙˆØ§Ù„Ø¥Ø±Ø¬Ø§Ø¹Ø§Øª ÙˆØ§Ù„ØµØ§ÙÙŠ.',
        dailyInvoicesReturnsNet: 'ÙŠÙˆÙ…ÙŠ (ÙÙˆØ§ØªÙŠØ± / Ø¥Ø±Ø¬Ø§Ø¹Ø§Øª / ØµØ§ÙÙŠ)',
        monthlyInvoicesReturnsNet: 'Ø´Ù‡Ø±ÙŠ (ÙÙˆØ§ØªÙŠØ± / Ø¥Ø±Ø¬Ø§Ø¹Ø§Øª / ØµØ§ÙÙŠ)',
        periodDateCol: 'Ø§Ù„ÙØªØ±Ø© / Ø§Ù„ØªØ§Ø±ÙŠØ®',
        supplierCol: 'Ø§Ù„Ù…ÙˆØ±Ø¯',
        invoicesTotal: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙÙˆØ§ØªÙŠØ±',
        returnsTotal: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹Ø§Øª',
        netAfterReturns: 'Ø§Ù„ØµØ§ÙÙŠ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹Ø§Øª',
        totalNetPurchases: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„ØµØ§ÙÙŠØ©',
        addSuppliersOpening: 'Ø£Ø¶Ù Ù…ÙˆØ±Ø¯ÙŠÙ† ÙˆØ£Ø±ØµØ¯Ø© Ø§ÙØªØªØ§Ø­ÙŠØ© (Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø°ÙŠ ØªØ¯ÙŠÙ† Ø¨Ù‡ Ù„Ù‡Ù… Ø¨Ø§Ù„ÙØ¹Ù„).',
        addEditSupplier: 'Ø¥Ø¶Ø§ÙØ© / ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ±Ø¯',
        name: 'Ø§Ù„Ø§Ø³Ù…',
        code: 'Ø§Ù„Ø±Ù…Ø²',
        openingBalance: 'Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ (ØªØ¯ÙŠÙ† Ù„Ù‡)',
        saveSupplier: 'Ø­ÙØ¸ Ù…ÙˆØ±Ø¯',
        suppliersList: 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ†',
        openingBalanceCol: 'Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠ',
        statementIncludingPurchases: 'ÙƒØ´Ù ÙŠØ´Ù…Ù„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„Ø¥Ø±Ø¬Ø§Ø¹Ø§Øª ÙˆØ§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª.',
        chooseSupplier: 'Ø§Ø®ØªØ± Ù…ÙˆØ±Ø¯Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹.',
        type: 'Ø§Ù„Ù†ÙˆØ¹',
        invoice: 'ÙØ§ØªÙˆØ±Ø©',
        return: 'Ø¥Ø±Ø¬Ø§Ø¹',
        supplierPayment: 'Ø¯ÙØ¹Ø© Ù…ÙˆØ±Ø¯',
        note: 'Ù…Ù„Ø§Ø­Ø¸Ø©',
        noMovements: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ø±ÙƒØ§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.',
        openingBalanceWithdrawals: 'Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§ÙØªØªØ§Ø­ÙŠØŒ Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª (ÙÙˆØ§ØªÙŠØ±)ØŒ Ø¥Ø±Ø¬Ø§Ø¹Ø§ØªØŒ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ø§Ù„Ø´Ù‡Ø± ÙˆØ§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù„ÙƒÙ„ Ù…ÙˆØ±Ø¯.',
        chooseMonth: 'Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±',
        showMonthlySummary: 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ø´Ù‡Ø±ÙŠ',
        withdrawalsInvoices: 'Ø§Ù„Ø³Ø­ÙˆØ¨Ø§Øª (ÙÙˆØ§ØªÙŠØ±)',
        paymentsInMonth: 'Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø§Øª ÙÙŠ Ø§Ù„Ø´Ù‡Ø±',
        remaining: 'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ',
        chooseMonthFirst: 'Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø± Ø£ÙˆÙ„Ø§Ù‹.',
        noDataForMonth: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±.',
        registerCashExpenses: 'Ø³Ø¬Ù„ Ù…ØµØ±ÙˆÙØ§Øª Ù†Ù‚Ø¯ÙŠØ©ØŒ Ù…Ø¯ÙÙˆØ¹Ø§Øª Ù…ÙˆØ±Ø¯ÙŠÙ†ØŒ ØªØ­ÙˆÙŠÙ„Ø§Øª ÙˆØ³Ø­ÙˆØ¨Ø§Øª Ø±Ø¨Ø­.',
        newCashMovement: 'Ø­Ø±ÙƒØ© Ù†Ù‚Ø¯ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©',
        supplierForPayment: 'Ø§Ù„Ù…ÙˆØ±Ø¯ (Ù„Ù„Ø¯ÙØ¹)',
        save: 'Ø­ÙØ¸',
        filterCashExpenses: 'ØªØµÙÙŠØ© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù†Ù‚Ø¯ÙŠØ© Ø¨ÙŠÙ† Ø§Ù„ØªÙˆØ§Ø±ÙŠØ®.',
        noExpenses: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª.',
        simpleGrossNet: 'Ø±Ø¨Ø­ Ø¥Ø¬Ù…Ø§Ù„ÙŠ / ØµØ§ÙÙŠ Ø¨Ø³ÙŠØ· Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„ØµØ§ÙÙŠØ© ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª.',
        period: 'Ø§Ù„ÙØªØ±Ø©',
        calculate: 'Ø­Ø³Ø§Ø¨',
        item: 'Ø§Ù„Ø¨Ù†Ø¯',
        value: 'Ø§Ù„Ù‚ÙŠÙ…Ø©',
        salesCol: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª',
        netPurchasesInvoicesReturns: 'Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª Ø§Ù„ØµØ§ÙÙŠØ© (ÙÙˆØ§ØªÙŠØ± - Ø¥Ø±Ø¬Ø§Ø¹Ø§Øª)',
        grossProfit: 'Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ',
        operatingExpenses: 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠØ©',
        netProfit: 'Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ØµØ§ÙÙŠ',
        netOperatingProfit: 'ØµØ§ÙÙŠ Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ØªØ´ØºÙŠÙ„ÙŠ',
        withdrawnProfit: 'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø­Ø¨ Ø§Ù„Ø£Ø±Ø¨Ø§Ø­',
        retainedProfit: 'Ø£Ø±Ø¨Ø§Ø­ Ù…ØªØ¨Ù‚ÙŠØ© ÙÙŠ Ø§Ù„ÙØ±Ø¹',
        houseWalletBeneficiaries: 'Ù…Ø³ØªÙÙŠØ¯Ùˆ Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ù†Ø²Ù„ ÙˆØ§Ù„ØªØ®ØµÙŠØµØ§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©.',
        addBeneficiary: 'Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙÙŠØ¯',
        monthlyAmount: 'Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø´Ù‡Ø±ÙŠ',
        beneficiariesList: 'Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ†',
        monthly: 'Ø´Ù‡Ø±ÙŠ',
        houseMonthlyExpenses: 'Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…Ù†Ø²Ù„ Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ø§Ù„Ù…Ø¯ÙÙˆØ¹Ø© Ù…Ù† Ù…Ø­ÙØ¸Ø© Ø§Ù„Ù…Ù†Ø²Ù„.',
        newHouseExpense: 'Ù…ØµØ±ÙˆÙ Ù…Ù†Ø²Ù„ÙŠ Ø¬Ø¯ÙŠØ¯',
        beneficiary: 'Ø§Ù„Ù…Ø³ØªÙÙŠØ¯',
        noSalesInPeriod: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.',
        dailyTotal: 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙŠÙˆÙ…ÙŠ',
        monthlyTotal: 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø´Ù‡Ø±ÙŠ',
        noPurchasesInPeriod: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙŠØ§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.',
        chooseBranchFirst: 'Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹ Ø£ÙˆÙ„Ø§Ù‹',
        salesNotAllowedHome: 'Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ØºÙŠØ± Ù…Ø³Ù…ÙˆØ­Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†Ø²Ù„',
        dateAmountRequired: 'Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù…Ø¨Ù„Øº Ù…Ø·Ù„ÙˆØ¨Ø§Ù†',
        saleAdded: 'ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨ÙŠØ¹',
        nameRequired: 'Ø§Ù„Ø§Ø³Ù… Ù…Ø·Ù„ÙˆØ¨',
        supplierSaved: 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ±Ø¯',
        dateSupplierAmountRequired: 'Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù…ÙˆØ±Ø¯ ÙˆØ§Ù„Ù…Ø¨Ù„Øº Ù…Ø·Ù„ÙˆØ¨Ø§Ù†',
        invoiceAdded: 'ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙØ§ØªÙˆØ±Ø©',
        returnAdded: 'ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹',
        useHomePages: 'Ø§Ø³ØªØ®Ø¯Ù… ØµÙØ­Ø§Øª Ø§Ù„Ù…Ù†Ø²Ù„ Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ù…Ù†Ø²Ù„',
        cashMovementSaved: 'ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ù†Ù‚Ø¯ÙŠØ©',
        nameAmountRequired: 'Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ù…Ø¨Ù„Øº Ù…Ø·Ù„ÙˆØ¨Ø§Ù†',
        dateBeneficiaryAmountRequired: 'Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ù…Ø³ØªÙÙŠØ¯ ÙˆØ§Ù„Ù…Ø¨Ù„Øº Ù…Ø·Ù„ÙˆØ¨Ø§Ù†',
        houseExpenseSaved: 'ØªÙ… Ø­ÙØ¸ Ù…ØµØ±ÙˆÙ Ø§Ù„Ù…Ù†Ø²Ù„',
        all: 'Ø§Ù„ÙƒÙ„',
        multiBranchPharmacyManagement: 'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ¯Ù„ÙŠØ§Øª Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„ÙØ±ÙˆØ¹',
        homeReport: 'ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ù†Ø²Ù„',
        globalSearch: 'Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø´Ø§Ù…Ù„',
        globalSearchDesc: 'Ø§Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„Ù…ØµØ±ÙˆÙØ§Øª ÙˆØ§Ù„Ù…Ù†Ø²Ù„ ÙˆØ§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ†.',
        searchPlaceholder: 'Ø¨Ø­Ø«...',
        backupRestore: 'Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆØ§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø©',
        backupRestoreDesc: 'ØªØµØ¯ÙŠØ± ÙˆØ§Ø³ØªÙŠØ±Ø§Ø¯ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚.',
        manualBackup: 'Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙŠØ¯ÙˆÙŠ',
        downloadBackupJson: 'ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ',
        backupFileDesc: 'Ù…Ù„Ù JSON ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ±ÙˆØ¹ ÙˆØ§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª ÙˆØ§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª ÙˆØ§Ù„Ù…ÙˆØ±Ø¯ÙŠÙ† ÙˆØ§Ù„Ø®Ø²ÙŠÙ†Ø© ÙˆØ§Ù„Ù…Ù†Ø²Ù„ ÙˆØºÙŠØ±Ù‡Ø§.',
        restoreFromBackup: 'Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù† Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ',
        restore: 'Ø§Ø³ØªØ¹Ø§Ø¯Ø©',
        restoreWarning: 'Ø³ÙŠØªÙ… Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©. Ø§Ø³ØªØ®Ø¯Ù… Ø¨Ø­Ø°Ø±.',
        autoBackupStatus: 'Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ',
        lastAutoBackupNone: 'Ø¢Ø®Ø± Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ: Ù„Ø§ ÙŠÙˆØ¬Ø¯',
        restoreLastAutoBackup: 'Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¢Ø®Ø± Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠ',
        alerts: 'Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª',
        month: 'Ø§Ù„Ø´Ù‡Ø±',
        expenses: 'Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª',
        netResult: 'Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„ØµØ§ÙÙŠØ©',
        print: 'Ø·Ø¨Ø§Ø¹Ø©',
        printPageLabel: 'Ø·Ø¨Ø§Ø¹Ø©',
        today: 'Ø§Ù„ÙŠÙˆÙ…',
        last7Days: 'Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…',
        thisMonth: 'Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±',
        thisYear: 'Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù†Ø©',
        custom: 'Ù…Ø®ØµØµ',
        showingFirst: 'Ø¹Ø±Ø¶ Ø£ÙˆÙ„',
        results: 'Ù†ØªØ§Ø¦Ø¬',
        noMatches: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬',
        returns: 'Ø§Ù„Ø¥Ø±Ø¬Ø§Ø¹Ø§Øª',
        note: 'Ù…Ù„Ø§Ø­Ø¸Ø©',
        expense: 'Ù…ØµØ±ÙˆÙ',
        profitWithdraw: 'Ø³Ø­Ø¨ Ø±Ø¨Ø­',
        transferToHome: 'ØªØ­ÙˆÙŠÙ„ Ù„Ù„Ù…Ù†Ø²Ù„',
        noSalesInPeriod: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¨ÙŠØ¹Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©',
        monthlyTotal: 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ø´Ù‡Ø±ÙŠ',
        supplierName: 'Ø§Ø³Ù… Ø§Ù„Ù…ÙˆØ±Ø¯',
        generate: 'Ø¥Ù†Ø´Ø§Ø¡',
        supplierOverview: 'Ù†Ø¸Ø±Ø© Ø¹Ø§Ù…Ø© Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙˆØ±Ø¯',
        chooseSupplier: 'Ø§Ø®ØªØ± Ù…ÙˆØ±Ø¯Ø§Ù‹'
      },
      en: {
        appTitle: 'Pharma Financial Suite',
        branch: 'Branch:',
        change: 'Change',
        langToggle: 'AR',
        none: 'None',
        homeHouse: 'HOME / House',
        systemName: 'Dr. Magdy Hamdan Pharmacies',
        systemSubtitle: 'Financial Management System',
        currentBranchLabel: 'Current branch:',
        navDashboard: 'Dashboard',
        navSales: 'Sales',
        navPurchases: 'Purchases',
        navSuppliers: 'Suppliers',
        navTreasury: 'Treasury',
        navInventory: 'Inventory',
        navReports: 'Reports',
        navHome: 'Home Wallet',
        navSettings: 'Settings',
        branchSelectTitle: 'Select Branch',
        branchSelectSubtitle: 'Choose a pharmacy branch or home wallet',
        tools: 'Tools',
        navigation: 'Navigation',
        branches: 'Branches',
        chooseBranch: 'Choose Branch',
        sales: 'Sales',
        todaySales: 'Today Sales',
        salesReport: 'Sales Report',
        purchases: 'Purchases',
        purchaseInvoice: 'Purchase Invoice',
        purchaseReturn: 'Purchase Return',
        purchaseReport: 'Purchase Report',
        suppliers: 'Suppliers',
        addManageSupplier: 'Add / Manage Supplier',
        supplierStatement: 'Supplier Statement',
        suppliersMonthlySummary: 'Suppliers Monthly Summary',
        cashAnalysis: 'Cash & Analysis',
        cashOut: 'Cash Out',
        expensesReport: 'Expenses Report',
        profitAnalysis: 'Profit Analysis',
        houseWallet: 'House Wallet',
        beneficiaries: 'Beneficiaries',
        houseExpenses: 'House Expenses',
        homeDashboard: 'Home Dashboard',
        homeDashboardDesc: 'Monthly overview of transfers, expenses, and beneficiaries.',
        selectMonth: 'Select Month',
        monthlySummary: 'Monthly Summary',
        transfersFromBranches: 'Transfers from Branches',
        beneficiariesSummary: 'Beneficiaries Summary',
        monthlySpent: 'Monthly Spent',
        ytdSpent: 'YTD Spent',
        monthlyAllowance: 'Monthly Allowance',
        trendAnalysis: 'Trend Analysis (Last 6 Months)',
        transfersIn: 'Transfers In',
        netBalance: 'Net Balance',
        total: 'Total',
        branchDashboard: 'Branch Dashboard',
        dashboardOverview: 'Overview of today\'s performance and key metrics.',
        todayPurchases: 'Today Purchases',
        todayNetProfit: 'Today Net Profit',
        cashInToday: 'Cash In Today',
        cashOutToday: 'Cash Out Today',
        supplierDebtTotal: 'Supplier Debt Total',
        salesInvoicesToday: 'Sales Invoices Today',
        purchaseInvoicesToday: 'Purchase Invoices Today',
        salesLast7Days: 'Sales - Last 7 Days',
        purchasesLast7Days: 'Purchases - Last 7 Days',
        inventory: 'Inventory',
        openingClosingStock: 'Opening / Closing Stock',
        inventoryPerBranchMonth: 'Track opening and closing stock per branch and month.',
        addUpdateInventory: 'Add / Update Inventory',
        openingStock: 'Opening Stock',
        closingStock: 'Closing Stock',
        inventoryList: 'Inventory List',
        branchCol: 'Branch',
        monthCol: 'Month',
        openingCol: 'Opening',
        closingCol: 'Closing',
        difference: 'Difference',
        inventoryNotAllowedHome: 'Inventory not allowed on HOME',
        monthRequired: 'Month required',
        inventorySaved: 'Inventory saved',
        chooseBranchFirst: 'Choose a branch first.',
        noInventoryRecords: 'No inventory records.',
        stockDifference: 'Stock Difference',
        adjustedProfit: 'Adjusted Profit',
        branchTreasury: 'Branch Treasury:',
        homeWallet: 'Home Wallet:',
        signIn: 'Sign in',
        secureAccess: 'Secure access to your pharmacy financial workspace.',
        username: 'Username',
        password: 'Password',
        enterWorkspace: 'Enter workspace',
        firstTime: 'First time? use any username, it will be stored locally on this device only.',
        pharmaFinanceConsole: 'Pharma Finance Console',
        branchesTreasurySuppliers: 'Branches Â· Treasury Â· Suppliers',
        selectWorkingBranch: 'Select the working branch. "HOME" is for house wallet & beneficiaries.',
        mainPharmacyBranch: 'Main pharmacy branch',
        secondaryPharmacy: 'Secondary pharmacy',
        villagePharmacy: 'Village pharmacy',
        houseWalletMonthlyBeneficiaries: 'House wallet & monthly beneficiaries',
        registerDailySales: 'Register daily sales per branch. Cash will increase treasury.',
        newSale: 'New Sale',
        date: 'Date',
        amount: 'Amount',
        notes: 'Notes',
        addSale: 'Add Sale',
        detailedDailyMonthly: 'Detailed / daily / monthly aggregation for sales.',
        filter: 'Filter',
        from: 'From',
        to: 'To',
        mode: 'Mode',
        detail: 'Detail',
        dailySummary: 'Daily summary',
        monthlySummary: 'Monthly summary',
        show: 'Show',
        periodDate: 'Period / Date',
        total: 'Total',
        recordSupplierPurchase: 'Record supplier purchase invoices. Cash invoices will reduce treasury.',
        newPurchaseInvoice: 'New Purchase Invoice',
        supplier: 'Supplier',
        paymentType: 'Payment Type',
        cash: 'Cash',
        credit: 'Credit',
        addInvoice: 'Add Invoice',
        returnLinkedSameDay: 'Return linked to same-day invoices for the same supplier.',
        newReturn: 'New Return',
        originalInvoiceType: 'Original Invoice Type',
        addReturn: 'Add Return',
        detailDailyMonthlyView: 'Detail / daily / monthly view including invoices, returns and net.',
        dailyInvoicesReturnsNet: 'Daily (Invoices / Returns / Net)',
        monthlyInvoicesReturnsNet: 'Monthly (Invoices / Returns / Net)',
        periodDateCol: 'Period / Date',
        supplierCol: 'Supplier',
        invoicesTotal: 'Invoices Total',
        returnsTotal: 'Returns Total',
        netAfterReturns: 'Net After Returns',
        totalNetPurchases: 'Total Net Purchases',
        addSuppliersOpening: 'Add suppliers and opening balances (amount you already owe them).',
        addEditSupplier: 'Add / Edit Supplier',
        name: 'Name',
        code: 'Code',
        openingBalance: 'Opening Balance (you owe him)',
        saveSupplier: 'Save Supplier',
        suppliersList: 'Suppliers List',
        openingBalanceCol: 'Opening Balance',
        statementIncludingPurchases: 'Statement including purchases, returns and payments.',
        chooseSupplier: 'Choose supplier first.',
        type: 'Type',
        invoice: 'Invoice',
        return: 'Return',
        supplierPayment: 'Supplier Payment',
        note: 'Note',
        noMovements: 'No movements in this period.',
        openingBalanceWithdrawals: 'Opening balance, withdrawals (invoices), returns, payments and remaining per supplier.',
        chooseMonth: 'Choose Month',
        showMonthlySummary: 'Show Monthly Summary',
        withdrawalsInvoices: 'Withdrawals (Invoices)',
        paymentsInMonth: 'Payments in Month',
        remaining: 'Remaining',
        chooseMonthFirst: 'Choose month.',
        noDataForMonth: 'No data for this month.',
        registerCashExpenses: 'Register cash expenses, supplier payments, transfers and profit withdrawals.',
        newCashMovement: 'New Cash Movement',
        supplierForPayment: 'Supplier (for payment)',
        save: 'Save',
        filterCashExpenses: 'Filter cash expenses between dates.',
        noExpenses: 'No expenses.',
        simpleGrossNet: 'Simple gross / net profit based on sales, net purchases and expenses.',
        period: 'Period',
        calculate: 'Calculate',
        item: 'Item',
        value: 'Value',
        salesCol: 'Sales',
        netPurchasesInvoicesReturns: 'Net Purchases (Invoices - Returns)',
        grossProfit: 'Gross Profit',
        operatingExpenses: 'Operating Expenses',
        netProfit: 'Net Profit',
        netOperatingProfit: 'Net Operating Profit',
        withdrawnProfit: 'Withdrawn Profit to Home',
        retainedProfit: 'Retained Profit in Branch',
        houseWalletBeneficiaries: 'House wallet beneficiaries and monthly allocations.',
        addBeneficiary: 'Add Beneficiary',
        monthlyAmount: 'Monthly Amount',
        beneficiariesList: 'Beneficiaries List',
        monthly: 'Monthly',
        houseMonthlyExpenses: 'House monthly expenses paid from home wallet.',
        newHouseExpense: 'New House Expense',
        beneficiary: 'Beneficiary',
        noSalesInPeriod: 'No sales in this period.',
        dailyTotal: 'Daily total',
        monthlyTotal: 'Monthly total',
        noPurchasesInPeriod: 'No purchases in this period.',
        chooseBranchFirst: 'Choose branch first',
        salesNotAllowedHome: 'Sales not allowed on HOME',
        dateAmountRequired: 'Date & amount required',
        saleAdded: 'Sale added',
        nameRequired: 'Name required',
        supplierSaved: 'Supplier saved',
        dateSupplierAmountRequired: 'Date, supplier & amount required',
        invoiceAdded: 'Invoice added',
        returnAdded: 'Return added',
        useHomePages: 'Use HOME pages for home expenses',
        cashMovementSaved: 'Cash movement saved',
        nameAmountRequired: 'Name & amount required',
        dateBeneficiaryAmountRequired: 'Date, beneficiary & amount required',
        houseExpenseSaved: 'House expense saved',
        all: 'All',
        multiBranchPharmacyManagement: 'Multi-Branch Pharmacy Management',
        homeReport: 'Home Report',
        globalSearch: 'Global Search',
        globalSearchDesc: 'Search across suppliers, sales, purchases, expenses, home, beneficiaries.',
        searchPlaceholder: 'Search...',
        backupRestore: 'Backup & Restore',
        backupRestoreDesc: 'Export and import all application data.',
        manualBackup: 'Manual Backup',
        downloadBackupJson: 'Download Backup JSON',
        backupFileDesc: 'A JSON file containing all branches, sales, purchases, suppliers, treasury, home, etc.',
        restoreFromBackup: 'Restore From Backup',
        restore: 'Restore',
        restoreWarning: 'Current data will be replaced. Use carefully.',
        autoBackupStatus: 'Auto Backup Status',
        lastAutoBackupNone: 'Last auto backup: none',
        restoreLastAutoBackup: 'Restore Last Auto Backup',
        alerts: 'Alerts',
        month: 'Month',
        expenses: 'Expenses',
        netResult: 'Net Result',
        print: 'Print',
        printPageLabel: 'Print',
        today: 'Today',
        last7Days: 'Last 7 Days',
        thisMonth: 'This Month',
        thisYear: 'This Year',
        custom: 'Custom',
        showingFirst: 'Showing first',
        results: 'results',
        noMatches: 'No matches',
        returns: 'Returns',
        note: 'Note',
        expense: 'Expense',
        profitWithdraw: 'Profit Withdraw',
        transferToHome: 'Transfer to Home',
        noSalesInPeriod: 'No sales in this period',
        monthlyTotal: 'Monthly total',
        supplierName: 'Supplier Name',
        generate: 'Generate',
        supplierOverview: 'Supplier Overview',
        chooseSupplier: 'Select Supplier'
      }
    };

    function applyLanguage(lang){
      if(!lang || (lang !== 'ar' && lang !== 'en')) lang = 'ar';
      state.language = lang;
      
      document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
      document.documentElement.lang = lang;
      if(lang === 'ar'){
        document.body.classList.add('rtl');
      }else{
        document.body.classList.remove('rtl');
      }
      
      document.querySelectorAll('[data-i18n]').forEach(el=>{
        const key = el.getAttribute('data-i18n');
        if(i18n[lang] && i18n[lang][key]){
          el.textContent = i18n[lang][key];
        }
      });
      
      document.querySelectorAll('[data-i18n-placeholder]').forEach(el=>{
        const key = el.getAttribute('data-i18n-placeholder');
        if(i18n[lang] && i18n[lang][key]){
          el.placeholder = i18n[lang][key];
        }
      });
      
      document.querySelectorAll('[data-i18n-title]').forEach(el=>{
        const key = el.getAttribute('data-i18n-title');
        if(i18n[lang] && i18n[lang][key]){
          el.title = i18n[lang][key];
        }
      });
      
      const langToggleBtn = document.getElementById('btn-lang-toggle');
      if(langToggleBtn){
        langToggleBtn.textContent = lang === 'ar' ? i18n.ar.langToggle : i18n.en.langToggle;
      }
      
      renderBranchSelectionButtons();
    }

    function applyTheme(name){
      const b = document.body;
      b.classList.remove('theme-teal');
      if(name==='teal') b.classList.add('theme-teal');
    }

    function getLogoUrl(){
      const s = state.settings || {};
      return s.logoUrl || 'logo.png';
    }

    function applySettingsVisuals(){
      const logo = getLogoUrl();
      const appLogo = document.getElementById('app-logo');
      const loginLogo = document.querySelector('.login-logo');
      if(appLogo) appLogo.src = logo;
      if(loginLogo) loginLogo.src = logo;
    }

    // ========= BACKUP & RESTORE =========
    function downloadBackup(){
      const backup = {
        branches: state.branches || [],
        sales: state.sales || [],
        purchases: state.purchases || [],
        suppliers: state.suppliers || [],
        cashMoves: state.cashMoves || [],
        beneficiaries: state.beneficiaries || [],
        homeExpenses: state.homeExpenses || [],
        inventory: state.inventory || [],
        treasury: state.treasury || {},
        currentBranch: state.currentBranch,
        language: state.language
      };
      const json = JSON.stringify(backup, null, 2);
      const blob = new Blob([json], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const now = new Date();
      const timestamp = now.getFullYear() + 
        String(now.getMonth()+1).padStart(2,'0') + 
        String(now.getDate()).padStart(2,'0') + '_' +
        String(now.getHours()).padStart(2,'0') + 
        String(now.getMinutes()).padStart(2,'0') + 
        String(now.getSeconds()).padStart(2,'0');
      a.href = url;
      a.download = 'pharma_backup_' + timestamp + '.json';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast('Backup downloaded');
    }
    function restoreBackup(){
      const input = document.getElementById('backup-file-input');
      if(!input || !input.files || !input.files[0]){
        showToast('Please select a backup file');
        return;
      }
      const file = input.files[0];
      const reader = new FileReader();
      reader.onload = function(e){
        try{
          const backup = JSON.parse(e.target.result);
          if(!backup.sales || !backup.purchases || !backup.suppliers || !backup.cashMoves || !backup.beneficiaries || !backup.homeExpenses){
            showToast('Invalid backup file format');
            return;
          }
          state.sales = backup.sales || [];
          state.purchases = backup.purchases || [];
          state.suppliers = backup.suppliers || [];
          state.cashMoves = backup.cashMoves || [];
          state.beneficiaries = backup.beneficiaries || [];
          state.homeExpenses = backup.homeExpenses || [];
          state.inventory = backup.inventory || [];
          state.treasury = backup.treasury || {};
          if(backup.currentBranch) state.currentBranch = backup.currentBranch;
          if(backup.language) state.language = backup.language;
          saveState();
          initAfterLogin();
          showToast('Backup restored successfully');
          input.value = '';
        }catch(err){
          console.error(err);
          showToast('Error reading backup file');
        }
      };
      reader.readAsText(file);
    }
    function restoreAutoBackup(){
      try{
        const raw = localStorage.getItem('pharma_auto_backup');
        if(!raw){
          showToast('No auto backup found');
          return;
        }
        const backup = JSON.parse(raw);
        if(!backup.state || !backup.state.sales || !backup.state.purchases || !backup.state.suppliers){
          showToast('Invalid auto backup format');
          return;
        }
        state = backup.state;
        saveState();
        initAfterLogin();
        showToast('Auto backup restored successfully');
        updateAutoBackupStatus();
      }catch(err){
        console.error(err);
        showToast('Error restoring auto backup');
      }
    }
    function updateAutoBackupStatus(){
      const statusEl = document.getElementById('auto-backup-status');
      if(!statusEl) return;
      const lang = state.language || 'ar';
      try{
        const raw = localStorage.getItem('pharma_auto_backup');
        if(raw){
          const backup = JSON.parse(raw);
          if(backup.savedAt){
            const date = new Date(backup.savedAt);
            statusEl.textContent = (i18n[lang].lastAutoBackup || 'Last auto backup: ').replace(': none', ': ') + date.toLocaleString();
          }else{
            statusEl.textContent = i18n[lang].lastAutoBackupNone || 'Last auto backup: none';
          }
        }else{
          statusEl.textContent = i18n[lang].lastAutoBackupNone || 'Last auto backup: none';
        }
      }catch(err){
        statusEl.textContent = i18n[lang].lastAutoBackupNone || 'Last auto backup: none';
      }
    }

    function initLanguage(){
      const lang = state.language || 'ar';
      applyLanguage(lang);
      
      document.getElementById('btn-lang-toggle').addEventListener('click',()=>{
        const newLang = state.language === 'ar' ? 'en' : 'ar';
        applyLanguage(newLang);
        saveState();
      });
      const btnLangAr = document.getElementById('btn-lang-ar');
      const btnLangEn = document.getElementById('btn-lang-en');
      if(btnLangAr && !btnLangAr.dataset.boundLang){
        btnLangAr.dataset.boundLang = 'true';
        btnLangAr.addEventListener('click',()=>{
          if(state.language !== 'ar'){
            applyLanguage('ar');
            saveState();
          }
        });
      }
      if(btnLangEn && !btnLangEn.dataset.boundLang){
        btnLangEn.dataset.boundLang = 'true';
        btnLangEn.addEventListener('click',()=>{
          if(state.language !== 'en'){
            applyLanguage('en');
            saveState();
          }
        });
      }
    }

    // ========= INIT =========
    if(state.currentUser){
      if(screenLogin){
        screenLogin.classList.remove('active');
        screenLogin.classList.remove('hidden');
      }
      if(screenApp){
        screenApp.classList.remove('hidden');
        screenApp.classList.add('active');
      }
      initAfterLogin();
    } else {
      if(screenLogin) screenLogin.classList.add('active');
      if(screenApp) screenApp.classList.remove('active');
      initLanguage();
    }

  </script>
</body>
</html>
